<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>W1NNR - Compete. Win. Earn.</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0e1a;
            color: #fff;
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 40px 0;
        }
        
        .logo {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }
        
        .tagline {
            color: #8b92a7;
            margin-top: 10px;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .card {
            background: rgba(26, 35, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #0a0e1a;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.4);
        }
        
        .btn-secondary {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .input {
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .label {
            display: block;
            color: #8b92a7;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 16px 0 8px 0;
        }
        
        .balance {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .balance:last-child {
            border-bottom: none;
        }
        
        .balance-label {
            color: #8b92a7;
            font-size: 14px;
        }
        
        .balance-value {
            font-weight: 700;
            font-size: 16px;
            color: #00ff88;
        }
        
        .match-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .match-item:hover {
            border-color: rgba(0, 212, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .match-player {
            font-size: 16px;
            font-weight: 700;
        }
        
        .match-fee {
            color: #00ff88;
            font-weight: 700;
            font-size: 18px;
        }
        
        .match-details {
            display: flex;
            gap: 16px;
            color: #8b92a7;
            font-size: 13px;
        }
        
        .hidden {
            display: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-open {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }
        
        .status-funded {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }
        
        .status-settled {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .status-inprogress {
            background: rgba(138, 43, 226, 0.2);
            color: #8a2be2;
        }
        
        .status-reported {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
        }
        
        .status-disputed {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .status-cancelled,
        .status-expired,
        .status-noshow {
            background: rgba(150, 150, 150, 0.2);
            color: #aaa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b92a7;
        }
        
        .error {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 14px;
        }
        
        .success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 14px;
        }
        
        .tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin: 20px 0;
        }
        
        .tab {
            padding: 12px 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tab.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.3);
            color: #00d4ff;
        }
        
        @media (max-width: 600px) {
            .tabs {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .tab {
                font-size: 12px;
                padding: 10px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">W1NNR</div>
            <div class="tagline">COMPETE ‚Ä¢ WIN ‚Ä¢ EARN</div>
        </div>

        <!-- Not Connected -->
        <div id="not-connected">
            <div class="card">
                <h2 style="margin-bottom: 16px;">üèÜ Compete for Real Stakes</h2>
                <p style="color: #8b92a7; margin-bottom: 16px; line-height: 1.6;">
                    W1NNR lets you compete against other players in golf, tennis, and more - with real money on the line.
                </p>
                
                <div style="background: rgba(0,212,255,0.1); border-left: 3px solid #00d4ff; padding: 16px; margin: 20px 0; border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">How it works:</div>
                    <div style="color: #8b92a7; font-size: 14px; line-height: 1.8;">
                        1Ô∏è‚É£ Create or join a match<br>
                        2Ô∏è‚É£ Both players deposit stakes<br>
                        3Ô∏è‚É£ Play your match<br>
                        4Ô∏è‚É£ Report the winner<br>
                        5Ô∏è‚É£ Winner takes 92% of the pot üí∞
                    </div>
                </div>
                
                <div style="background: rgba(255,165,0,0.1); border-left: 3px solid #ffa500; padding: 16px; margin: 20px 0; border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">‚ö†Ô∏è You'll need:</div>
                    <div style="color: #8b92a7; font-size: 14px; line-height: 1.8;">
                        ‚Ä¢ MetaMask wallet (or compatible)<br>
                        ‚Ä¢ PulseChain network added<br>
                        ‚Ä¢ Some W1T tokens for testing<br>
                        ‚Ä¢ A friend to compete against!
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="connectWallet()" style="margin-top: 20px;">
                    Connect Wallet to Start
                </button>
                
                <p style="color: #666; font-size: 12px; margin-top: 16px; text-align: center;">
                    Your wallet. Your stakes. Your glory.
                </p>
            </div>
        </div>

        <!-- Connected -->
        <div id="connected" class="hidden">
            <!-- First Time User Guidance -->
            <div id="first-time-banner" class="card" style="background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(0,255,136,0.2)); border: 2px solid rgba(0,212,255,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h3 style="margin-bottom: 12px;">üëã Welcome to W1NNR!</h3>
                        <p style="color: #8b92a7; font-size: 14px; line-height: 1.6; margin-bottom: 12px;">
                            <strong>Quick Start:</strong> Go to the "Create" tab to set up your first match, or browse "Matches" to join an existing one.
                        </p>
                        <p style="color: #8b92a7; font-size: 13px;">
                            üí° Tip: Set a username in your Profile so opponents know who they're playing!
                        </p>
                    </div>
                    <button onclick="dismissFirstTimeBanner()" style="background: none; border: none; color: #8b92a7; cursor: pointer; font-size: 20px; padding: 0 0 0 16px;">√ó</button>
                </div>
            </div>

            <!-- Wallet Info -->
            <div class="card">
                <div class="balance">
                    <span class="balance-label">Wallet</span>
                    <span class="balance-value" id="wallet-address">0x...</span>
                </div>
                <div class="balance">
                    <span class="balance-label">W1T Balance</span>
                    <span class="balance-value" id="w1t-balance">0.00 W1T</span>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('matches', this)">Matches</div>
                <div class="tab" onclick="showTab('create', this)">Create</div>
                <div class="tab" onclick="showTab('my-matches', this)">My Matches</div>
                <div class="tab" onclick="showTab('leaderboard', this)">Leaders</div>
                <div class="tab" onclick="showTab('profile', this)">Profile</div>
            </div>

            <!-- Open Matches Tab -->
            <div id="tab-matches">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Open Matches</h2>
                    <button class="btn btn-secondary" onclick="loadMatches()" style="margin-bottom: 16px;">
                        Refresh
                    </button>
                    <div id="matches-list">
                        <div class="loading">Loading matches...</div>
                    </div>
                </div>
            </div>

            <!-- Create Match Tab -->
            <div id="tab-create" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Create a Match</h2>
                    
                    <div style="background: rgba(0,212,255,0.1); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                        <div style="font-size: 14px; color: #8b92a7; line-height: 1.8;">
                            <strong style="color: #00d4ff;">üí° How this works:</strong><br>
                            ‚Ä¢ Leave opponent blank to create an <strong>open match</strong> anyone can join<br>
                            ‚Ä¢ Or enter a specific address for a <strong>private match</strong><br>
                            ‚Ä¢ Both players deposit ‚Üí Check-in at match time ‚Üí Play ‚Üí Report winner
                        </div>
                    </div>
                    
                    <label class="label">Opponent (optional - leave blank for open)</label>
                    <input type="text" class="input" id="create-opponent" placeholder="0x... or leave blank for open match">
                    
                    <label class="label">Entry Fee (W1T)</label>
                    <input type="number" class="input" id="create-fee" placeholder="50" value="50">
                    <p style="color: #8b92a7; font-size: 12px; margin-top: 4px;">
                        Minimum: 10 W1T ‚Ä¢ Winner gets 92% of total pot
                    </p>
                    
                    <label class="label">Scheduled Time</label>
                    <input type="datetime-local" class="input" id="create-time">
                    <p style="color: #8b92a7; font-size: 12px; margin-top: 4px;">
                        Must be at least 1 hour from now
                    </p>
                    
                    <div id="create-error" class="error hidden"></div>
                    <div id="create-success" class="success hidden"></div>
                    
                    <button class="btn btn-primary" onclick="createMatch()" style="margin-top: 20px;">
                        Create Match
                    </button>
                </div>
            </div>

            <!-- My Matches Tab -->
            <div id="tab-my-matches" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">My Matches</h2>
                    <button class="btn btn-secondary" onclick="loadMyMatches()" style="margin-bottom: 16px;">
                        Refresh
                    </button>
                    <div id="my-matches-list">
                        <div class="loading">Loading your matches...</div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="tab-leaderboard" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Leaderboard</h2>
                    <p style="color: #8b92a7; margin-bottom: 16px; font-size: 14px;">
                        Top competitors ranked by wins
                    </p>
                    <button class="btn btn-secondary" onclick="refreshStats()" style="margin-bottom: 16px;">
                        Refresh Stats
                    </button>
                    <div id="leaderboard-list">
                        <div class="loading">Loading leaderboard...</div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="tab-profile" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Your Profile</h2>
                    
                    <div style="background: rgba(0,212,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #8b92a7;">
                        üí° Set a username so opponents know who they're competing against!
                    </div>
                    
                    <div class="balance">
                        <span class="balance-label">Username</span>
                        <span class="balance-value" id="profile-username">@username</span>
                    </div>
                    
                    <div class="balance">
                        <span class="balance-label">Record</span>
                        <span class="balance-value" id="profile-record">0-0</span>
                    </div>
                    
                    <div class="balance">
                        <span class="balance-label">Win Rate</span>
                        <span class="balance-value" id="profile-winrate">0%</span>
                    </div>
                    
                    <div class="balance">
                        <span class="balance-label">Total Earnings</span>
                        <span class="balance-value" id="profile-earnings">0 W1T</span>
                    </div>
                    
                    <div class="balance">
                        <span class="balance-label">Wallet</span>
                        <span class="balance-value" id="profile-address">0x...</span>
                    </div>
                    
                    <button class="btn btn-primary" onclick="changeUsername()" style="margin-top: 20px;">
                        Change Username
                    </button>
                    
                    <div style="margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <p style="color: #8b92a7; font-size: 12px; line-height: 1.6;">
                            <strong>Stats Update:</strong> Your record and earnings are calculated from settled matches on the blockchain. They update automatically every 60 seconds.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Match Detail Modal -->
            <div id="match-detail" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Match Details</h2>
                    <div id="match-detail-content"></div>
                    <button class="btn btn-secondary" onclick="closeMatchDetail()" style="margin-top: 20px;">
                        Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======== CONFIG ========
        
        const CONFIG = {
            FACTORY_ADDRESS: '0xB2f2581F2dFF71956C1C8Bc595C51f20Ed44cAfC',
            W1T_ADDRESS: '0x49A0bdA692e774E359c5c2c17DdC29f5ce1DfbAC', // W1T Test Token (18 decimals)
            CHAIN_ID: 943, // PulseChain Testnet v4
            RPC_URL: 'https://rpc.pulsechain.com',
            FACTORY_DEPLOY_BLOCK: 22587000 // Update with actual deployment block
        };
        
        // ======== CONTRACT ABIs ========
        
        const FACTORY_ABI = [
            "function createMatch(address player2, uint256 entryFee, uint256 scheduledTime) external returns (address)",
            "function getOpenMatches(uint256 maxResults) external view returns (address[])",
            "function getUserMatches(address user) external view returns (address[])",
            "function isMatch(address) external view returns (bool)",
            "event MatchCreated(address indexed escrow, address indexed player1, address indexed player2, uint256 entryFee, uint256 scheduledTime, bool isOpen)"
        ];
        
        const ESCROW_ABI = [
            "function player1() external view returns (address)",
            "function player2() external view returns (address)",
            "function entryFee() external view returns (uint256)",
            "function scheduledTime() external view returns (uint256)",
            "function status() external view returns (uint8)",
            "function joinMatch() external",
            "function deposit() external",
            "function checkIn() external",
            "function reportOutcome(address winner) external",
            "function isOpenMatch() external view returns (bool)",
            "event Settled(address indexed winner, address indexed loser, uint256 prize)",
            "event MatchJoined(address indexed player2)",
            "event Deposited(address indexed player)",
            "event Funded(uint256 netPot, uint256 platformFee)",
            "event CheckedIn(address indexed player)",
            "event OutcomeReported(address indexed reporter, address winner)",
            "event Disputed(uint256 disputeStartTime)",
            "event NoShowProcessed(address indexed showed, address indexed noShow)",
            "event DisputeRefunded(uint256 amountEach)",
            "event Cancelled(uint256 refundEach)",
            "event Expired()"
        ];
        
        const ERC20_ABI = [
            "function balanceOf(address) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)"
        ];
        
        // ======== STATUS MAP ========
        
        const STATUS_MAP = {
            0: 'Open',
            1: 'Funded',
            2: 'InProgress',
            3: 'Reported',
            4: 'Disputed',
            5: 'Settled',
            6: 'Cancelled',
            7: 'Expired',
            8: 'NoShow'
        };
        
        // ======== STATE ========
        
        let provider, signer, userAddress;
        let factoryContract, w1tContract;
        let username = null; // Will be loaded per wallet
        
        // ======== USERNAME SYSTEM ========
        
        function loadUsername() {
            if (!userAddress) return;
            username = localStorage.getItem("w1nnr_username_" + userAddress.toLowerCase());
        }
        
        function promptUsername() {
            if (!username) {
                const input = prompt("Choose your W1NNR username (3-16 characters):");
                if (input && input.length >= 3 && input.length <= 16) {
                    username = input.trim();
                    // Save wallet-bound username
                    localStorage.setItem("w1nnr_username_" + userAddress.toLowerCase(), username);
                    // Cache for other users to see
                    localStorage.setItem("w1nnr_user_" + userAddress.toLowerCase(), username);
                    document.getElementById('wallet-address').textContent = '@' + username;
                } else if (input) {
                    alert('Username must be 3-16 characters');
                    promptUsername();
                }
            }
        }
        
        function getDisplayName(address) {
            if (!address || address === ethers.ZeroAddress) return 'Open';
            if (address.toLowerCase() === userAddress?.toLowerCase()) {
                return '@' + (username || 'You');
            }
            // Check if we have this user's name cached
            const cached = localStorage.getItem("w1nnr_user_" + address.toLowerCase());
            if (cached) return '@' + cached;
            return address.slice(0, 6) + '...' + address.slice(-4);
        }
        
        function changeUsername() {
            username = null;
            localStorage.removeItem("w1nnr_username_" + userAddress.toLowerCase());
            promptUsername();
        }
        
        // ======== EVENT-BASED GLOBAL STATS SYSTEM ========
        
        let globalStatsCache = null;
        let statsLastLoaded = 0;
        const STATS_CACHE_TTL = 60000; // 60 seconds
        
        /**
         * Get all match addresses from Factory MatchCreated events
         */
        async function getAllMatches() {
            try {
                const filter = factoryContract.filters.MatchCreated();
                const events = await factoryContract.queryFilter(
                    filter,
                    CONFIG.FACTORY_DEPLOY_BLOCK, // ‚úÖ Start from deployment, not 0
                    "latest"
                );
                return events.map(e => e.args.escrow);
            } catch (error) {
                console.error("Error fetching matches:", error);
                return [];
            }
        }
        
        /**
         * Build global stats from all Settled events across all matches
         * Uses global log indexing - queries ALL Settled events in one RPC call
         * O(1) complexity - scales to thousands of matches
         * 
         * OPTIMIZED: Uses loser from Settled event - ZERO contract calls needed!
         * FILTERED: Only queries W1NNR match addresses (not entire chain)
         * CHUNKED: Handles RPC limits for large match counts
         */
        async function buildGlobalStats() {
            console.log('Building stats from blockchain events...');
            const stats = {};
            
            // Guard: Ensure provider exists (user connected)
            if (!provider) {
                console.warn('Provider not available - wallet not connected');
                return stats;
            }
            
            try {
                // First, get all match addresses from Factory
                const matchAddresses = await getAllMatches();
                
                if (matchAddresses.length === 0) {
                    console.log('No matches created yet');
                    return stats;
                }
                
                console.log(`Querying Settled events from ${matchAddresses.length} matches...`);
                
                // Get the Settled event topic hash
                // NEW: Settled(address indexed winner, address indexed loser, uint256 prize)
                const settledTopic = ethers.id("Settled(address,address,uint256)");
                
                // Chunk addresses to handle RPC limits (50 at a time)
                const CHUNK_SIZE = 50;
                const allLogs = [];
                
                for (let i = 0; i < matchAddresses.length; i += CHUNK_SIZE) {
                    const chunk = matchAddresses.slice(i, i + CHUNK_SIZE);
                    
                    const logs = await provider.getLogs({
                        fromBlock: CONFIG.FACTORY_DEPLOY_BLOCK,
                        toBlock: "latest",
                        address: chunk, // ‚úÖ Chunked for RPC limits
                        topics: [settledTopic]
                    });
                    
                    allLogs.push(...logs);
                }
                
                console.log(`Found ${allLogs.length} settled matches`);
                
                // Decode events - NO CONTRACT CALLS NEEDED!
                const iface = new ethers.Interface(ESCROW_ABI);
                
                for (const log of allLogs) {
                    try {
                        const parsed = iface.parseLog(log);
                        
                        // Extract all data from event - loser is now included!
                        const winner = parsed.args.winner.toLowerCase();
                        const loser = parsed.args.loser.toLowerCase();
                        const prize = parseFloat(ethers.formatUnits(parsed.args.prize, 18));
                        
                        // Update winner stats
                        if (!stats[winner]) {
                            stats[winner] = { wins: 0, losses: 0, earnings: 0 };
                        }
                        stats[winner].wins++;
                        stats[winner].earnings += prize;
                        
                        // Update loser stats
                        if (!stats[loser]) {
                            stats[loser] = { wins: 0, losses: 0, earnings: 0 };
                        }
                        stats[loser].losses++;
                        
                    } catch (error) {
                        console.log(`Error parsing log:`, error);
                    }
                }
                
                console.log(`Stats built for ${Object.keys(stats).length} players`);
                return stats;
                
            } catch (error) {
                console.error('Error building global stats:', error);
                return {};
            }
        }
        
        /**
         * Get global stats with caching
         */
        async function getGlobalStats(forceRefresh = false) {
            const now = Date.now();
            
            // Return cached stats if still valid
            if (!forceRefresh && globalStatsCache && (now - statsLastLoaded < STATS_CACHE_TTL)) {
                return globalStatsCache;
            }
            
            // Rebuild stats from chain
            globalStatsCache = await buildGlobalStats();
            statsLastLoaded = now;
            return globalStatsCache;
        }
        
        /**
         * Get stats for a specific address
         */
        async function getPlayerStats(address) {
            const stats = await getGlobalStats();
            const addr = address.toLowerCase();
            return stats[addr] || { wins: 0, losses: 0, earnings: 0 };
        }
        
        /**
         * Calculate win rate
         */
        function calculateWinRate(stats) {
            const total = stats.wins + stats.losses;
            if (total === 0) return '0';
            return ((stats.wins / total) * 100).toFixed(1);
        }
        
        /**
         * Build leaderboard from global chain stats
         */
        async function buildLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<div class="loading">Building leaderboard from blockchain...</div>';
            
            try {
                const stats = await getGlobalStats();
                
                // Convert to array and sort by wins
                const players = Object.entries(stats).map(([address, record]) => ({
                    address,
                    ...record,
                    name: getDisplayName(address),
                    winRate: calculateWinRate(record)
                })).sort((a, b) => b.wins - a.wins);
                
                list.innerHTML = '';
                
                if (players.length === 0) {
                    list.innerHTML = '<p style="color: #8b92a7; text-align: center;">No matches settled yet. Play a match to appear on the leaderboard!</p>';
                    return;
                }
                
                // Display top 10
                players.slice(0, 10).forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'balance';
                    item.style.padding = '16px 0';
                    item.style.borderBottom = '1px solid rgba(255,255,255,0.06)';
                    
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                    const medalColor = index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#666';
                    
                    item.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px; font-weight: 900; color: ${medalColor}; width: 40px;">
                                ${medal}
                            </span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 16px;">${player.name}</div>
                                <div style="color: #8b92a7; font-size: 13px;">
                                    ${player.wins}-${player.losses} ‚Ä¢ ${player.winRate}% WR ‚Ä¢ ${player.earnings.toFixed(2)} W1T
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(item);
                });
                
                // Add refresh hint
                const hint = document.createElement('p');
                hint.style.color = '#8b92a7';
                hint.style.fontSize = '12px';
                hint.style.textAlign = 'center';
                hint.style.marginTop = '16px';
                hint.textContent = 'Stats update automatically every 60 seconds';
                list.appendChild(hint);
                
            } catch (error) {
                console.error('Error building leaderboard:', error);
                list.innerHTML = '<div class="error">Failed to load leaderboard. Please try again.</div>';
            }
        }
        
        // ======== ONBOARDING ========
        
        function dismissFirstTimeBanner() {
            document.getElementById('first-time-banner').style.display = 'none';
            localStorage.setItem('w1nnr_onboarding_dismissed', 'true');
        }
        
        function checkFirstTimeUser() {
            const dismissed = localStorage.getItem('w1nnr_onboarding_dismissed');
            if (dismissed) {
                document.getElementById('first-time-banner').style.display = 'none';
            }
        }
        
        // ======== WALLET CONNECTION ========
        
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask!');
                    return;
                }
                
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // Request accounts
                await provider.send("eth_requestAccounts", []);
                
                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(CONFIG.CHAIN_ID)) {
                    alert('Please switch to PulseChain');
                    return;
                }
                
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Initialize contracts
                factoryContract = new ethers.Contract(CONFIG.FACTORY_ADDRESS, FACTORY_ABI, signer);
                w1tContract = new ethers.Contract(CONFIG.W1T_ADDRESS, ERC20_ABI, signer);
                
                // Update UI
                document.getElementById('not-connected').classList.add('hidden');
                document.getElementById('connected').classList.remove('hidden');
                
                // Load data
                await loadBalance();
                loadUsername(); // Load wallet-bound username
                promptUsername(); // Ask for username if not set
                checkFirstTimeUser(); // Check if should show onboarding
                
                // Update display
                document.getElementById('wallet-address').textContent = 
                    username ? '@' + username : userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                await loadMatches();
                
                // Set default time to 2 hours from now
                const now = new Date();
                now.setHours(now.getHours() + 2);
                document.getElementById('create-time').value = 
                    now.toISOString().slice(0, 16);
                
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect wallet');
            }
        }
        
        // ======== LOAD DATA ========
        
        async function loadBalance() {
            try {
                const balance = await w1tContract.balanceOf(userAddress);
                const formatted = ethers.formatUnits(balance, 18); // W1T has 18 decimals
                document.getElementById('w1t-balance').textContent = 
                    parseFloat(formatted).toFixed(2) + ' W1T';
            } catch (error) {
                console.error('Balance error:', error);
            }
        }
        
        async function loadMatches() {
            const list = document.getElementById('matches-list');
            list.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const matchAddresses = await factoryContract.getOpenMatches(20);
                
                if (matchAddresses.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üéØ</div>
                            <h3 style="margin-bottom: 12px;">No Open Matches Yet</h3>
                            <p style="color: #8b92a7; margin-bottom: 24px; line-height: 1.6;">
                                Be the first to create a match!<br>
                                Other players can join and compete with you.
                            </p>
                            <button class="btn btn-primary" onclick="showTab('create', document.querySelectorAll('.tab')[1])">
                                Create Your First Match
                            </button>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = '';
                
                for (const addr of matchAddresses) {
                    const escrow = new ethers.Contract(addr, ESCROW_ABI, provider);
                    
                    const [player1, entryFee, scheduledTime] = await Promise.all([
                        escrow.player1(),
                        escrow.entryFee(),
                        escrow.scheduledTime()
                    ]);
                    
                    const fee = ethers.formatUnits(entryFee, 18); // W1T has 18 decimals
                    const time = new Date(Number(scheduledTime) * 1000);
                    
                    const item = document.createElement('div');
                    item.className = 'match-item';
                    item.onclick = () => viewMatch(addr);
                    item.innerHTML = `
                        <div class="match-header">
                            <div class="match-player">${getDisplayName(player1)}</div>
                            <div class="match-fee">${parseFloat(fee).toFixed(2)} W1T</div>
                        </div>
                        <div class="match-details">
                            <span>üìÖ ${time.toLocaleDateString()} ${time.toLocaleTimeString()}</span>
                            <span class="status-badge status-open">OPEN</span>
                        </div>
                    `;
                    
                    list.appendChild(item);
                }
                
            } catch (error) {
                console.error('Load matches error:', error);
                list.innerHTML = '<div class="error">Failed to load matches</div>';
            }
        }
        
        async function loadMyMatches() {
            const list = document.getElementById('my-matches-list');
            list.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const matchAddresses = await factoryContract.getUserMatches(userAddress);
                
                if (matchAddresses.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üéÆ</div>
                            <h3 style="margin-bottom: 12px;">No Matches Yet</h3>
                            <p style="color: #8b92a7; margin-bottom: 24px; line-height: 1.6;">
                                Create your first match or join<br>
                                an open match to get started!
                            </p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button class="btn btn-secondary" onclick="showTab('matches', document.querySelectorAll('.tab')[0])">
                                    Browse Matches
                                </button>
                                <button class="btn btn-primary" onclick="showTab('create', document.querySelectorAll('.tab')[1])">
                                    Create Match
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = '';
                
                for (const addr of matchAddresses) {
                    const escrow = new ethers.Contract(addr, ESCROW_ABI, provider);
                    
                    const [player1, player2, entryFee, scheduledTime, status] = await Promise.all([
                        escrow.player1(),
                        escrow.player2(),
                        escrow.entryFee(),
                        escrow.scheduledTime(),
                        escrow.status()
                    ]);
                    
                    const fee = ethers.formatUnits(entryFee, 18); // W1T has 18 decimals
                    const time = new Date(Number(scheduledTime) * 1000);
                    const statusText = STATUS_MAP[Number(status)] || 'Unknown';
                    
                    const opponent = player1.toLowerCase() === userAddress.toLowerCase() ? player2 : player1;
                    
                    const item = document.createElement('div');
                    item.className = 'match-item';
                    item.onclick = () => viewMatch(addr);
                    item.innerHTML = `
                        <div class="match-header">
                            <div class="match-player">vs ${getDisplayName(opponent)}</div>
                            <div class="match-fee">${parseFloat(fee).toFixed(2)} W1T</div>
                        </div>
                        <div class="match-details">
                            <span>üìÖ ${time.toLocaleDateString()}</span>
                            <span class="status-badge status-${statusText.toLowerCase()}">${statusText}</span>
                        </div>
                    `;
                    
                    list.appendChild(item);
                }
                
            } catch (error) {
                console.error('Load my matches error:', error);
                list.innerHTML = '<div class="error">Failed to load matches</div>';
            }
        }
        
        // ======== CREATE MATCH ========
        
        async function createMatch() {
            const opponentInput = document.getElementById('create-opponent').value.trim();
            const feeInput = document.getElementById('create-fee').value;
            const timeInput = document.getElementById('create-time').value;
            
            const errorDiv = document.getElementById('create-error');
            const successDiv = document.getElementById('create-success');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            try {
                // Validate
                if (!feeInput || parseFloat(feeInput) < 10) {
                    errorDiv.textContent = 'Minimum entry fee is 10 W1T';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                if (!timeInput) {
                    errorDiv.textContent = 'Please select a time';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                const opponent = opponentInput || ethers.ZeroAddress;
                const fee = ethers.parseUnits(feeInput, 18); // W1T has 18 decimals
                const scheduledTime = Math.floor(new Date(timeInput).getTime() / 1000);
                
                // Validate scheduled time is at least 1 hour from now
                const nowTs = Math.floor(Date.now() / 1000);
                if (scheduledTime < nowTs + 3600) {
                    errorDiv.textContent = 'Match must be scheduled at least 1 hour from now';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                // Create match
                successDiv.textContent = 'Creating match...';
                successDiv.classList.remove('hidden');
                
                const tx = await factoryContract.createMatch(opponent, fee, scheduledTime);
                
                successDiv.textContent = 'Waiting for confirmation...';
                
                await tx.wait();
                
                successDiv.textContent = '‚úÖ Match created! Go to My Matches to deposit.';
                
                // Clear form
                document.getElementById('create-opponent').value = '';
                document.getElementById('create-fee').value = '50';
                
                // Reload matches
                setTimeout(() => {
                    loadMatches();
                    loadMyMatches();
                }, 2000);
                
            } catch (error) {
                console.error('Create match error:', error);
                errorDiv.textContent = 'Failed to create match: ' + error.message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            }
        }
        
        // ======== VIEW MATCH ========
        
        async function viewMatch(address) {
            document.getElementById('tab-matches').classList.add('hidden');
            document.getElementById('tab-my-matches').classList.add('hidden');
            document.getElementById('match-detail').classList.remove('hidden');
            
            const content = document.getElementById('match-detail-content');
            content.innerHTML = '<div class="loading">Loading match details...</div>';
            
            try {
                const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
                
                const [player1, player2, entryFee, scheduledTime, status, isOpen] = await Promise.all([
                    escrow.player1(),
                    escrow.player2(),
                    escrow.entryFee(),
                    escrow.scheduledTime(),
                    escrow.status(),
                    escrow.isOpenMatch()
                ]);
                
                const fee = ethers.formatUnits(entryFee, 18); // W1T has 18 decimals
                const time = new Date(Number(scheduledTime) * 1000);
                const statusText = STATUS_MAP[Number(status)] || 'Unknown';
                
                const isPlayer = player1.toLowerCase() === userAddress.toLowerCase() || 
                                 player2.toLowerCase() === userAddress.toLowerCase();
                
                let html = `
                    <div class="balance">
                        <span class="balance-label">Player 1</span>
                        <span class="balance-value">${getDisplayName(player1)}</span>
                    </div>
                    <div class="balance">
                        <span class="balance-label">Player 2</span>
                        <span class="balance-value">${getDisplayName(player2)}</span>
                    </div>
                    <div class="balance">
                        <span class="balance-label">Entry Fee</span>
                        <span class="balance-value">${parseFloat(fee).toFixed(2)} W1T</span>
                    </div>
                    <div class="balance">
                        <span class="balance-label">Time</span>
                        <span class="balance-value">${time.toLocaleString()}</span>
                    </div>
                    <div class="balance">
                        <span class="balance-label">Status</span>
                        <span class="status-badge status-${statusText.toLowerCase()}">${statusText}</span>
                    </div>
                `;
                
                // Action buttons with helpful context
                if (isOpen && player2.toLowerCase() === ethers.ZeroAddress.toLowerCase() && !isPlayer) {
                    html += `
                        <div style="background: rgba(0,212,255,0.1); padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 13px; color: #8b92a7;">
                            This match is open! Click below to join and compete.
                        </div>
                        <button class="btn btn-primary" onclick="joinMatch('${address}')" style="margin-top: 12px;">Join Match</button>
                    `;
                }
                
                if (isPlayer && Number(status) === 0) {
                    html += `
                        <div style="background: rgba(255,165,0,0.1); padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 13px; color: #8b92a7;">
                            <strong>Next step:</strong> Deposit your entry fee to lock in this match.
                        </div>
                        <button class="btn btn-primary" onclick="depositToMatch('${address}')" style="margin-top: 12px;">Deposit ${parseFloat(fee).toFixed(2)} W1T</button>
                    `;
                }
                
                if (isPlayer && Number(status) === 1) {
                    const timeUntilMatch = Math.floor((Number(scheduledTime) * 1000 - Date.now()) / 1000 / 60);
                    html += `
                        <div style="background: rgba(0,255,136,0.1); padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 13px; color: #8b92a7;">
                            <strong>Match funded!</strong><br>
                            Check in within 30 minutes of match time (${timeUntilMatch > 0 ? 'in ' + timeUntilMatch + ' minutes' : 'now available'}).
                        </div>
                        <button class="btn btn-primary" onclick="checkInToMatch('${address}')" style="margin-top: 12px;">Check In</button>
                    `;
                }
                
                if (isPlayer && Number(status) === 2) {
                    html += `
                        <div style="background: rgba(138,43,226,0.1); padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 13px; color: #8b92a7;">
                            <strong>Match in progress!</strong><br>
                            After playing, both players must report the same winner to settle.
                        </div>
                        <div style="margin-top: 16px;">
                            <p style="color: #8b92a7; margin-bottom: 12px; font-size: 14px;">Who won?</p>
                            <button class="btn btn-primary" onclick="reportWin('${address}', '${player1}')" style="margin-bottom: 12px;">
                                ${getDisplayName(player1)} Won
                            </button>
                            <button class="btn btn-secondary" onclick="reportWin('${address}', '${player2}')">
                                ${getDisplayName(player2)} Won
                            </button>
                        </div>
                    `;
                }
                
                content.innerHTML = html;
                
            } catch (error) {
                console.error('View match error:', error);
                content.innerHTML = '<div class="error">Failed to load match details</div>';
            }
        }
        
        function closeMatchDetail() {
            document.getElementById('match-detail').classList.add('hidden');
            const activeTab = document.querySelector('.tab.active');
            if (activeTab.textContent === 'Matches') {
                document.getElementById('tab-matches').classList.remove('hidden');
            } else {
                document.getElementById('tab-my-matches').classList.remove('hidden');
            }
        }
        
        // ======== MATCH ACTIONS ========
        
        async function joinMatch(address) {
            const content = document.getElementById('match-detail-content');
            try {
                const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
                content.innerHTML += '<div class="success">Joining match...</div>';
                const tx = await escrow.joinMatch();
                await tx.wait();
                content.innerHTML += '<div class="success">‚úÖ Joined! Now deposit your entry fee.</div>';
                setTimeout(() => viewMatch(address), 2000);
            } catch (error) {
                content.innerHTML += '<div class="error">Failed to join: ' + error.message + '</div>';
            }
        }
        
        async function depositToMatch(address) {
            const content = document.getElementById('match-detail-content');
            try {
                const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
                const entryFee = await escrow.entryFee();
                
                // Check if approval needed (skip if already approved)
                const allowance = await w1tContract.allowance(userAddress, address);
                
                if (allowance < entryFee) {
                    content.innerHTML += '<div class="success">Step 1/2: Approving W1T...</div>';
                    const approveTx = await w1tContract.approve(address, entryFee);
                    await approveTx.wait();
                    content.innerHTML += '<div class="success">‚úÖ Approved!</div>';
                } else {
                    content.innerHTML += '<div class="success">Already approved, skipping to deposit...</div>';
                }
                
                // Deposit
                content.innerHTML += '<div class="success">Depositing W1T...</div>';
                const depositTx = await escrow.deposit();
                await depositTx.wait();
                
                content.innerHTML += '<div class="success">‚úÖ Deposited successfully!</div>';
                
                setTimeout(() => viewMatch(address), 2000);
                
            } catch (error) {
                content.innerHTML += '<div class="error">Failed to deposit: ' + error.message + '</div>';
            }
        }
        
        async function checkInToMatch(address) {
            const content = document.getElementById('match-detail-content');
            try {
                const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
                content.innerHTML += '<div class="success">Checking in...</div>';
                const tx = await escrow.checkIn();
                await tx.wait();
                content.innerHTML += '<div class="success">‚úÖ Checked in! Good luck!</div>';
                setTimeout(() => viewMatch(address), 2000);
            } catch (error) {
                content.innerHTML += '<div class="error">Failed to check in: ' + error.message + '</div>';
            }
        }
        
        async function reportWin(address, winner) {
            const content = document.getElementById('match-detail-content');
            try {
                const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
                content.innerHTML += '<div class="success">Reporting outcome...</div>';
                const tx = await escrow.reportOutcome(winner);
                await tx.wait();
                
                // Check if match is now settled (both players agreed)
                const status = await escrow.status();
                if (Number(status) === 5) { // Settled
                    content.innerHTML += '<div class="success">üèÜ Match settled! Stats will update automatically.</div>';
                    
                    // Clear stats cache to force refresh
                    globalStatsCache = null;
                } else {
                    content.innerHTML += '<div class="success">‚úÖ Outcome reported! Waiting for opponent confirmation.</div>';
                }
                
                setTimeout(() => viewMatch(address), 2000);
            } catch (error) {
                content.innerHTML += '<div class="error">Failed to report: ' + error.message + '</div>';
            }
        }
        
        // ======== TAB NAVIGATION ========
        
        function refreshStats() {
            globalStatsCache = null; // Clear cache
            buildLeaderboard(); // Rebuild
        }
        
        function showTab(tab, el) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            
            // Hide all tabs
            document.getElementById('tab-matches').classList.add('hidden');
            document.getElementById('tab-create').classList.add('hidden');
            document.getElementById('tab-my-matches').classList.add('hidden');
            document.getElementById('tab-leaderboard').classList.add('hidden');
            document.getElementById('tab-profile').classList.add('hidden');
            
            // Show selected
            if (tab === 'matches') {
                document.getElementById('tab-matches').classList.remove('hidden');
                loadMatches();
            } else if (tab === 'create') {
                document.getElementById('tab-create').classList.remove('hidden');
            } else if (tab === 'my-matches') {
                document.getElementById('tab-my-matches').classList.remove('hidden');
                loadMyMatches();
            } else if (tab === 'leaderboard') {
                document.getElementById('tab-leaderboard').classList.remove('hidden');
                buildLeaderboard();
            } else if (tab === 'profile') {
                document.getElementById('tab-profile').classList.remove('hidden');
                
                // Show loading state
                document.getElementById('profile-record').textContent = 'Loading...';
                document.getElementById('profile-winrate').textContent = 'Loading...';
                document.getElementById('profile-earnings').textContent = 'Loading...';
                
                // Load stats from chain
                getPlayerStats(userAddress).then(stats => {
                    document.getElementById('profile-username').textContent = '@' + (username || 'Not set');
                    document.getElementById('profile-record').textContent = `${stats.wins}-${stats.losses}`;
                    document.getElementById('profile-winrate').textContent = calculateWinRate(stats) + '%';
                    document.getElementById('profile-earnings').textContent = stats.earnings.toFixed(2) + ' W1T';
                    document.getElementById('profile-address').textContent = userAddress.slice(0, 10) + '...' + userAddress.slice(-8);
                }).catch(error => {
                    console.error('Error loading profile stats:', error);
                    document.getElementById('profile-record').textContent = '0-0';
                    document.getElementById('profile-winrate').textContent = '0%';
                    document.getElementById('profile-earnings').textContent = '0 W1T';
                });
            }
        }
        
        // ======== AUTO REFRESH ========
        
        setInterval(() => {
            if (userAddress && !document.getElementById('connected').classList.contains('hidden')) {
                loadBalance();
            }
        }, 30000); // Every 30 seconds
    </script>
</body>
</html>
