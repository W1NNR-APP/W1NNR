<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>W1NNR - Compete. Win. Earn.</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0e1a; color: #fff; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 40px 0; }
        .logo { font-size: 36px; font-weight: 900; background: linear-gradient(135deg, #00d4ff, #00ff88); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px; }
        .tagline { color: #8b92a7; margin-top: 10px; font-size: 14px; letter-spacing: 0.5px; }
        .card { background: rgba(26, 35, 60, 0.6); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; margin: 20px 0; backdrop-filter: blur(10px); }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #00ff88); color: #0a0e1a; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,212,255,0.4); }
        .btn-secondary { background: rgba(0,212,255,0.1); color: #00d4ff; border: 1px solid rgba(0,212,255,0.3); }
        .btn-secondary:hover:not(:disabled) { background: rgba(0,212,255,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .input { width: 100%; padding: 14px; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(0,0,0,0.3); color: #fff; font-size: 16px; margin: 10px 0; }
        .label { display: block; color: #8b92a7; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin: 16px 0 8px 0; }
        .balance { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .balance:last-child { border-bottom: none; }
        .balance-label { color: #8b92a7; font-size: 14px; }
        .balance-value { font-weight: 700; font-size: 16px; color: #00ff88; }
        .match-item { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; margin: 12px 0; cursor: pointer; transition: all 0.3s; }
        .match-item:hover { border-color: rgba(0,212,255,0.3); transform: translateY(-2px); }
        .match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .match-player { font-size: 16px; font-weight: 700; }
        .match-fee { color: #00ff88; font-weight: 700; font-size: 18px; }
        .match-details { display: flex; gap: 16px; color: #8b92a7; font-size: 13px; }
        .hidden { display: none; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-open       { background: rgba(0,212,255,0.2);   color: #00d4ff; }
        .status-funded     { background: rgba(255,165,0,0.2);   color: #ffa500; }
        .status-settled    { background: rgba(0,255,136,0.2);   color: #00ff88; }
        .status-inprogress { background: rgba(138,43,226,0.2);  color: #8a2be2; }
        .status-reported   { background: rgba(255,215,0,0.2);   color: #ffd700; }
        .status-disputed   { background: rgba(255,68,68,0.2);   color: #ff4444; }
        .status-cancelled, .status-expired, .status-noshow { background: rgba(150,150,150,0.2); color: #aaa; }
        .loading { text-align: center; padding: 40px; color: #8b92a7; }
        .error   { background: rgba(255,68,68,0.2);   color: #ff4444;  padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 14px; }
        .success { background: rgba(0,255,136,0.2);   color: #00ff88;  padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 14px; }
        .info-box { padding: 12px 16px; border-radius: 8px; font-size: 13px; margin: 12px 0; line-height: 1.6; }
        .info-blue   { background: rgba(0,212,255,0.1);  border-left: 3px solid #00d4ff; color: #8b92a7; }
        .info-orange { background: rgba(255,165,0,0.1);  border-left: 3px solid #ffa500; color: #8b92a7; }
        .info-green  { background: rgba(0,255,136,0.1);  border-left: 3px solid #00ff88; color: #8b92a7; }
        .info-purple { background: rgba(138,43,226,0.1); border-left: 3px solid #8a2be2; color: #8b92a7; }
        .info-yellow { background: rgba(255,215,0,0.1);  border-left: 3px solid #ffd700; color: #8b92a7; }
        .info-red    { background: rgba(255,68,68,0.1);  border-left: 3px solid #ff4444; color: #8b92a7; }
        .info-gray   { background: rgba(150,150,150,0.1);border-left: 3px solid #aaa;    color: #8b92a7; }
        .waiting-banner { background: rgba(255,165,0,0.08); border: 1px dashed rgba(255,165,0,0.4); border-radius: 12px; padding: 24px; text-align: center; margin: 16px 0; }
        .tabs { display: grid; grid-template-columns: repeat(5,1fr); gap: 6px; margin: 20px 0; }
        .tab { padding: 12px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tab.active { background: rgba(0,212,255,0.2); border-color: rgba(0,212,255,0.3); color: #00d4ff; }
        @media (max-width: 600px) {
            .tabs { grid-template-columns: repeat(3,1fr); gap: 8px; }
            .tab  { font-size: 12px; padding: 10px 6px; }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- ‚îÄ‚îÄ SOCIAL LINK BAR ‚îÄ‚îÄ -->
    <div style="text-align:center;padding:10px 0 0;">
        <a href="https://w1nnr-app.github.io/W1NNR/home.html" style="font-size:12px;color:#6b7394;text-decoration:none;letter-spacing:.5px;font-weight:600;">
            ‚Üê W1NNR Home
        </a>
    </div>

    <div class="header">
        <div class="logo">W1NNR</div>
        <div class="tagline">COMPETE ‚Ä¢ WIN ‚Ä¢ EARN</div>
    </div>

    <!-- Not Connected -->
    <div id="not-connected">
        <div class="card">
            <h2 style="margin-bottom:16px;">üèÜ Compete for Real Stakes</h2>
            <p style="color:#8b92a7;margin-bottom:16px;line-height:1.6;">
                W1NNR lets you compete against other players in golf, tennis, and more ‚Äî with real money on the line.
            </p>
            <div class="info-box info-blue" style="margin:20px 0;">
                <strong style="color:#00d4ff;">How it works:</strong><br>
                1Ô∏è‚É£ Create or join a match<br>
                2Ô∏è‚É£ Both players deposit stakes<br>
                3Ô∏è‚É£ Play your match<br>
                4Ô∏è‚É£ Report the winner<br>
                5Ô∏è‚É£ Winner takes 92% of the pot üí∞
            </div>
            <div class="info-box info-orange" style="margin:20px 0;">
                <strong style="color:#ffa500;">‚ö†Ô∏è You'll need:</strong><br>
                ‚Ä¢ MetaMask wallet (or compatible)<br>
                ‚Ä¢ PulseChain network added<br>
                ‚Ä¢ Some W1T tokens for testing<br>
                ‚Ä¢ A friend to compete against!
            </div>
            <button class="btn btn-primary" onclick="connectWallet()" style="margin-top:20px;">Connect Wallet to Start</button>
            <p style="color:#666;font-size:12px;margin-top:16px;text-align:center;">Skill-based competitive escrow. Check local regulations before participating.</p>
            <p style="color:#666;font-size:11px;margin-top:8px;text-align:center;opacity:0.7;">Your wallet. Your stakes. Your glory.</p>
        </div>
    </div>

    <!-- Connected -->
    <div id="connected" class="hidden">

        <!-- First Time Banner -->
        <div id="first-time-banner" class="card" style="background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(0,255,136,0.2));border:2px solid rgba(0,212,255,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:start;">
                <div style="flex:1;">
                    <h3 style="margin-bottom:12px;">üëã Welcome to W1NNR!</h3>
                    <p style="color:#8b92a7;font-size:14px;line-height:1.6;margin-bottom:12px;">
                        <strong>Quick Start:</strong> Go to the "Create" tab to set up your first match, or browse "Matches" to join an existing one.
                    </p>
                    <p style="color:#8b92a7;font-size:13px;">üí° Tip: Set a username in your Profile so opponents know who they're playing!</p>
                </div>
                <button onclick="dismissFirstTimeBanner()" style="background:none;border:none;color:#8b92a7;cursor:pointer;font-size:20px;padding:0 0 0 16px;">√ó</button>
            </div>
        </div>

        <!-- Wallet Info -->
        <div class="card">
            <div class="balance"><span class="balance-label">Wallet</span><span class="balance-value" id="wallet-address">0x...</span></div>
            <div class="balance"><span class="balance-label">W1T Balance</span><span class="balance-value" id="w1t-balance">0.00 W1T</span></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active"  onclick="showTab('matches',    this)">Matches</div>
            <div class="tab"         onclick="showTab('create',     this)">Create</div>
            <div class="tab"         onclick="showTab('my-matches', this)">My Matches</div>
            <div class="tab"         onclick="showTab('leaderboard',this)">Leaders</div>
            <div class="tab"         onclick="showTab('profile',    this)">Profile</div>
        </div>

        <!-- Open Matches Tab -->
        <div id="tab-matches">
            <div class="card">
                <h2 style="margin-bottom:16px;">Open Matches</h2>
                <button class="btn btn-secondary" onclick="loadMatches()" style="margin-bottom:16px;">Refresh</button>
                <div id="matches-list"><div class="loading">Loading matches...</div></div>
            </div>
        </div>

        <!-- Create Match Tab -->
        <div id="tab-create" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:16px;">Create a Match</h2>
                <div class="info-box info-blue" style="margin-bottom:24px;">
                    <strong style="color:#00d4ff;">üí° How this works:</strong><br>
                    ‚Ä¢ Leave opponent blank to create an <strong>open match</strong> anyone can join<br>
                    ‚Ä¢ Or enter a specific address for a <strong>private match</strong><br>
                    ‚Ä¢ Both players deposit ‚Üí Check-in at match time ‚Üí Play ‚Üí Report winner
                </div>
                <label class="label">Opponent (optional ‚Äî leave blank for open)</label>
                <input type="text"          class="input" id="create-opponent" placeholder="0x... or leave blank for open match">
                <label class="label">Entry Fee (W1T)</label>
                <input type="number"        class="input" id="create-fee" placeholder="50" value="50" min="10" step="1">
                <p style="color:#8b92a7;font-size:12px;margin-top:4px;">Minimum: 10 W1T &nbsp;‚Ä¢&nbsp; Winner gets 92% of total pot</p>
                <label class="label">Scheduled Time</label>
                <input type="datetime-local" class="input" id="create-time">
                <p style="color:#8b92a7;font-size:12px;margin-top:4px;">Must be at least 1 hour from now</p>
                <div id="create-error"   class="error   hidden"></div>
                <div id="create-success" class="success hidden"></div>
                <button class="btn btn-primary" id="create-btn" onclick="createMatch()" style="margin-top:20px;">Create Match</button>
            </div>
        </div>

        <!-- My Matches Tab -->
        <div id="tab-my-matches" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:16px;">My Matches</h2>
                <button class="btn btn-secondary" onclick="loadMyMatches()" style="margin-bottom:16px;">Refresh</button>
                <div id="my-matches-list"><div class="loading">Loading your matches...</div></div>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="tab-leaderboard" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:16px;">Leaderboard</h2>
                <p style="color:#8b92a7;margin-bottom:16px;font-size:14px;">Top competitors ranked by wins</p>
                <button class="btn btn-secondary" onclick="refreshStats()" style="margin-bottom:16px;">Refresh Stats</button>
                <div id="leaderboard-list"><div class="loading">Loading leaderboard...</div></div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="tab-profile" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:16px;">Your Profile</h2>
                <div class="info-box info-blue" style="margin-bottom:20px;">üí° Set a username so opponents know who they're competing against!</div>
                <div class="balance"><span class="balance-label">Username</span>    <span class="balance-value" id="profile-username">@username</span></div>
                <div class="balance"><span class="balance-label">Record</span>      <span class="balance-value" id="profile-record">0-0</span></div>
                <div class="balance"><span class="balance-label">Win Rate</span>    <span class="balance-value" id="profile-winrate">0%</span></div>
                <div class="balance"><span class="balance-label">Total Earnings</span><span class="balance-value" id="profile-earnings">0 W1T</span></div>
                <div class="balance"><span class="balance-label">Wallet</span>      <span class="balance-value" id="profile-address">0x...</span></div>
                <button class="btn btn-primary" onclick="changeUsername()" style="margin-top:20px;">Change Username</button>
                <div style="margin-top:20px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="color:#8b92a7;font-size:12px;line-height:1.6;">
                        <strong>Stats Update:</strong> Your record and earnings are calculated from settled matches on the blockchain. They update every 60 seconds.
                    </p>
                </div>
            </div>
        </div>

        <!-- Match Detail -->
        <div id="match-detail" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:16px;">Match Details</h2>
                <div id="match-detail-content"></div>
                <button class="btn btn-secondary" onclick="closeMatchDetail()" style="margin-top:20px;">‚Üê Back</button>
            </div>
        </div>
    </div>
</div>

<script>
// ======== CONFIG ========
const CONFIG = {
    FACTORY_ADDRESS:      '0xB2f2581F2dFF71956C1C8Bc595C51f20Ed44cAfC',
    W1T_ADDRESS:          '0x49A0bdA692e774E359c5c2c17DdC29f5ce1DfbAC',
    CHAIN_ID:             369,         // PulseChain Mainnet
    RPC_URL:              'https://rpc.pulsechain.com',
    FACTORY_DEPLOY_BLOCK: 22587000,
    TOKEN_DECIMALS:       18,
    TOKEN_SYMBOL:         'W1T',
    MIN_FEE:              10,          // Enforced client-side (real minimum)
    //
    // ‚îÄ‚îÄ CONTRACT NOTE (v2 TODO) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // MatchFactory and MatchEscrow both enforce: require(entryFee >= 10e6)
    // W1T has 18 decimals, so 10e6 raw ‚âà 0.00000000001 W1T ‚Äî effectively no
    // on-chain minimum. Frontend enforces MIN_FEE = 10 W1T as the real guard.
    //
    // FIX FOR V2: In both contracts change the minimum check to:
    //   require(entryFee >= 10e18, "Min 10 tokens");
    // This aligns the contract guard with the intended UX minimum.
    // No other contract changes required for this fix.
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
};

// ======== ABIs ========
const FACTORY_ABI = [
    "function createMatch(address player2, uint256 entryFee, uint256 scheduledTime) external returns (address)",
    "function getOpenMatches(uint256 maxResults) external view returns (address[])",
    "function getUserMatches(address user) external view returns (address[])",
    "function isMatch(address) external view returns (bool)",
    "event MatchCreated(address indexed escrow, address indexed player1, address indexed player2, uint256 entryFee, uint256 scheduledTime, bool isOpen)"
];

const ESCROW_ABI = [
    "function player1() external view returns (address)",
    "function player2() external view returns (address)",
    "function player2Initial() external view returns (address)",
    "function entryFee() external view returns (uint256)",
    "function scheduledTime() external view returns (uint256)",
    "function status() external view returns (uint8)",
    "function isOpenMatch() external view returns (bool)",
    "function joinMatch() external",
    "function deposit() external",
    "function checkIn() external",
    "function reportOutcome(address winner) external",
    "event Settled(address indexed winner, address indexed loser, uint256 prize)",
    "event MatchJoined(address indexed player2)",
    "event Deposited(address indexed player)",
    "event Funded(uint256 netPot, uint256 platformFee)",
    "event CheckedIn(address indexed player)",
    "event OutcomeReported(address indexed reporter, address winner)",
    "event Disputed(uint256 disputeStartTime)",
    "event NoShowProcessed(address indexed showed, address indexed noShow)",
    "event DisputeRefunded(uint256 amountEach)",
    "event Cancelled(uint256 refundEach)",
    "event Expired()"
];

const ERC20_ABI = [
    "function balanceOf(address) external view returns (uint256)",
    "function approve(address spender, uint256 amount) external returns (bool)",
    "function allowance(address owner, address spender) external view returns (uint256)"
];

// ======== STATUS MAP ========
const STATUS_MAP = { 0:'Open', 1:'Funded', 2:'InProgress', 3:'Reported', 4:'Disputed', 5:'Settled', 6:'Cancelled', 7:'Expired', 8:'NoShow' };

// ======== STATE ========
let provider, signer, userAddress;
let factoryContract, w1tContract;
let username = null;

// ======== USERNAME ========
function loadUsername() {
    if (!userAddress) return;
    username = localStorage.getItem("w1nnr_username_" + userAddress.toLowerCase());
}

function promptUsername() {
    if (!username) {
        const input = prompt("Choose your W1NNR username (3-16 characters):");
        if (input && input.trim().length >= 3 && input.trim().length <= 16) {
            username = input.trim();
            localStorage.setItem("w1nnr_username_" + userAddress.toLowerCase(), username);
            localStorage.setItem("w1nnr_user_"     + userAddress.toLowerCase(), username);
            document.getElementById('wallet-address').textContent = '@' + username;
        } else if (input) {
            alert('Username must be 3-16 characters');
            promptUsername();
        }
    }
}

function getDisplayName(address) {
    if (!address || address === ethers.ZeroAddress) return 'Open';
    if (address.toLowerCase() === userAddress?.toLowerCase()) return '@' + (username || 'You');
    const cached = localStorage.getItem("w1nnr_user_" + address.toLowerCase());
    if (cached) return '@' + cached;
    return address.slice(0,6) + '...' + address.slice(-4);
}

function changeUsername() {
    username = null;
    localStorage.removeItem("w1nnr_username_" + userAddress.toLowerCase());
    promptUsername();
    document.getElementById('profile-username').textContent = '@' + (username || 'Not set');
    document.getElementById('wallet-address').textContent   = username ? '@' + username : userAddress.slice(0,6) + '...' + userAddress.slice(-4);
}

// ======== STATS / LEADERBOARD ========
let globalStatsCache = null;
let statsLastLoaded  = 0;
const STATS_CACHE_TTL = 60000;

async function getAllMatchAddresses() {
    try {
        const events = await factoryContract.queryFilter(factoryContract.filters.MatchCreated(), CONFIG.FACTORY_DEPLOY_BLOCK, "latest");
        return events.map(e => e.args.escrow);
    } catch(e) { console.error("getAllMatchAddresses:", e); return []; }
}

async function buildGlobalStats() {
    const stats = {};
    if (!provider) return stats;
    try {
        const matchAddresses = await getAllMatchAddresses();
        if (matchAddresses.length === 0) return stats;

        const settledTopic = ethers.id("Settled(address,address,uint256)");
        const CHUNK = 50;
        const allLogs = [];
        for (let i = 0; i < matchAddresses.length; i += CHUNK) {
            const logs = await provider.getLogs({
                fromBlock: CONFIG.FACTORY_DEPLOY_BLOCK, toBlock: "latest",
                address: matchAddresses.slice(i, i + CHUNK),
                topics: [settledTopic]
            });
            allLogs.push(...logs);
        }

        const iface = new ethers.Interface(ESCROW_ABI);
        for (const log of allLogs) {
            try {
                const p = iface.parseLog(log);
                const winner = p.args.winner.toLowerCase();
                const loser  = p.args.loser.toLowerCase();
                const prize  = parseFloat(ethers.formatUnits(p.args.prize, CONFIG.TOKEN_DECIMALS));
                if (!stats[winner]) stats[winner] = { wins:0, losses:0, earnings:0 };
                stats[winner].wins++;
                stats[winner].earnings += prize;
                if (!stats[loser])  stats[loser]  = { wins:0, losses:0, earnings:0 };
                stats[loser].losses++;
            } catch(e) { /* skip bad log */ }
        }
        return stats;
    } catch(e) { console.error("buildGlobalStats:", e); return {}; }
}

async function getGlobalStats(force = false) {
    const now = Date.now();
    if (!force && globalStatsCache && (now - statsLastLoaded < STATS_CACHE_TTL)) return globalStatsCache;
    globalStatsCache = await buildGlobalStats();
    statsLastLoaded  = now;
    return globalStatsCache;
}

async function getPlayerStats(address) {
    const stats = await getGlobalStats();
    return stats[address.toLowerCase()] || { wins:0, losses:0, earnings:0 };
}

function calcWinRate(s) {
    const t = s.wins + s.losses;
    return t === 0 ? '0' : ((s.wins / t) * 100).toFixed(1);
}

async function buildLeaderboard() {
    const list = document.getElementById('leaderboard-list');
    list.innerHTML = '<div class="loading">Building leaderboard from blockchain...</div>';
    try {
        const stats = await getGlobalStats();
        const players = Object.entries(stats).map(([addr, rec]) => ({
            address: addr, ...rec, name: getDisplayName(addr), winRate: calcWinRate(rec)
        })).sort((a,b) => b.wins - a.wins);

        list.innerHTML = '';
        if (players.length === 0) {
            list.innerHTML = '<p style="color:#8b92a7;text-align:center;padding:20px;">No matches settled yet. Play a match to appear here!</p>';
            return;
        }
        players.slice(0,10).forEach((p, i) => {
            const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`${i+1}.`;
            const mColor = i===0?'#FFD700':i===1?'#C0C0C0':i===2?'#CD7F32':'#666';
            const div = document.createElement('div');
            div.className = 'balance';
            div.style.padding = '16px 0';
            div.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;width:100%;">
                    <span style="font-size:20px;font-weight:900;color:${mColor};width:40px;flex-shrink:0;">${medal}</span>
                    <div style="flex:1;">
                        <div style="font-weight:700;font-size:16px;">${p.name}</div>
                        <div style="color:#8b92a7;font-size:13px;">${p.wins}-${p.losses} &nbsp;‚Ä¢&nbsp; ${p.winRate}% WR &nbsp;‚Ä¢&nbsp; ${p.earnings.toFixed(2)} ${CONFIG.TOKEN_SYMBOL}</div>
                    </div>
                </div>`;
            list.appendChild(div);
        });
        const hint = document.createElement('p');
        hint.style.cssText = 'color:#8b92a7;font-size:12px;text-align:center;margin-top:16px;';
        hint.textContent = 'Stats update automatically every 60 seconds';
        list.appendChild(hint);
    } catch(e) {
        list.innerHTML = '<div class="error">Failed to load leaderboard. Please try again.</div>';
    }
}

// ======== ONBOARDING ========
function dismissFirstTimeBanner() {
    document.getElementById('first-time-banner').style.display = 'none';
    localStorage.setItem('w1nnr_onboarding_dismissed','true');
}
function checkFirstTimeUser() {
    if (localStorage.getItem('w1nnr_onboarding_dismissed')) document.getElementById('first-time-banner').style.display = 'none';
}

// ======== WALLET ========
async function connectWallet() {
    try {
        if (!window.ethereum) { alert('Please install MetaMask!'); return; }
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const network = await provider.getNetwork();
        if (network.chainId !== BigInt(CONFIG.CHAIN_ID)) {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x171' }], // 369 in hex
                });
                // Re-init provider after switch
                provider = new ethers.BrowserProvider(window.ethereum);
            } catch (switchError) {
                alert('Please switch to PulseChain (Chain ID 369) in MetaMask');
                return;
            }
        }
        signer      = await provider.getSigner();
        userAddress = await signer.getAddress();
        factoryContract = new ethers.Contract(CONFIG.FACTORY_ADDRESS, FACTORY_ABI, signer);
        w1tContract     = new ethers.Contract(CONFIG.W1T_ADDRESS, ERC20_ABI, signer);
        document.getElementById('not-connected').classList.add('hidden');
        document.getElementById('connected').classList.remove('hidden');
        await loadBalance();
        loadUsername();
        promptUsername();
        checkFirstTimeUser();
        document.getElementById('wallet-address').textContent = username ? '@'+username : userAddress.slice(0,6)+'...'+userAddress.slice(-4);
        const def = new Date(); def.setHours(def.getHours()+2);
        document.getElementById('create-time').value = def.toISOString().slice(0,16);
        await loadMatches();

        // Reload on wallet or network change to prevent stale state
        window.ethereum.on('accountsChanged', () => location.reload());
        window.ethereum.on('chainChanged',    () => location.reload());

    } catch(e) {
        console.error(e);
        alert('Failed to connect: ' + e.message);
    }
}

// ======== LOAD DATA ========
async function loadBalance() {
    try {
        const bal = await w1tContract.balanceOf(userAddress);
        document.getElementById('w1t-balance').textContent = parseFloat(ethers.formatUnits(bal, CONFIG.TOKEN_DECIMALS)).toFixed(2) + ' ' + CONFIG.TOKEN_SYMBOL;
    } catch(e) { console.error("loadBalance:", e); }
}

async function loadMatches() {
    const list = document.getElementById('matches-list');
    list.innerHTML = '<div class="loading">Loading...</div>';
    try {
        const addrs = await factoryContract.getOpenMatches(20);
        if (addrs.length === 0) {
            list.innerHTML = `
                <div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:16px;">üéØ</div>
                    <h3 style="margin-bottom:12px;">No Open Matches Yet</h3>
                    <p style="color:#8b92a7;margin-bottom:24px;line-height:1.6;">Be the first to create a match!<br>Other players can join and compete with you.</p>
                    <button class="btn btn-primary" onclick="showTab('create',document.querySelectorAll('.tab')[1])">Create Your First Match</button>
                </div>`;
            return;
        }
        list.innerHTML = '';
        for (const addr of addrs) {
            const e = new ethers.Contract(addr, ESCROW_ABI, provider);
            const [p1, fee, t] = await Promise.all([e.player1(), e.entryFee(), e.scheduledTime()]);
            const fmtFee = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(2);
            const time   = new Date(Number(t)*1000);
            const item   = document.createElement('div');
            item.className = 'match-item';
            item.onclick   = () => viewMatch(addr);
            item.innerHTML = `
                <div class="match-header">
                    <div class="match-player">${getDisplayName(p1)}</div>
                    <div class="match-fee">${fmtFee} ${CONFIG.TOKEN_SYMBOL}</div>
                </div>
                <div class="match-details">
                    <span>üìÖ ${time.toLocaleDateString()} ${time.toLocaleTimeString()}</span>
                    <span class="status-badge status-open">OPEN</span>
                </div>`;
            list.appendChild(item);
        }
    } catch(e) {
        console.error(e);
        list.innerHTML = '<div class="error">Failed to load matches. Check your connection.</div>';
    }
}

async function loadMyMatches() {
    const list = document.getElementById('my-matches-list');
    list.innerHTML = '<div class="loading">Loading...</div>';
    try {
        const addrs = await factoryContract.getUserMatches(userAddress);
        if (addrs.length === 0) {
            list.innerHTML = `
                <div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:16px;">üéÆ</div>
                    <h3 style="margin-bottom:12px;">No Matches Yet</h3>
                    <p style="color:#8b92a7;margin-bottom:24px;line-height:1.6;">Create your first match or join an open match to get started!</p>
                    <div style="display:flex;gap:12px;justify-content:center;">
                        <button class="btn btn-secondary" style="width:auto;padding:12px 20px;" onclick="showTab('matches',document.querySelectorAll('.tab')[0])">Browse Matches</button>
                        <button class="btn btn-primary"   style="width:auto;padding:12px 20px;" onclick="showTab('create', document.querySelectorAll('.tab')[1])">Create Match</button>
                    </div>
                </div>`;
            return;
        }
        list.innerHTML = '';
        for (const addr of addrs) {
            const e = new ethers.Contract(addr, ESCROW_ABI, provider);
            const [p1,p2,fee,t,st] = await Promise.all([e.player1(),e.player2(),e.entryFee(),e.scheduledTime(),e.status()]);
            const fmtFee     = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(2);
            const time       = new Date(Number(t)*1000);
            const statusText = STATUS_MAP[Number(st)] || 'Unknown';
            const opponent   = p1.toLowerCase() === userAddress.toLowerCase() ? p2 : p1;
            const item = document.createElement('div');
            item.className = 'match-item';
            item.onclick   = () => viewMatch(addr);
            item.innerHTML = `
                <div class="match-header">
                    <div class="match-player">vs ${getDisplayName(opponent)}</div>
                    <div class="match-fee">${fmtFee} ${CONFIG.TOKEN_SYMBOL}</div>
                </div>
                <div class="match-details">
                    <span>üìÖ ${time.toLocaleDateString()}</span>
                    <span class="status-badge status-${statusText.toLowerCase()}">${statusText}</span>
                </div>`;
            list.appendChild(item);
        }
    } catch(e) {
        console.error(e);
        list.innerHTML = '<div class="error">Failed to load your matches.</div>';
    }
}

// ======== CREATE MATCH ========
async function createMatch() {
    const oppInput  = document.getElementById('create-opponent').value.trim();
    const feeInput  = document.getElementById('create-fee').value;
    const timeInput = document.getElementById('create-time').value;
    const errDiv    = document.getElementById('create-error');
    const okDiv     = document.getElementById('create-success');
    const btn       = document.getElementById('create-btn');

    errDiv.classList.add('hidden');
    okDiv.classList.add('hidden');

    // Validate
    const feeNum = parseFloat(feeInput);
    if (!feeInput || feeNum < CONFIG.MIN_FEE) {
        errDiv.textContent = `Minimum entry fee is ${CONFIG.MIN_FEE} ${CONFIG.TOKEN_SYMBOL}`;
        return errDiv.classList.remove('hidden');
    }
    if (!timeInput) {
        errDiv.textContent = 'Please select a scheduled time';
        return errDiv.classList.remove('hidden');
    }
    const scheduledTime = Math.floor(new Date(timeInput).getTime() / 1000);
    if (scheduledTime < Math.floor(Date.now()/1000) + 3600) {
        errDiv.textContent = 'Match must be scheduled at least 1 hour from now';
        return errDiv.classList.remove('hidden');
    }
    if (oppInput && !ethers.isAddress(oppInput)) {
        errDiv.textContent = 'Invalid opponent address';
        return errDiv.classList.remove('hidden');
    }
    const opponent = (oppInput && oppInput !== '') ? oppInput : ethers.ZeroAddress;
    if (opponent !== ethers.ZeroAddress && opponent.toLowerCase() === userAddress.toLowerCase()) {
        errDiv.textContent = 'You cannot play against yourself';
        return errDiv.classList.remove('hidden');
    }

    btn.disabled = true; btn.textContent = 'Creating Match...';
    okDiv.textContent = 'Sending transaction...'; okDiv.classList.remove('hidden');

    try {
        const fee = ethers.parseUnits(feeInput, CONFIG.TOKEN_DECIMALS);
        const tx  = await factoryContract.createMatch(opponent, fee, scheduledTime);
        okDiv.textContent = 'Waiting for confirmation...';
        await tx.wait();
        okDiv.textContent = '‚úÖ Match created! Go to My Matches to deposit your stake.';
        document.getElementById('create-opponent').value = '';
        document.getElementById('create-fee').value = '50';
        setTimeout(() => { loadMatches(); loadMyMatches(); }, 2000);
    } catch(e) {
        errDiv.textContent = 'Failed to create match: ' + parseContractError(e);
        errDiv.classList.remove('hidden'); okDiv.classList.add('hidden');
    } finally {
        btn.disabled = false; btn.textContent = 'Create Match';
    }
}

// ======== VIEW MATCH ========
async function viewMatch(address) {
    document.getElementById('tab-matches').classList.add('hidden');
    document.getElementById('tab-my-matches').classList.add('hidden');
    document.getElementById('match-detail').classList.remove('hidden');
    const content = document.getElementById('match-detail-content');
    content.innerHTML = '<div class="loading">Loading match details...</div>';

    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        const [p1, p2, fee, schTime, stNum, isOpen] = await Promise.all([
            escrow.player1(), escrow.player2(), escrow.entryFee(),
            escrow.scheduledTime(), escrow.status(), escrow.isOpenMatch()
        ]);

        const fmtFee     = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(2);
        const prize      = (parseFloat(fmtFee) * 2 * 0.92).toFixed(2);
        const time       = new Date(Number(schTime)*1000);
        const status     = Number(stNum);
        const statusText = STATUS_MAP[status] || 'Unknown';
        const isP1       = p1.toLowerCase() === userAddress.toLowerCase();
        const isP2       = p2.toLowerCase() === userAddress.toLowerCase();
        const isPlayer   = isP1 || isP2;
        const p2Joined   = p2.toLowerCase() !== ethers.ZeroAddress.toLowerCase();

        let html = `
            <div class="balance"><span class="balance-label">Player 1</span><span class="balance-value">${getDisplayName(p1)}</span></div>
            <div class="balance"><span class="balance-label">Player 2</span><span class="balance-value">${p2Joined ? getDisplayName(p2) : '‚Äî'}</span></div>
            <div class="balance"><span class="balance-label">Entry Fee</span><span class="balance-value">${fmtFee} ${CONFIG.TOKEN_SYMBOL} each</span></div>
            <div class="balance"><span class="balance-label">Prize Pot</span><span class="balance-value" style="color:#00d4ff;">${prize} ${CONFIG.TOKEN_SYMBOL} to winner</span></div>
            <div class="balance"><span class="balance-label">Scheduled</span><span class="balance-value" style="font-size:14px;">${time.toLocaleString()}</span></div>
            <div class="balance" style="border-bottom:none;"><span class="balance-label">Status</span><span class="status-badge status-${statusText.toLowerCase()}">${statusText}</span></div>
        `;

        // ‚îÄ‚îÄ FIX #1: Open match creator waiting for someone to join ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (isOpen && !p2Joined && isP1) {
            html += `
                <div class="waiting-banner" style="margin-top:20px;">
                    <div style="font-size:32px;margin-bottom:10px;">‚è≥</div>
                    <div style="font-weight:700;margin-bottom:8px;">Waiting for an Opponent</div>
                    <p style="color:#8b92a7;font-size:13px;line-height:1.6;">
                        Your match is live! Share this page with your opponent ‚Äî they can find it in the Open Matches tab.<br><br>
                        <strong style="color:#ffa500;">Don't deposit yet</strong> ‚Äî your deposit button will appear once someone joins.
                    </p>
                </div>`;
        }
        // Outsider can join open match
        else if (isOpen && !p2Joined && !isPlayer) {
            html += `
                <div class="info-box info-blue" style="margin-top:20px;">
                    This is an open match ‚Äî join to compete against ${getDisplayName(p1)} for <strong>${prize} ${CONFIG.TOKEN_SYMBOL}</strong>.
                </div>
                <button class="btn btn-primary" id="action-btn" onclick="joinMatch('${address}')" style="margin-top:12px;">Join Match</button>`;
        }
        // ‚îÄ‚îÄ FIX #1 continued: open match, p2 just joined, both can deposit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        else if (isOpen && p2Joined && isPlayer && status === 0) {
            html += `
                <div class="info-box info-orange" style="margin-top:20px;">
                    <strong>Opponent joined!</strong> Both players must now deposit to lock in the match.
                </div>
                <button class="btn btn-primary" id="action-btn" onclick="depositToMatch('${address}')" style="margin-top:12px;">Deposit ${fmtFee} ${CONFIG.TOKEN_SYMBOL}</button>`;
        }
        // Private match waiting for deposit
        else if (!isOpen && isPlayer && status === 0) {
            html += `
                <div class="info-box info-orange" style="margin-top:20px;">
                    <strong>Next step:</strong> Deposit your entry fee to lock in this match. Both players must deposit to start.
                </div>
                <button class="btn btn-primary" id="action-btn" onclick="depositToMatch('${address}')" style="margin-top:12px;">Deposit ${fmtFee} ${CONFIG.TOKEN_SYMBOL}</button>`;
        }
        // Funded ‚Äî check-in
        else if (isPlayer && status === 1) {
            const nowMs      = Date.now();
            const matchMs    = Number(schTime)*1000;
            const windowEnd  = matchMs + 30*60*1000;
            const minsToMatch= Math.round((matchMs - nowMs)/60000);
            const minsLeft   = Math.round((windowEnd - nowMs)/60000);
            let checkinMsg   = '';
            let btnDisabled  = '';
            if      (nowMs < matchMs)   { checkinMsg = `Check-in opens in ${minsToMatch} minute${minsToMatch!==1?'s':''}.`; btnDisabled = 'disabled'; }
            else if (nowMs <= windowEnd){ checkinMsg = `‚ö° Window open! Closes in ${minsLeft} minute${minsLeft!==1?'s':''}.`; }
            else                        { checkinMsg = 'Check-in window has closed. Match can be expired for a refund.'; btnDisabled = 'disabled'; }
            html += `
                <div class="info-box info-green" style="margin-top:20px;"><strong>Match funded!</strong> ${checkinMsg}</div>
                <button class="btn btn-primary" id="action-btn" onclick="checkInToMatch('${address}')" style="margin-top:12px;" ${btnDisabled}>Check In</button>`;
        }
        // In Progress ‚Äî report
        else if (isPlayer && status === 2) {
            const deadline = new Date((Number(schTime) + 30*60 + 24*3600)*1000);
            html += `
                <div class="info-box info-purple" style="margin-top:20px;">
                    <strong>Match in progress!</strong> After playing, both players must report the same winner to settle the prize.<br>
                    <span style="font-size:12px;opacity:0.8;">‚è∞ Report by: ${deadline.toLocaleString()}</span>
                </div>
                <p style="color:#8b92a7;margin:16px 0 12px;font-size:14px;">Who won?</p>
                <button class="btn btn-primary"   id="action-btn-p1" onclick="reportWin('${address}','${p1}')" style="margin-bottom:12px;">${getDisplayName(p1)} Won</button>
                <button class="btn btn-secondary" id="action-btn-p2" onclick="reportWin('${address}','${p2}')">${getDisplayName(p2)} Won</button>`;
        }
        // Reported ‚Äî waiting for 2nd
        else if (isPlayer && status === 3) {
            html += `<div class="info-box info-yellow" style="margin-top:20px;">‚úÖ Your outcome has been reported. Waiting for opponent to confirm. If they don't report in time, your report wins automatically.</div>`;
        }
        // Disputed
        else if (isPlayer && status === 4) {
            html += `<div class="info-box info-red" style="margin-top:20px;">‚ö†Ô∏è This match is disputed. If no agreement is reached within 48 hours, stakes will be refunded equally to both players.</div>`;
        }
        // Settled
        else if (status === 5) {
            html += `<div class="info-box info-green" style="margin-top:20px;">üèÜ Match settled! The winner has been paid.</div>`;
        }
        // Terminal
        else if ([6,7,8].includes(status)) {
            html += `<div class="info-box info-gray" style="margin-top:20px;">This match has ended (${statusText}). Any refunds have been processed.</div>`;
        }

        content.innerHTML = html;
    } catch(e) {
        console.error(e);
        content.innerHTML = '<div class="error">Failed to load match details. Please try again.</div>';
    }
}

function closeMatchDetail() {
    document.getElementById('match-detail').classList.add('hidden');
    const active = document.querySelector('.tab.active');
    if (active && active.textContent.trim() === 'My Matches') {
        document.getElementById('tab-my-matches').classList.remove('hidden');
    } else {
        document.getElementById('tab-matches').classList.remove('hidden');
    }
}

// ======== MATCH ACTIONS ========
async function joinMatch(address) {
    const btn = document.getElementById('action-btn');
    if (btn) { btn.disabled=true; btn.textContent='Joining...'; }
    const c = document.getElementById('match-detail-content');
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        addMsg(c,'success','Joining match...');
        await (await escrow.joinMatch()).wait();
        addMsg(c,'success','‚úÖ Joined! Refreshing...');
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Failed to join: '+parseContractError(e));
        if(btn){btn.disabled=false;btn.textContent='Join Match';}
    }
}

async function depositToMatch(address) {
    const btn = document.getElementById('action-btn');
    if (btn){btn.disabled=true;btn.textContent='Processing...';}
    const c = document.getElementById('match-detail-content');
    try {
        const escrow   = new ethers.Contract(address, ESCROW_ABI, signer);
        const entryFee = await escrow.entryFee();
        const allowance= await w1tContract.allowance(userAddress, address);
        if (allowance < entryFee) {
            addMsg(c,'success','Step 1/2: Approving W1T...');
            await (await w1tContract.approve(address, entryFee)).wait();
            addMsg(c,'success','‚úÖ Approved!');
        } else {
            addMsg(c,'success','Already approved ‚Äî depositing...');
        }
        addMsg(c,'success','Step 2/2: Depositing...');
        await (await escrow.deposit()).wait();
        addMsg(c,'success','‚úÖ Deposited! Refreshing...');
        await loadBalance();
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Deposit failed: '+parseContractError(e));
        if(btn){btn.disabled=false;btn.textContent='Deposit';}
    }
}

async function checkInToMatch(address) {
    const btn = document.getElementById('action-btn');
    if (btn){btn.disabled=true;btn.textContent='Checking in...';}
    const c = document.getElementById('match-detail-content');
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        addMsg(c,'success','Submitting check-in...');
        await (await escrow.checkIn()).wait();
        addMsg(c,'success','‚úÖ Checked in! Good luck! üèÜ');
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Check-in failed: '+parseContractError(e));
        if(btn){btn.disabled=false;btn.textContent='Check In';}
    }
}

async function reportWin(address, winner) {
    const b1=document.getElementById('action-btn-p1');
    const b2=document.getElementById('action-btn-p2');
    if(b1)b1.disabled=true; if(b2)b2.disabled=true;
    const c = document.getElementById('match-detail-content');
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        addMsg(c,'success','Reporting outcome...');
        await (await escrow.reportOutcome(winner)).wait();
        const st = Number(await escrow.status());
        if (st === 5) { addMsg(c,'success','üèÜ Match settled! Prize paid to winner.'); globalStatsCache=null; }
        else          { addMsg(c,'success','‚úÖ Outcome reported! Waiting for opponent to confirm.'); }
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Report failed: '+parseContractError(e));
        if(b1)b1.disabled=false; if(b2)b2.disabled=false;
    }
}

// ======== HELPERS ========
function addMsg(container, type, message) {
    const d=document.createElement('div'); d.className=type; d.textContent=message; container.appendChild(d);
}

function parseContractError(e) {
    if (e.code===4001||e.message?.includes('user rejected')) return 'Transaction cancelled.';
    if (e.message?.includes('insufficient funds'))           return 'Insufficient funds.';
    if (e.message?.includes('Not open'))          return 'Match is no longer open.';
    if (e.message?.includes('Already deposited')) return 'You have already deposited.';
    if (e.message?.includes('Already joined'))    return 'This match already has an opponent.';
    if (e.message?.includes('No player2 yet'))    return 'Waiting for an opponent to join first.';
    if (e.message?.includes('Too late'))          return 'Deadline has passed for this action.';
    if (e.message?.includes('Too early'))         return 'Too early ‚Äî try again closer to match time.';
    if (e.message?.includes('Cannot play yourself')) return 'You cannot play against yourself.';
    const msg = e.reason || e.message || 'Unknown error';
    return msg.length > 120 ? msg.slice(0,120)+'‚Ä¶' : msg;
}

// ======== TABS ========
function refreshStats() { globalStatsCache=null; buildLeaderboard(); }

function showTab(tab, el) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    ['matches','create','my-matches','leaderboard','profile'].forEach(t=>{
        document.getElementById('tab-'+t).classList.add('hidden');
    });
    document.getElementById('match-detail').classList.add('hidden');
    document.getElementById('tab-'+tab).classList.remove('hidden');

    if (tab==='matches')     loadMatches();
    if (tab==='my-matches')  loadMyMatches();
    if (tab==='leaderboard') buildLeaderboard();
    if (tab==='profile') {
        ['profile-record','profile-winrate','profile-earnings'].forEach(id=>{
            document.getElementById(id).textContent='Loading...';
        });
        getPlayerStats(userAddress).then(s=>{
            document.getElementById('profile-username').textContent = '@'+(username||'Not set');
            document.getElementById('profile-record').textContent   = `${s.wins}-${s.losses}`;
            document.getElementById('profile-winrate').textContent  = calcWinRate(s)+'%';
            document.getElementById('profile-earnings').textContent = s.earnings.toFixed(2)+' '+CONFIG.TOKEN_SYMBOL;
            document.getElementById('profile-address').textContent  = userAddress.slice(0,10)+'...'+userAddress.slice(-8);
        }).catch(()=>{
            document.getElementById('profile-record').textContent   = '0-0';
            document.getElementById('profile-winrate').textContent  = '0%';
            document.getElementById('profile-earnings').textContent = '0 '+CONFIG.TOKEN_SYMBOL;
        });
    }
}

// ======== AUTO REFRESH ========
setInterval(()=>{
    if (userAddress && !document.getElementById('connected').classList.contains('hidden')) loadBalance();
}, 30000);
</script>
</body>
</html>
