<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>W1NNR - Compete. W1N. Earn.</title>

    <!-- ‚îÄ‚îÄ FAVICON + PWA ICONS ‚îÄ‚îÄ -->
    <link rel="icon" type="image/png" href="https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png">
    <link rel="apple-touch-icon" href="https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="W1NNR">
    <meta name="application-name" content="W1NNR">
    <meta name="theme-color" content="#080b14">
    <meta name="msapplication-TileColor" content="#080b14">
    <meta name="msapplication-TileImage" content="https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png">

    <link rel="manifest" id="pwa-manifest">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:      #080b14;
            --surface: #0f1422;
            --card:    #141926;
            --border:  rgba(255,255,255,0.07);
            --accent:  #00d4ff;
            --green:   #00ff88;
            --gold:    #ffd700;
            --orange:  #ff7b2c;
            --red:     #ff3b5c;
            --text:    #f0f2f8;
            --muted:   #6b7394;
            --muted2:  #98a0bf;
            --tab-h:   56px;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100dvh;
        }

        .topbar {
            position: fixed; top:0; left:0; right:0; z-index:100;
            height: var(--tab-h);
            background: rgba(8,11,20,0.92);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
        }
        .topbar-right { display:flex; gap:14px; align-items:center; }
        .live-pill {
            display: inline-flex; align-items:center; gap:5px;
            background: rgba(255,59,92,0.15);
            border: 1px solid rgba(255,59,92,0.4);
            border-radius: 20px; padding: 3px 10px;
            font-size: 11px; font-weight:700; letter-spacing:.5px;
            color: var(--red);
        }
        .live-dot {
            width:6px; height:6px; border-radius:50%;
            background: var(--red);
            animation: livePulse 1.2s ease-in-out infinite;
            box-shadow:0 0 6px rgba(255,59,92,0.8);
        }
        .notif-dot {
            position:absolute; top:-2px; right:-2px;
            width:8px; height:8px; border-radius:50%;
            background:var(--red); border:1.5px solid var(--bg);
        }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-top: calc(var(--tab-h) + 16px); }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 20px; margin: 16px 0; }
        .card-title { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 1.5px; margin-bottom: 16px; }

        .btn { width:100%; padding:15px; border:none; border-radius:14px; font-size:15px; font-weight:800; cursor:pointer; transition:all .18s ease; letter-spacing:.8px; text-transform:uppercase; font-family:'DM Sans',sans-serif; }
        .btn-primary   { background: linear-gradient(135deg, var(--accent), var(--green)); color: #000; }
        .btn-primary:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,212,255,0.35);  box-shadow:0 6px 20px rgba(0,212,255,0.25); }
        .btn-secondary { background: rgba(0,212,255,0.08); color: var(--accent); border: 1px solid rgba(0,212,255,0.25); }
        .btn-secondary:hover:not(:disabled) { background: rgba(0,212,255,0.15); }
        .btn-danger    { background: rgba(255,59,92,0.1); color: var(--red); border: 1px solid rgba(255,59,92,0.25); }
        .btn-instant   { background: linear-gradient(135deg, var(--orange), var(--gold)); color: #000; }
        .btn-instant:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 8px 24px rgba(255,123,44,0.35); }
        .btn:disabled  { opacity:.4; cursor:not-allowed; transform:none !important; }

        .input { width:100%; padding:13px 14px; border: 1px solid var(--border); border-radius:12px; background: var(--surface); color: var(--text); font-size:15px; font-family:'DM Sans',sans-serif; margin: 8px 0; transition:.2s; }
        .input:focus { outline:none; border-color:rgba(0,212,255,0.4); background:rgba(0,212,255,0.04); }
        .label { display:block; color:var(--muted); font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; margin:16px 0 4px; }

        .balance { display:flex; justify-content:space-between; align-items:center; padding:11px 0; border-bottom:1px solid var(--border); }
        .balance:last-child { border-bottom:none; }
        .balance-label { color:var(--muted); font-size:13px; font-weight:600; }
        .balance-value { font-weight:700; font-size:15px; color:var(--green); }

        .status-badge { display:inline-flex; align-items:center; gap:4px; padding:4px 11px; border-radius:10px; font-size:11px; font-weight:800; letter-spacing:.6px; text-transform:uppercase; }
        .status-open       { background:rgba(0,212,255,0.12);  color:var(--accent); }
        .status-funded     { background:rgba(255,165,0,0.12);  color:#ffa500; }
        .status-settled    { background:rgba(0,255,136,0.12);  color:var(--green); }
        .status-inprogress { background:rgba(138,43,226,0.12); color:#8a2be2; }
        .status-reported   { background:rgba(255,215,0,0.12);  color:var(--gold); }
        .status-disputed   { background:rgba(255,68,68,0.12);  color:var(--red); }
        .status-cancelled, .status-expired, .status-noshow { background:rgba(150,150,150,0.1); color:var(--muted); }
        .status-instant    { background:rgba(255,123,44,0.15); color:var(--orange); }

        .info-box { padding:12px 16px; border-radius:12px; font-size:13px; margin:12px 0; line-height:1.6;  transition:border-color .15s; }
        .info-blue   { background:rgba(0,212,255,0.07);  border-left:3px solid var(--accent); color:rgba(240,242,248,0.7); }
        .info-orange { background:rgba(255,165,0,0.07);  border-left:3px solid #ffa500;        color:rgba(240,242,248,0.7); }
        .info-green  { background:rgba(0,255,136,0.07);  border-left:3px solid var(--green);   color:rgba(240,242,248,0.7); }
        .info-purple { background:rgba(138,43,226,0.07); border-left:3px solid #8a2be2;        color:rgba(240,242,248,0.7); }
        .info-yellow { background:rgba(255,215,0,0.07);  border-left:3px solid var(--gold);    color:rgba(240,242,248,0.7); }
        .info-red    { background:rgba(255,59,92,0.07);  border-left:3px solid var(--red);     color:rgba(240,242,248,0.7); }
        .info-gray   { background:rgba(150,150,150,0.07);border-left:3px solid var(--muted);   color:rgba(240,242,248,0.7); }
        .info-instant{ background:rgba(255,123,44,0.07); border-left:3px solid var(--orange);  color:rgba(240,242,248,0.7); }

        .error   { background:rgba(255,59,92,0.1);  color:var(--red);   padding:12px; border-radius:10px; margin:10px 0; font-size:14px; }
        .success { background:rgba(0,255,136,0.1);  color:var(--green); padding:12px; border-radius:10px; margin:10px 0; font-size:14px; }
        .loading { text-align:center; padding:40px; color:var(--muted); font-size:14px; }

        .tabs { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin:14px 0; }
        .tab {
            padding:10px 4px 9px;
            background:var(--surface);
            border:1.5px solid var(--border);
            border-radius:14px;
            text-align:center;
            cursor:pointer;
            font-size:11.5px;
            font-weight:800;
            transition:all .18s ease;
            color:var(--muted);
            letter-spacing:.2px;
            text-transform:uppercase;
            position:relative;
            overflow:hidden;
        }
        .tab::before {
            content:'';
            position:absolute; inset:0;
            background:linear-gradient(135deg,rgba(0,212,255,0.06),rgba(0,255,136,0.03));
            opacity:0;
            transition:opacity .18s;
        }
        .tab:hover { border-color:rgba(0,212,255,0.2); color:rgba(240,242,248,0.8); }
        .tab:hover::before { opacity:1; }
        .tab.active {
            background:rgba(0,212,255,0.12);
            border-color:rgba(0,212,255,0.45);
            color:var(--accent);
            box-shadow:0 0 12px rgba(0,212,255,0.15), inset 0 1px 0 rgba(0,212,255,0.2);
        }
        .tab.active::before { opacity:1; }
        .tab:hover:not(.active) { border-color:rgba(255,255,255,0.12); color:var(--text); }
        /* tab responsive: handled in base grid */

        .match-item { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding:14px 16px; margin:10px 0; cursor:pointer; transition:.2s; }
        .match-item:hover { border-color:rgba(0,212,255,0.25); transform:translateY(-1px); }
        .match-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .match-fee { color:var(--green); font-weight:800; font-size:20px; font-family:'Bebas Neue',sans-serif; letter-spacing:1.5px; text-shadow:0 0 12px rgba(0,255,136,0.35); }
        .match-details { display:flex; gap:12px; align-items:center; color:var(--muted); font-size:12px; flex-wrap:wrap; }

        .match-type-toggle { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:16px 0; }
        .type-btn {
            padding:18px 12px;
            border-radius:16px;
            border:2px solid var(--border);
            background:var(--surface);
            cursor:pointer;
            text-align:center;
            transition:all .15s ease;
            position:relative;
            overflow:hidden;
        }
        .type-btn:hover { border-color:rgba(255,255,255,0.2); background:rgba(255,255,255,0.04); }
        .type-btn.active-instant { border-color:var(--orange); background:rgba(255,123,44,0.1); box-shadow:0 0 16px rgba(255,123,44,0.18), inset 0 1px 0 rgba(255,123,44,0.15); }
        .type-btn.active-scheduled { border-color:var(--accent); background:rgba(0,212,255,0.1); box-shadow:0 0 16px rgba(0,212,255,0.18), inset 0 1px 0 rgba(0,212,255,0.15); }
        .type-btn:hover { border-color:rgba(255,255,255,0.2); }
        .type-btn-icon { font-size:32px; margin-bottom:6px; }
        .type-btn-label { font-family:'Bebas Neue',sans-serif; font-size:16px; letter-spacing:1px; }
        .type-btn-sub { font-size:11px; color:var(--muted); margin-top:3px; }

        /* ‚îÄ‚îÄ SPORT PICKER ‚îÄ‚îÄ */
        .sport-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin:10px 0; }
        .sport-btn {
            padding:13px 6px 11px;
            border-radius:14px;
            border:1.5px solid var(--border);
            background:var(--surface);
            cursor:pointer;
            text-align:center;
            transition:all .15s ease;
            font-size:10px;
            font-weight:800;
            color:rgba(240,242,248,0.45);
            letter-spacing:.5px;
            text-transform:uppercase;
            position:relative;
            overflow:hidden;
        }
        .sport-btn::after {
            content:'';
            position:absolute;
            inset:0;
            background:linear-gradient(135deg,rgba(0,212,255,0.0),rgba(0,255,136,0.0));
            transition:all .15s ease;
        }
        .sport-btn-icon { font-size:24px; display:block; margin-bottom:5px; line-height:1; }
        .sport-btn.selected {
            border-color:rgba(0,212,255,0.6);
            background:rgba(0,212,255,0.12);
            color:var(--accent);
            box-shadow:0 0 14px rgba(0,212,255,0.2), inset 0 1px 0 rgba(0,212,255,0.25);
        }
        .sport-btn:hover:not(.selected) {
            border-color:rgba(255,255,255,0.2);
            color:rgba(240,242,248,0.8);
            background:rgba(255,255,255,0.04);
        }

        /* ‚îÄ‚îÄ SPORT FILTER (open matches tab) ‚îÄ‚îÄ */
        .sport-filter-wrap { position:relative; }
        .sport-filter-wrap::after {
            content:'';
            position:absolute;
            right:0; top:0; bottom:8px;
            width:40px;
            background:linear-gradient(to right, transparent, var(--bg));
            pointer-events:none;
            z-index:1;
        }
        .sport-filter { display:flex; gap:8px; overflow-x:auto; padding-bottom:8px; padding-top:2px; margin-bottom:14px; scrollbar-width:none; }
        .sport-filter::-webkit-scrollbar { display:none; }
        .sport-filter-btn {
            flex-shrink:0;
            padding:8px 16px;
            border-radius:22px;
            border:1.5px solid var(--border);
            background:var(--surface);
            cursor:pointer;
            font-size:12px;
            font-weight:800;
            color:rgba(240,242,248,0.55);
            white-space:nowrap;
            transition:all .15s ease;
            letter-spacing:.4px;
            position:relative;
        }
        .sport-filter-btn:hover {
            border-color:rgba(0,212,255,0.25);
            color:rgba(240,242,248,0.85);
            background:rgba(255,255,255,0.04);
        }
        .sport-filter-btn.active {
            background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(0,255,136,0.08));
            border-color:rgba(0,212,255,0.5);
            color:#00d4ff;
            box-shadow:0 0 10px rgba(0,212,255,0.15);
        }

        .avatar { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-family:'Bebas Neue',sans-serif; font-size:16px; color:#000; flex-shrink:0; position:relative; overflow:hidden; }
        .avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
        .avatar-sm  { width:32px; height:32px; font-size:13px; }
        .avatar-lg  { width:64px; height:64px; font-size:26px; }
        .avatar-xl  { width:80px; height:80px; font-size:32px; border:3px solid var(--bg); }
        .accent-ring { box-shadow:0 0 0 2px var(--accent); }
        .green-ring  { box-shadow:0 0 0 2px var(--green); }
        .gold-ring   { box-shadow:0 0 0 2px var(--gold); }

        .player-chip { display:flex; align-items:center; gap:10px; }
        .player-chip-name { font-weight:700; font-size:14px; line-height:1.2; }
        .player-chip-sub  { font-size:11px; color:var(--muted); margin-top:1px; }

        .profile-hero { position:relative; border-radius:18px; overflow:hidden; background:linear-gradient(135deg,#0a1520,#0a1210); border:1px solid var(--border); margin-bottom:0; }
        .profile-hero-bg { height:110px; background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(0,255,136,0.1)); position:relative; overflow:hidden; }
        .profile-hero-pattern { position:absolute; inset:0; opacity:.5; background-image: repeating-linear-gradient(45deg,transparent,transparent 20px,rgba(0,212,255,0.03) 20px,rgba(0,212,255,0.03) 21px); }
        .profile-hero-lines::before { content:''; position:absolute; top:-50%; right:-5%; width:1px; height:200%; background:linear-gradient(180deg,transparent,rgba(0,212,255,0.25),transparent); transform:rotate(-15deg); }
        .profile-avatar-wrap { padding:0 20px 20px; margin-top:-36px; position:relative; z-index:2; }
        .profile-info-row { display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
        .profile-name   { font-family:'Bebas Neue',sans-serif; font-size:26px; letter-spacing:1px; line-height:1; }
        .profile-handle { font-size:13px; color:var(--muted); margin-top:3px; }
        .profile-bio    { font-size:13px; color:rgba(255,255,255,0.55); margin-top:10px; line-height:1.5; padding:0 20px; }

        .profile-stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:1px; background:var(--border); border-radius:14px; overflow:hidden; margin:16px 20px; }
        .profile-stat {
            background:var(--surface);
            padding:14px 6px;
            text-align:center;
            border:1px solid var(--border);
            transition:border-color .15s;
        }
        .profile-stat:hover { border-color:rgba(0,212,255,0.2); }
        .profile-stat-val { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:1px; color:var(--green); }
        .profile-stat-lbl { font-size:9px; color:var(--muted); font-weight:700; letter-spacing:.5px; text-transform:uppercase; margin-top:2px; }

        .matchup-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:16px; margin:12px 0; display:flex; align-items:center; gap:12px; }
        .matchup-player { flex:1; }
        .matchup-player.right { text-align:right; align-items:flex-end; display:flex; flex-direction:column; }
        .matchup-vs { font-family:'Bebas Neue',sans-serif; font-size:18px; letter-spacing:2px; color:var(--muted); flex-shrink:0; padding:0 4px; }
        .matchup-stat { font-size:11px; color:var(--muted); margin-top:2px; }

        .rank-badge { display:inline-flex; align-items:center; gap:3px; padding:2px 7px; border-radius:6px; font-size:10px; font-weight:800; letter-spacing:.5px; }
        .rank-elite  { background:rgba(255,215,0,0.12);  color:var(--gold);   border:1px solid rgba(255,215,0,0.25); }
        .rank-gold   { background:rgba(255,123,44,0.12); color:var(--orange); border:1px solid rgba(255,123,44,0.25); }
        .rank-silver { background:rgba(192,192,192,0.1); color:#c0c0c0;       border:1px solid rgba(192,192,192,0.25); }
        .rank-bronze { background:rgba(205,127,50,0.1);  color:#cd7f32;       border:1px solid rgba(205,127,50,0.25); }

        .waiting-banner { background:rgba(255,165,0,0.06); border:1px dashed rgba(255,165,0,0.35); border-radius:14px; padding:22px; text-align:center; margin:14px 0; }
        .instant-banner { background:rgba(255,123,44,0.08); border:1px solid rgba(255,123,44,0.3); border-radius:14px; padding:16px; text-align:center; margin:14px 0; }

        #first-time-banner { background:linear-gradient(135deg,rgba(0,212,255,0.12),rgba(0,255,136,0.08)); border:1px solid rgba(0,212,255,0.2); border-radius:18px; padding:20px; margin:16px 0; }

        .lb-row { display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--border); }
        .lb-row:last-child { border-bottom:none; }
        .lb-rank { font-family:'Bebas Neue',sans-serif; font-size:26px; width:38px; flex-shrink:0; text-align:center; }

        .settle-glow { animation: settlePulse 1.2s ease-in-out 3; }

        .qr-modal { position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; }
        .qr-modal-inner { width:100%; max-width:360px; }
        .qr-viewfinder { position:relative; width:100%; aspect-ratio:1; border-radius:18px; overflow:hidden; background:#000; }
        .qr-viewfinder video { width:100%; height:100%; object-fit:cover; }
        .qr-corner { position:absolute; width:28px; height:28px; border-color:var(--accent); border-style:solid; border-width:0; }
        .qr-corner.tl { top:12px;  left:12px;  border-top-width:3px;    border-left-width:3px;   border-radius:4px 0 0 0; }
        .qr-corner.tr { top:12px;  right:12px; border-top-width:3px;    border-right-width:3px;  border-radius:0 4px 0 0; }
        .qr-corner.bl { bottom:12px; left:12px;  border-bottom-width:3px; border-left-width:3px;   border-radius:0 0 0 4px; }
        .qr-corner.br { bottom:12px; right:12px; border-bottom-width:3px; border-right-width:3px;  border-radius:0 0 4px 0; }
        .qr-scan-line { position:absolute; left:16px; right:16px; height:2px; background:linear-gradient(90deg,transparent,var(--accent),transparent); animation:qrScan 2s ease-in-out infinite; }
        @keyframes qrScan { 0%{top:16px;opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{top:calc(100% - 16px);opacity:0;} }
        @keyframes settlePulse { 0%,100%{box-shadow:0 0 0 rgba(0,255,136,0);}50%{box-shadow:0 0 24px rgba(0,255,136,0.5);} }
        .live-dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:var(--red); animation:livePulse 1.2s ease-in-out infinite; margin-right:5px; }
        @keyframes livePulse { 0%,100%{opacity:1;transform:scale(1);}50%{opacity:.4;transform:scale(0.8);} }
        @keyframes challengeSlideIn { from{opacity:0;transform:translateY(-16px) scale(0.97);}to{opacity:1;transform:translateY(0) scale(1);} }
        .challenge-alert-inner { animation: challengeSlideIn 0.35s cubic-bezier(0.34,1.56,0.64,1) forwards; }

        #outcome-popup { position:fixed; inset:0; z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; background:rgba(0,0,0,0); pointer-events:none; transition:background .4s; }
        #outcome-popup.show { background:rgba(0,0,0,0.88); pointer-events:all; }
        #outcome-popup-inner { width:100%; max-width:340px; text-align:center; opacity:0; transform:scale(0.8) translateY(30px); transition: opacity .4s cubic-bezier(0.34,1.56,0.64,1), transform .4s cubic-bezier(0.34,1.56,0.64,1); }
        #outcome-popup.show #outcome-popup-inner { opacity:1; transform:scale(1) translateY(0); }
        @keyframes popupParticle { 0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0);} }
        .popup-particle { position:absolute; font-size:20px; pointer-events:none; animation: popupParticle 1.2s ease-out forwards; }
        @keyframes countUp { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
        .count-up { animation: countUp 0.3s ease-out forwards; }
        @keyframes balanceTick { 0%{transform:translateY(0);opacity:1;}50%{transform:translateY(-4px);opacity:.5;}100%{transform:translateY(0);opacity:1;} }
        .balance-ticking { animation: balanceTick 0.12s ease-in-out; }
        .noob-hint { display:flex; align-items:flex-start; gap:10px; background:rgba(0,212,255,0.05); border:1px solid rgba(0,212,255,0.15); border-radius:12px; padding:11px 14px; margin-top:12px; font-size:12px; color:rgba(240,242,248,0.6); line-height:1.5; }
        .noob-hint-icon { font-size:16px; flex-shrink:0; margin-top:1px; }
        .hidden { display:none !important; }
        /* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ */
        .onboard-dot-active { background: var(--accent) !important; }
        .sport-card-selected { border-color: rgba(0,212,255,0.5) !important; background: rgba(0,212,255,0.08) !important; }
        @keyframes bounceIn { 0%{transform:scale(0.3);opacity:0} 50%{transform:scale(1.1)} 100%{transform:scale(1);opacity:1} }
    </style>
</head>
<body>

<div class="topbar">
    <a href="https://w1nnr-app.github.io/W1NNR/home.html" style="text-decoration:none;display:flex;align-items:center;">
        <img src="https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png" alt="W1NNR"
             style="height:150px;width:150px;object-fit:contain;"
             onerror="this.parentElement.innerHTML='<span style=\'font-family:Bebas Neue,sans-serif;font-size:28px;letter-spacing:3px;background:linear-gradient(135deg,#00d4ff,#00ff88);-webkit-background-clip:text;-webkit-text-fill-color:transparent;\'>W1NNR</span>';">
    </a>
    <div class="topbar-right">
        <div class="live-pill" id="topbar-live-pill"><div class="live-dot"></div>LIVE</div>
        <div style="position:relative;font-size:20px;cursor:pointer;opacity:.7;">üîî<div class="notif-dot"></div></div>
    </div>
</div>

<div class="container">

    <!-- NOT CONNECTED -->
    <div id="not-connected">
        <div class="card">
            <div class="card-title">üèÜ Compete for Real Stakes</div>
            <p style="color:var(--muted);margin-bottom:16px;line-height:1.7;font-size:14px;">
                W1NNR lets you compete against other players in golf, tennis, and more ‚Äî with real money on the line, settled on-chain.
            </p>
            <div class="info-box info-blue" style="margin:16px 0;">
                <strong style="color:var(--accent);">How it works:</strong><br>
                1Ô∏è‚É£ Create or join a match<br>
                2Ô∏è‚É£ Both players deposit stakes<br>
                3Ô∏è‚É£ Play your match<br>
                4Ô∏è‚É£ Report the W1NNR<br>
                5Ô∏è‚É£ <strong style="color:var(--green);">Players keep 100% of their winnings üí∞</strong><br>
                <span style="color:var(--muted);font-size:12px;margin-top:6px;display:block;">8% platform tournament hosting fee ¬∑ Settled trustlessly on-chain</span>
            </div>
            <div class="info-box info-orange" style="margin:16px 0;">
                <strong style="color:#ffa500;">‚ö†Ô∏è You'll need:</strong><br>
                ‚Ä¢ MetaMask wallet (or compatible)<br>
                ‚Ä¢ PulseChain network added <span style="font-size:11px;">(see below)</span><br>
                ‚Ä¢ Some W1N tokens for testing
            </div>
            <div class="info-box info-gray" style="margin:16px 0;">
                <strong style="color:var(--text);">üîß First time on PulseChain?</strong><br>
                PulseChain isn't in MetaMask by default ‚Äî add it in one click:<br><br>
                <a href="https://chainlist.org/chain/369" target="_blank"
                   style="display:inline-block;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-weight:800;font-size:13px;padding:8px 16px;border-radius:10px;text-decoration:none;letter-spacing:.5px;margin-bottom:10px;">
                   ‚ö° Add PulseChain via Chainlist ‚Üí
                </a><br>
                <span style="font-size:11px;opacity:.7;">Or add manually: RPC <strong style="color:var(--text);">https://rpc.pulsechain.com</strong> ¬∑ Chain ID <strong style="color:var(--text);">369</strong> ¬∑ Symbol <strong style="color:var(--text);">PLS</strong></span>
            </div>
            <button class="btn btn-primary" onclick="showAgeGate()" style="margin-top:16px;font-size:16px;letter-spacing:1.5px;padding:16px;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;box-shadow:0 0 24px rgba(0,212,255,0.3);">‚ö° Connect Wallet to Start</button>
            <p style="color:var(--muted);font-size:11px;margin-top:14px;text-align:center;opacity:.7;">Your wallet. Your stakes. Your glory.</p>
        </div>
    </div>

    <!-- CONNECTED -->
    <div id="connected" class="hidden">

        <div id="first-time-banner">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div style="flex:1;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;margin-bottom:8px;">üëã Welcome to W1NNR!</div>
                    <p style="color:var(--muted);font-size:13px;line-height:1.6;margin-bottom:8px;">
                        <strong style="color:var(--text);">Quick Start:</strong> Hit <strong style="color:var(--orange);">‚ö° Play Now</strong> to challenge someone instantly, or browse <strong style="color:var(--accent);">Matches</strong> to join one.
                    </p>
                    <p style="color:var(--muted);font-size:12px;">üí° Set a username in <strong style="color:var(--text);">Profile</strong> so opponents know who they're fighting!</p>
                </div>
                <button onclick="dismissFirstTimeBanner()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:22px;padding:0 0 0 12px;line-height:1;">√ó</button>
            </div>
        </div>

        <div id="challenge-alert" class="hidden"></div>

        <!-- Wallet strip -->
        <div class="card" style="padding:14px 16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div class="player-chip" id="wallet-chip">
                    <div class="avatar accent-ring" id="header-avatar" style="background:linear-gradient(135deg,var(--accent),var(--green));"></div>
                    <div>
                        <div style="font-weight:700;font-size:14px;" id="wallet-address">Connecting...</div>
                        <div style="font-size:11px;color:var(--muted);font-weight:600;letter-spacing:.3px;">W1N BALANCE</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div id="w1n-balance" style="font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:1.5px;line-height:1;transition:all .4s;text-shadow:0 0 16px rgba(0,255,136,0.3);">‚Äî W1N</div>
                    <div id="w1n-balance-status" style="font-size:10px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;margin-top:2px;"></div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active"  onclick="showTab('matches',    this)"><div style="font-size:16px;margin-bottom:3px;">‚ö°</div>Matches</div>
            <div class="tab"         onclick="showTab('create',     this)"><div style="font-size:16px;margin-bottom:3px;">‚ûï</div>Create</div>
            <div class="tab"         onclick="showTab('my-matches', this)"><div style="font-size:16px;margin-bottom:3px;">üéØ</div>Mine</div>
            <div class="tab"         onclick="showTab('leaderboard',this)"><div style="font-size:16px;margin-bottom:3px;">ü•á</div>Leaders</div>
            <div class="tab"         onclick="showTab('profile',    this)"><div style="font-size:16px;margin-bottom:3px;">üë§</div>Profile</div>
            <div class="tab"         onclick="showTab('tournaments', this)"><div style="font-size:16px;margin-bottom:3px;">üèÜ</div>Events</div>
        </div>

        <!-- TAB: OPEN MATCHES -->
        <div id="tab-matches">
            <div class="card">
                <div class="card-title">Open Matches</div>
                <!-- Sport filter row -->
                <div class="sport-filter" id="sport-filter-row">
                    <button class="sport-filter-btn active" data-sport="0" onclick="setSportFilter(0,this)">üèÜ All</button>
                    <button class="sport-filter-btn" data-sport="1" onclick="setSportFilter(1,this)">‚öΩ Soccer</button>
                    <button class="sport-filter-btn" data-sport="2" onclick="setSportFilter(2,this)">üèÄ Basketball</button>
                    <button class="sport-filter-btn" data-sport="3" onclick="setSportFilter(3,this)">üéæ Tennis</button>
                    <button class="sport-filter-btn" data-sport="4" onclick="setSportFilter(4,this)">‚õ≥ Golf</button>
                    <button class="sport-filter-btn" data-sport="5" onclick="setSportFilter(5,this)">üèà Football</button>
                    <button class="sport-filter-btn" data-sport="6" onclick="setSportFilter(6,this)">‚öæ Baseball</button>
                    <button class="sport-filter-btn" data-sport="7" onclick="setSportFilter(7,this)">ü•ä Boxing/MMA</button>
                    <button class="sport-filter-btn" data-sport="8" onclick="setSportFilter(8,this)">üè∏ Pickleball</button>
                    <button class="sport-filter-btn" data-sport="9" onclick="setSportFilter(9,this)">üèê Volleyball</button>
                    <button class="sport-filter-btn" data-sport="10" onclick="setSportFilter(10,this)">üèí Hockey</button>
                    <button class="sport-filter-btn" data-sport="11" onclick="setSportFilter(11,this)">üèñÔ∏è Beach Volleyball</button>
                    <button class="sport-filter-btn" data-sport="12" onclick="setSportFilter(12,this)">üèì Ping Pong</button>
                    <button class="sport-filter-btn" data-sport="999" onclick="setSportFilter(999,this)">üéØ Custom</button>
                </div>
                <button class="btn btn-secondary" onclick="loadMatches()" style="margin-bottom:14px;">‚Üª Refresh</button>
                <div id="matches-list"><div class="loading">Loading matches...</div></div>
            </div>
        </div>

        <!-- TAB: CREATE -->
        <div id="tab-create" class="hidden">
            <div class="card">
                <div class="card-title">Create a Match</div>

                <div class="match-type-toggle">
                    <div class="type-btn active-instant" id="type-instant" onclick="setMatchType('instant')">
                        <div class="type-btn-icon">‚ö°</div>
                        <div class="type-btn-label" style="color:var(--orange);">Play Now</div>
                        <div class="type-btn-sub">Goes live instantly</div>
                    </div>
                    <div class="type-btn" id="type-scheduled" onclick="setMatchType('scheduled')">
                        <div class="type-btn-icon">üìÖ</div>
                        <div class="type-btn-label" style="color:var(--accent);">Schedule</div>
                        <div class="type-btn-sub">Pick a date & time</div>
                    </div>
                </div>

                <div id="instant-info" class="info-box info-instant">
                    <strong style="color:var(--orange);">‚ö° Instant Match:</strong> Creates a match that goes live the moment both players deposit. Perfect for live demos!
                </div>
                <div id="scheduled-info" class="info-box info-blue hidden">
                    <strong style="color:var(--accent);">üìÖ Scheduled Match:</strong> Set a future date and time. Both players must check in at match time to confirm.
                </div>

                <!-- Sport Picker -->
                <label class="label">Sport / Competition</label>
                <div class="sport-grid">
                    <div class="sport-btn selected" data-sport-id="1" onclick="selectSport(1,this)">
                        <span class="sport-btn-icon">‚öΩ</span>Soccer
                    </div>
                    <div class="sport-btn" data-sport-id="2" onclick="selectSport(2,this)">
                        <span class="sport-btn-icon">üèÄ</span>Basketball
                    </div>
                    <div class="sport-btn" data-sport-id="3" onclick="selectSport(3,this)">
                        <span class="sport-btn-icon">üéæ</span>Tennis
                    </div>
                    <div class="sport-btn" data-sport-id="4" onclick="selectSport(4,this)">
                        <span class="sport-btn-icon">‚õ≥</span>Golf
                    </div>
                    <div class="sport-btn" data-sport-id="5" onclick="selectSport(5,this)">
                        <span class="sport-btn-icon">üèà</span>Football
                    </div>
                    <div class="sport-btn" data-sport-id="6" onclick="selectSport(6,this)">
                        <span class="sport-btn-icon">‚öæ</span>Baseball
                    </div>
                    <div class="sport-btn" data-sport-id="7" onclick="selectSport(7,this)">
                        <span class="sport-btn-icon">ü•ä</span>Boxing/MMA
                    </div>
                    <div class="sport-btn" data-sport-id="8" onclick="selectSport(8,this)">
                        <span class="sport-btn-icon">üè∏</span>Pickleball
                    </div>
                    <div class="sport-btn" data-sport-id="9" onclick="selectSport(9,this)">
                        <span class="sport-btn-icon">üèê</span>Volleyball
                    </div>
                    <div class="sport-btn" data-sport-id="10" onclick="selectSport(10,this)">
                        <span class="sport-btn-icon">üèí</span>Hockey
                    </div>
                    <div class="sport-btn" data-sport-id="11" onclick="selectSport(11,this)">
                        <span class="sport-btn-icon">üèñÔ∏è</span>Beach VB
                    </div>
                    <div class="sport-btn" data-sport-id="12" onclick="selectSport(12,this)">
                        <span class="sport-btn-icon">üèì</span>Ping Pong
                    </div>
                </div>
                <div id="selected-sport-display" style="font-size:12px;color:var(--accent);font-weight:700;margin-top:4px;">‚öΩ Soccer selected</div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;">
                    <label class="label" style="margin:0;">Opponent address (optional)</label>
                    <span style="font-size:11px;color:var(--orange);font-weight:700;letter-spacing:.5px;">üì∑ SCAN TO CHALLENGE</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="text" class="input" id="create-opponent" placeholder="0x... or leave blank for open match" style="margin:8px 0;flex:1;">
                    <button onclick="openQrScanner('create-opponent')" style="flex-shrink:0;width:48px;height:48px;border-radius:12px;border:1px solid rgba(255,123,44,0.4);background:rgba(255,123,44,0.12);cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 0 12px rgba(255,123,44,0.2);" title="Scan Opponent QR Code">üì∑</button>
                </div>

                <label class="label">Entry Fee (W1N)</label>
                <input type="number" class="input" id="create-fee" placeholder="50" value="50" min="10" step="1">
                <p style="color:var(--muted);font-size:12px;margin-top:2px;">Minimum 10 W1N ¬∑ W1NNR gets 92% of total pot</p>

                <div id="scheduled-time-section" class="hidden">
                    <label class="label">Scheduled Time</label>
                    <input type="datetime-local" class="input" id="create-time">
                    <p style="color:var(--muted);font-size:12px;margin-top:2px;">Must be at least 5 minutes from now</p>
                </div>

                <div id="create-error"   class="error   hidden"></div>
                <div id="create-success" class="success hidden"></div>
                <button class="btn btn-instant" id="create-btn" onclick="createMatch()" style="margin-top:18px;">‚ö° Create Instant Match</button>
            </div>
        </div>

        <!-- TAB: MY MATCHES -->
        <div id="tab-my-matches" class="hidden">
            <div class="card">
                <div class="card-title">My Matches</div>
                <button class="btn btn-secondary" onclick="loadMyMatches()" style="margin-bottom:14px;">‚Üª Refresh</button>
                <div id="my-matches-list"><div class="loading">Loading your matches...</div></div>
            </div>
        </div>

        <!-- TAB: LEADERBOARD -->
        <div id="tab-leaderboard" class="hidden">
            <div class="card">
                <div class="card-title">üèÜ Leaderboard</div>
                <p style="color:var(--muted);margin-bottom:14px;font-size:13px;">Top competitors ranked by W1Ns on PulseChain</p>
                <button class="btn btn-secondary" onclick="refreshStats()" style="margin-bottom:14px;">‚Üª Refresh Stats</button>
                <div id="leaderboard-list"><div class="loading">Loading leaderboard...</div></div>
            </div>
        </div>

        <!-- TAB: PROFILE -->
        <div id="tab-profile" class="hidden">
            <div class="card" style="padding:0;overflow:hidden;">
                <div class="profile-hero">
                    <div class="profile-hero-bg">
                        <div class="profile-hero-pattern"></div>
                        <div class="profile-hero-lines"></div>
                    </div>
                    <div class="profile-avatar-wrap">
                        <div class="profile-info-row">
                            <div>
                                <div class="avatar avatar-xl gold-ring" id="profile-avatar-big" style="background:linear-gradient(135deg,var(--accent),var(--green));font-family:'Bebas Neue',sans-serif;font-size:30px;color:#000;"></div>
                            </div>
                            <div style="padding-bottom:4px;">
                                <span class="rank-badge rank-gold" id="profile-rank-badge">GOLD</span>
                            </div>
                        </div>
                        <div style="margin-top:10px;">
                            <div class="profile-name" id="profile-name-display">‚Äî</div>
                            <div class="profile-handle" id="profile-handle-display">@username</div>
                        </div>
                    </div>
                    <div class="profile-bio" id="profile-bio-display" style="padding-bottom:16px;font-size:12px;">Nashville's finest competitor. Settling scores on-chain.</div>
                </div>
            </div>
            <div class="profile-stats-grid">
                <div class="profile-stat"><div class="profile-stat-val" id="profile-total-matches">0</div><div class="profile-stat-lbl">Matches</div></div>
                <div class="profile-stat"><div class="profile-stat-val" id="profile-wins">0</div><div class="profile-stat-lbl">W1Ns</div></div>
                <div class="profile-stat"><div class="profile-stat-val" id="profile-winrate">0%</div><div class="profile-stat-lbl">W1N Rate</div></div>
                <div class="profile-stat"><div class="profile-stat-val" id="profile-earnings">0</div><div class="profile-stat-lbl">W1N Earned</div></div>
            </div>
            <div class="card" style="margin-top:0;">
                <div class="balance"><span class="balance-label">Wallet</span><span class="balance-value" style="font-size:13px;font-family:monospace;" id="profile-address">0x...</span></div>
                <div class="balance"><span class="balance-label">Record</span><span class="balance-value" id="profile-record">0-0</span></div>
                <div class="balance"><span class="balance-label">W1N Earned</span><span class="balance-value" id="profile-earnings-2">0 W1N</span></div>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:16px;">
                <button class="btn btn-primary"   onclick="changeUsername()" style="flex:1;">‚úèÔ∏è Edit Username</button>
                <button class="btn btn-secondary" onclick="editBio()"        style="flex:1;">üìù Edit Bio</button>
            </div>
            <div style="padding:10px 0;border-top:1px solid var(--border);">
                <p style="color:var(--muted);font-size:11px;text-align:center;line-height:1.6;">Stats auto-update from settled matches on PulseChain every 60s</p>
            </div>
        </div>


        <!-- TAB: TOURNAMENTS -->
        <div id="tab-tournaments" class="hidden">

            <!-- Sub-tabs: Browse / Create / My Tournaments -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:0 0 16px;">
                <button id="tsub-browse"  onclick="setTournamentSub('browse')"
                    style="padding:10px;border-radius:12px;border:1px solid rgba(0,212,255,0.35);background:rgba(0,212,255,0.1);color:var(--accent);font-weight:700;font-size:12px;cursor:pointer;transition:.2s;letter-spacing:0px;">
                    üîç Browse
                </button>
                <button id="tsub-create"  onclick="setTournamentSub('create')"
                    style="padding:10px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-weight:700;font-size:12px;cursor:pointer;transition:.2s;letter-spacing:0px;">
                    ‚ûï Create
                </button>
                <button id="tsub-mine"    onclick="setTournamentSub('mine')"
                    style="padding:10px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-weight:700;font-size:12px;cursor:pointer;transition:.2s;letter-spacing:0px;">
                    üéØ Mine
                </button>
            </div>

            <!-- BROWSE -->
            <div id="tsub-browse-panel">
                <div class="card">
                    <div class="card-title">üèÜ Open Tournaments</div>
                    <div class="sport-filter" id="t-sport-filter-row">
                        <button class="sport-filter-btn active" data-sport="0" onclick="setTournamentSportFilter(0,this)">üèÜ All</button>
                        <button class="sport-filter-btn" data-sport="1"   onclick="setTournamentSportFilter(1,this)">‚öΩ Soccer</button>
                        <button class="sport-filter-btn" data-sport="2"   onclick="setTournamentSportFilter(2,this)">üèÄ Basketball</button>
                        <button class="sport-filter-btn" data-sport="3"   onclick="setTournamentSportFilter(3,this)">üéæ Tennis</button>
                        <button class="sport-filter-btn" data-sport="4"   onclick="setTournamentSportFilter(4,this)">‚õ≥ Golf</button>
                        <button class="sport-filter-btn" data-sport="5"   onclick="setTournamentSportFilter(5,this)">üèà Football</button>
                        <button class="sport-filter-btn" data-sport="6"   onclick="setTournamentSportFilter(6,this)">‚öæ Baseball</button>
                        <button class="sport-filter-btn" data-sport="7"   onclick="setTournamentSportFilter(7,this)">ü•ä Boxing</button>
                        <button class="sport-filter-btn" data-sport="8"   onclick="setTournamentSportFilter(8,this)">üè∏ Pickleball</button>
                        <button class="sport-filter-btn" data-sport="9"   onclick="setTournamentSportFilter(9,this)">üèê Volleyball</button>
                        <button class="sport-filter-btn" data-sport="10"  onclick="setTournamentSportFilter(10,this)">üèí Hockey</button>
                        <button class="sport-filter-btn" data-sport="11"  onclick="setTournamentSportFilter(11,this)">üèñÔ∏è Beach Volleyball</button>
                        <button class="sport-filter-btn" data-sport="12"  onclick="setTournamentSportFilter(12,this)">üèì Ping Pong</button>
                        <button class="sport-filter-btn" data-sport="999" onclick="setTournamentSportFilter(999,this)">üéØ Custom</button>
                    </div>
                    <button class="btn btn-secondary" onclick="loadTournaments()" style="margin-bottom:14px;">‚Üª Refresh</button>
                    <div id="tournaments-list"><div class="loading">Loading tournaments...</div></div>
                </div>
            </div>

            <!-- CREATE TOURNAMENT -->
            <div id="tsub-create-panel" class="hidden">
                <div class="card">
                    <div class="card-title">‚ûï Create Tournament</div>
                    <div class="info-box info-purple" style="margin-bottom:16px;">
                        <strong style="color:#bf5fff;">üèÜ Tournament Format:</strong> Bracket competition ‚Äî 4, 8, or 16 players. Entry fees pooled. 92% to winner, 8% platform fee.
                    </div>

                    <label class="label">Sport</label>
                    <div class="sport-grid" id="t-create-sport-grid">
                        <div class="sport-btn selected" data-sport-id="1" onclick="selectTournamentSport(1,this)"><span class="sport-btn-icon">‚öΩ</span>Soccer</div>
                        <div class="sport-btn" data-sport-id="2" onclick="selectTournamentSport(2,this)"><span class="sport-btn-icon">üèÄ</span>Basketball</div>
                        <div class="sport-btn" data-sport-id="3" onclick="selectTournamentSport(3,this)"><span class="sport-btn-icon">üéæ</span>Tennis</div>
                        <div class="sport-btn" data-sport-id="4" onclick="selectTournamentSport(4,this)"><span class="sport-btn-icon">‚õ≥</span>Golf</div>
                        <div class="sport-btn" data-sport-id="5" onclick="selectTournamentSport(5,this)"><span class="sport-btn-icon">üèà</span>Football</div>
                        <div class="sport-btn" data-sport-id="6" onclick="selectTournamentSport(6,this)"><span class="sport-btn-icon">‚öæ</span>Baseball</div>
                        <div class="sport-btn" data-sport-id="7" onclick="selectTournamentSport(7,this)"><span class="sport-btn-icon">ü•ä</span>Boxing</div>
                        <div class="sport-btn" data-sport-id="8" onclick="selectTournamentSport(8,this)"><span class="sport-btn-icon">üè∏</span>Pickleball</div>
                        <div class="sport-btn" data-sport-id="9" onclick="selectTournamentSport(9,this)"><span class="sport-btn-icon">üèê</span>Volleyball</div>
                        <div class="sport-btn" data-sport-id="10" onclick="selectTournamentSport(10,this)"><span class="sport-btn-icon">üèí</span>Hockey</div>
                        <div class="sport-btn" data-sport-id="11" onclick="selectTournamentSport(11,this)"><span class="sport-btn-icon">üèñÔ∏è</span>Beach VB</div>
                        <div class="sport-btn" data-sport-id="12" onclick="selectTournamentSport(12,this)"><span class="sport-btn-icon">üèì</span>Ping Pong</div>
                        <div class="sport-btn" data-sport-id="999" onclick="selectTournamentSport(999,this)"><span class="sport-btn-icon">üéØ</span>Custom</div>
                    </div>

                    <label class="label">Tournament Name</label>
                    <input type="text" class="input" id="t-create-name" placeholder="e.g. Summer Slam Invitational">

                    <label class="label">Entry Fee (W1N per player)</label>
                    <input type="number" class="input" id="t-create-fee" placeholder="100" value="100" min="10">

                    <label class="label">Bracket Size</label>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0 16px;">
                        <div id="t-size-4"  onclick="selectBracketSize(4)"
                            style="padding:14px 8px;border-radius:12px;border:2px solid var(--accent);background:rgba(0,212,255,0.08);cursor:pointer;text-align:center;transition:.2s;">
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent);">4</div>
                            <div style="font-size:10px;color:var(--muted);font-weight:700;">PLAYERS</div>
                        </div>
                        <div id="t-size-8"  onclick="selectBracketSize(8)"
                            style="padding:14px 8px;border-radius:12px;border:1px solid var(--border);background:var(--surface);cursor:pointer;text-align:center;transition:.2s;">
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--muted);">8</div>
                            <div style="font-size:10px;color:var(--muted);font-weight:700;">PLAYERS</div>
                        </div>
                        <div id="t-size-16" onclick="selectBracketSize(16)"
                            style="padding:14px 8px;border-radius:12px;border:1px solid var(--border);background:var(--surface);cursor:pointer;text-align:center;transition:.2s;">
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--muted);">16</div>
                            <div style="font-size:10px;color:var(--muted);font-weight:700;">PLAYERS</div>
                        </div>
                    </div>

                    <label class="label">Registration Deadline</label>
                    <input type="datetime-local" class="input" id="t-create-deadline">

                    <label class="label">No-Show Window</label>
                    <select class="input" id="t-create-noshow">
                        <option value="3600">1 hour</option>
                        <option value="7200" selected>2 hours</option>
                        <option value="14400">4 hours</option>
                        <option value="28800">8 hours</option>
                        <option value="86400">24 hours</option>
                    </select>

                    <label class="label">Dispute Window</label>
                    <select class="input" id="t-create-dispute">
                        <option value="1800">30 minutes</option>
                        <option value="3600" selected>1 hour</option>
                        <option value="7200">2 hours</option>
                        <option value="14400">4 hours</option>
                    </select>

                    <div id="t-create-error"   class="error   hidden"></div>
                    <div id="t-create-success" class="success hidden"></div>
                    <button class="btn btn-primary" id="t-create-btn" onclick="createTournament()" style="margin-top:18px;">
                        üèÜ Create Tournament
                    </button>
                </div>
            </div>

            <!-- MY TOURNAMENTS -->
            <div id="tsub-mine-panel" class="hidden">
                <div class="card">
                    <div class="card-title">üéØ My Tournaments</div>
                    <button class="btn btn-secondary" onclick="loadMyTournaments()" style="margin-bottom:14px;">‚Üª Refresh</button>
                    <div id="my-tournaments-list"><div class="loading">Loading your tournaments...</div></div>
                </div>
            </div>

            <!-- TOURNAMENT DETAIL -->
            <div id="tournament-detail" class="hidden">
                <div class="card">
                    <div class="card-title">Tournament Details</div>
                    <div id="tournament-detail-content"></div>
                    <button class="btn btn-secondary" onclick="closeTournamentDetail()" style="margin-top:16px;">‚Üê Back</button>
                </div>
            </div>

        </div>
        <!-- MATCH DETAIL -->
        <div id="match-detail" class="hidden">
            <div class="card">
                <div class="card-title">Match Details</div>
                <div id="match-detail-content"></div>
                <button class="btn btn-secondary" onclick="closeMatchDetail()" style="margin-top:16px;">‚Üê Back</button>
            </div>
        </div>

        <!-- ADMIN FAUCET PANEL -->
        <div id="admin-panel" class="hidden">
            <div class="card" style="border-color:rgba(255,215,0,0.25);background:rgba(255,215,0,0.03);">
                <div class="card-title" style="color:var(--gold);">‚öôÔ∏è Admin ¬∑ Faucet</div>
                <p style="color:var(--muted);font-size:12px;margin-bottom:16px;">Mint W1N + send PLS gas to any wallet. For demo use only.</p>
                <label class="label">Recipient Address</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="text" class="input" id="faucet-address" placeholder="0x... recipient wallet" style="margin:8px 0;flex:1;">
                    <button onclick="openQrScanner('faucet-address')" style="flex-shrink:0;width:48px;height:48px;border-radius:12px;border:1px solid rgba(0,212,255,0.25);background:rgba(0,212,255,0.08);cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center;" title="Scan QR Code">üì∑</button>
                </div>
                <label class="label">Amount (W1N)</label>
                <input type="number" class="input" id="faucet-amount" placeholder="500" value="500" min="1">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:10px 0;">
                    <button class="btn btn-secondary" style="padding:8px;font-size:11px;" onclick="setFaucetAmount(100)">100</button>
                    <button class="btn btn-secondary" style="padding:8px;font-size:11px;" onclick="setFaucetAmount(500)">500</button>
                    <button class="btn btn-secondary" style="padding:8px;font-size:11px;" onclick="setFaucetAmount(1000)">1,000</button>
                    <button class="btn btn-secondary" style="padding:8px;font-size:11px;" onclick="setFaucetAmount(5000)">5,000</button>
                </div>
                <div style="background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.12);border-radius:12px;padding:12px;margin:12px 0;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                        <span style="font-size:12px;font-weight:700;color:var(--text);">‚õΩ Include Gas (PLS)</span>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="faucet-send-pls" checked style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer;">
                            <span style="font-size:12px;color:var(--muted);">Send PLS</span>
                        </label>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input type="number" class="input" id="faucet-pls-amount" value="2000" min="0" style="margin:0;flex:1;font-size:14px;">
                        <span style="color:var(--muted);font-size:13px;font-weight:700;flex-shrink:0;">PLS</span>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px;">
                        <button class="btn btn-secondary" style="padding:6px;font-size:10px;" onclick="document.getElementById('faucet-pls-amount').value=500">500</button>
                        <button class="btn btn-secondary" style="padding:6px;font-size:10px;" onclick="document.getElementById('faucet-pls-amount').value=1000">1k</button>
                        <button class="btn btn-secondary" style="padding:6px;font-size:10px;" onclick="document.getElementById('faucet-pls-amount').value=2000">2k</button>
                        <button class="btn btn-secondary" style="padding:6px;font-size:10px;" onclick="document.getElementById('faucet-pls-amount').value=5000">5k</button>
                    </div>
                </div>
                <div id="faucet-status" class="hidden"></div>
                <button class="btn" id="faucet-btn" onclick="adminMint()" style="margin-top:12px;background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;">üí∞ Arm Player</button>
                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                    <div class="label" style="margin-top:0;">Quick-Arm: Fund My Wallet</div>
                    <button class="btn btn-secondary" onclick="mintToSelf()" style="margin-top:8px;">Mint 500 W1N + 2000 PLS ‚Üí My Wallet</button>
                </div>
            </div>
        </div>

    </div><!-- /connected -->
</div><!-- /container -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA MANIFEST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function() {
    const manifest = {
        name: 'W1NNR', short_name: 'W1NNR',
        description: 'Compete. W1N. Earn. On-chain match staking.',
        start_url: 'https://w1nnr-app.github.io/W1NNR/test.html',
        scope: 'https://w1nnr-app.github.io/W1NNR/',
        display: 'standalone', orientation: 'portrait',
        background_color: '#000000', theme_color: '#080b14',
        icons: [
            { src: 'https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png', sizes: '192x192', type: 'image/png', purpose: 'any' },
            { src: 'https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png', sizes: '512x512', type: 'image/png', purpose: 'any' },
            { src: 'https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png', sizes: '192x192', type: 'image/png', purpose: 'maskable' },
            { src: 'https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' }
        ],
        categories: ['games','sports','finance'],
        shortcuts: [{ name:'Play Now', short_name:'Play', url:'https://w1nnr-app.github.io/W1NNR/test.html', icons:[{src:'https://w1nnr-app.github.io/W1NNR/W1NNR_logo.png',sizes:'192x192'}] }]
    };
    try {
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        document.getElementById('pwa-manifest').href = URL.createObjectURL(blob);
    } catch(e) {}
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî UPDATE FACTORY_ADDRESS after V4 deployment
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
    FACTORY_ADDRESS:          '0x0fF2Ac9F2e733d651b1A96572325DEE10A9d243C', // Match Factory V4
    W1N_ADDRESS:              '0x6Dae2380d34a3681df136DEd6E0e215aE44f85F9',
    CHAIN_ID:                 369,
    RPC_URL:                  'https://rpc.pulsechain.com',
    FACTORY_DEPLOY_BLOCK:     25860567, // Match Factory V4 deploy block
    TOKEN_DECIMALS:           18,
    TOKEN_SYMBOL:             'W1N',
    MIN_FEE:                  10,
    TOURNAMENT_FACTORY:       '0x24Eaa489E6C887FbD40a6Ab4049Ea17f8952BE62',
    TOURNAMENT_MASTER:        '0x29B95C4E1C35E6616BaDf324EF593B9c8a122001',
    PLAYER_REGISTRY_ADDRESS:  '0xCa58A826D1cc536e8E3f937Cc129248fB0AaC5fB',
    FACTORY_REGISTRY_ADDRESS: '0x4B7d7A4e47735d7B7c87a9EB2942A62042453bEb',
    TREASURY_ADDRESS:         '0x9fB484d2Cc69dADB9c11DA1850082321bAc803fA',
    // ‚îÄ‚îÄ Profile API ‚Äî update after deploying Cloudflare Worker ‚îÄ‚îÄ
    API_BASE:                 'https://w1nnr-profile-worker.w1nnr.workers.dev',
};


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE API CLIENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let w1nnrProfile   = null;  // current user's profile object
let w1nnrAuthToken = null;  // session token

// Load token from localStorage on start
function loadAuthToken() {
    if (!userAddress) return;
    const key = 'w1nnr_token_' + userAddress.toLowerCase();
    w1nnrAuthToken = localStorage.getItem(key) || null;
}

function saveAuthToken(token) {
    if (!userAddress) return;
    const key = 'w1nnr_token_' + userAddress.toLowerCase();
    localStorage.setItem(key, token);
    w1nnrAuthToken = token;
}

function clearAuthToken() {
    if (!userAddress) return;
    localStorage.removeItem('w1nnr_token_' + userAddress.toLowerCase());
    w1nnrAuthToken = null;
}

async function apiGet(path) {
    const r = await fetch(CONFIG.API_BASE + path);
    return r.ok ? r.json() : null;
}

async function apiPost(path, body, auth = false) {
    const headers = { 'Content-Type': 'application/json' };
    if (auth && w1nnrAuthToken) headers['Authorization'] = 'Bearer ' + w1nnrAuthToken;
    const r = await fetch(CONFIG.API_BASE + path, {
        method: 'POST',
        headers,
        body: JSON.stringify(body),
    });
    return r.json();
}

// Fetch profile for any address
async function fetchProfile(address) {
    return apiGet('/profile/' + address.toLowerCase());
}

// Check handle availability
async function checkHandleAvailable(handle) {
    const r = await apiGet('/handle/' + handle.toLowerCase());
    return r?.available === true;
}

// Full sign-in flow: get nonce ‚Üí sign ‚Üí verify ‚Üí receive token
async function signInWithWallet() {
    try {
        // 1. Get nonce
        const nonceRes = await apiPost('/auth/nonce', { address: userAddress });
        if (!nonceRes?.message) throw new Error('Failed to get nonce');

        // 2. Sign message in MetaMask (free, no gas)
        const signature = await signer.signMessage(nonceRes.message);

        // 3. Verify + receive token
        const verifyRes = await apiPost('/auth/verify', {
            address: userAddress,
            signature,
        });
        if (!verifyRes?.token) throw new Error('Verification failed');

        saveAuthToken(verifyRes.token);
        return true;
    } catch (e) {
        console.error('signInWithWallet:', e);
        return false;
    }
}

// Save profile to API
async function saveProfileToAPI(profileData) {
    if (!w1nnrAuthToken) {
        const ok = await signInWithWallet();
        if (!ok) return { error: 'Authentication failed' };
    }
    return apiPost('/profile', profileData, true);
}

// Load current user's profile ‚Äî called after connectWallet
async function loadUserProfile() {
    if (!userAddress) return;
    loadAuthToken();
    const profile = await fetchProfile(userAddress);
    if (profile && !profile.error) {
        w1nnrProfile = profile;
        applyProfileToUI(profile);
        return true; // returning user
    }
    return false; // new user ‚Äî show onboarding
}

// Apply profile data to existing UI elements
function applyProfileToUI(profile) {
    if (!profile) return;
    // Sync with existing username system
    if (profile.handle) {
        setUsername(userAddress, profile.handle);
    }
    if (profile.bio) {
        localStorage.setItem('w1nnr_bio_' + userAddress.toLowerCase(), profile.bio);
    }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONBOARDING FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let onboardStep = 1;
const ONBOARD_TOTAL = 4;

function showOnboarding() {
    document.getElementById('onboarding-modal').classList.remove('hidden');
    goToOnboardStep(1);
}

function closeOnboarding() {
    document.getElementById('onboarding-modal').classList.add('hidden');
}

function goToOnboardStep(step) {
    onboardStep = step;
    document.querySelectorAll('.onboard-step').forEach(el => el.classList.add('hidden'));
    const el = document.getElementById('onboard-step-' + step);
    if (el) el.classList.remove('hidden');
    document.querySelectorAll('.onboard-dot').forEach((dot, i) => {
        dot.style.background = i + 1 <= step ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
    });
    const counter = document.getElementById('onboard-counter');
    if (counter) counter.textContent = step + ' / ' + ONBOARD_TOTAL;

    // Populate preview on step 4
    if (step === 4) {
        const SPORT_ICONS = {1:'‚öΩ',2:'üèÄ',3:'üéæ',4:'‚õ≥',5:'üèà',6:'‚öæ',7:'ü•ä',8:'üèì',9:'üèê',10:'üèí'};
        const handle = document.getElementById('onboard-handle')?.value || '';
        const skill  = document.querySelector('input[name="skill"]:checked')?.value || 'casual';
        const sports = Array.from(selectedSports).map(id => SPORT_ICONS[id] || '').join(' ');
        const ph = document.getElementById('preview-handle');
        const ps = document.getElementById('preview-sports');
        const pk = document.getElementById('preview-skill');
        if (ph) ph.textContent = '@' + handle;
        if (ps) ps.textContent = sports || '‚Äî';
        if (pk) pk.textContent = skill.charAt(0).toUpperCase() + skill.slice(1);
    }
}

// Step 1: Handle
async function onboardCheckHandle() {
    const input = document.getElementById('onboard-handle').value.trim().toLowerCase();
    const err   = document.getElementById('onboard-handle-err');
    const btn   = document.getElementById('onboard-handle-btn');

    if (!/^[a-z0-9_]{3,20}$/.test(input)) {
        err.textContent = '3‚Äì20 characters. Letters, numbers, underscores only.';
        err.classList.remove('hidden'); return;
    }
    err.classList.add('hidden');
    btn.textContent = 'Checking‚Ä¶'; btn.disabled = true;

    const available = await checkHandleAvailable(input);
    btn.disabled = false;

    if (!available) {
        err.textContent = '@' + input + ' is already taken.';
        err.classList.remove('hidden');
        btn.textContent = 'Continue ‚Üí';
        return;
    }
    btn.textContent = 'Continue ‚Üí';
    goToOnboardStep(2);
}

// Step 2: Sports
const selectedSports = new Set();
function toggleOnboardSport(sportId, el) {
    if (selectedSports.has(sportId)) {
        selectedSports.delete(sportId);
        el.style.borderColor = 'var(--border)';
        el.style.background  = 'var(--surface)';
    } else {
        if (selectedSports.size >= 3) {
            showOnboardMsg('Pick up to 3 sports'); return;
        }
        selectedSports.add(sportId);
        el.style.borderColor = 'rgba(0,212,255,0.5)';
        el.style.background  = 'rgba(0,212,255,0.08)';
    }
}
function onboardSportsNext() {
    if (selectedSports.size === 0) { showOnboardMsg('Pick at least 1 sport'); return; }
    goToOnboardStep(3);
}

// Step 3: Skill + Bio
function onboardProfileNext() {
    const bio = document.getElementById('onboard-bio').value.trim();
    if (bio.length > 160) { showOnboardMsg('Bio max 160 chars'); return; }
    goToOnboardStep(4);
}

// Step 4: Sign & Save
async function onboardFinish() {
    const btn    = document.getElementById('onboard-finish-btn');
    const err    = document.getElementById('onboard-finish-err');
    const handle = document.getElementById('onboard-handle').value.trim().toLowerCase();
    const bio    = document.getElementById('onboard-bio').value.trim();
    const skill  = document.querySelector('input[name="skill"]:checked')?.value || 'casual';

    btn.textContent = '‚è≥ Signing in MetaMask‚Ä¶'; btn.disabled = true;
    err.classList.add('hidden');

    // Sign in with wallet (get token)
    const ok = await signInWithWallet();
    if (!ok) {
        err.textContent = 'Wallet sign-in failed. Please try again.';
        err.classList.remove('hidden');
        btn.textContent = '‚ö° Create My Profile'; btn.disabled = false;
        return;
    }

    btn.textContent = '‚è≥ Saving profile‚Ä¶';

    // Auto-register on PlayerRegistry if not already registered
    let playerId = null;
    try {
        const regRead = new ethers.Contract(
            CONFIG.PLAYER_REGISTRY_ADDRESS,
            PLAYER_REGISTRY_ABI,
            provider
        );
        const already = await regRead.isRegistered(userAddress);
        if (!already) {
            btn.textContent = '‚è≥ Registering on-chain‚Ä¶';
            const regWrite = new ethers.Contract(
                CONFIG.PLAYER_REGISTRY_ADDRESS,
                PLAYER_REGISTRY_ABI,
                signer
            );
            const tx = await regWrite.register();
            await tx.wait();
        }
        const pid = await regRead.getPlayerId(userAddress);
        if (pid > 0n) playerId = pid.toString();
    } catch (regErr) {
        console.warn('Player registry:', regErr.message);
        // Non-fatal ‚Äî profile save continues without on-chain ID
    }

    const result = await saveProfileToAPI({
        handle,
        bio,
        sports:     Array.from(selectedSports),
        skillLevel: skill,
        avatarSeed: userAddress,
        playerId,
    });

    if (result?.success) {
        w1nnrProfile = result.profile;
        applyProfileToUI(result.profile);
        closeOnboarding();
        showOnboardSuccess(handle);
    } else {
        err.textContent = result?.error || 'Save failed. Try again.';
        err.classList.remove('hidden');
        btn.textContent = '‚ö° Create My Profile'; btn.disabled = false;
    }
}

function showOnboardMsg(msg) {
    const el = document.getElementById('onboard-msg');
    if (!el) return;
    el.textContent = msg;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 2500);
}

function showOnboardSuccess(handle) {
    // Brief celebration overlay
    const d = document.createElement('div');
    d.style.cssText = 'position:fixed;inset:0;z-index:4000;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;';
    d.innerHTML = `
        <div style="font-size:64px;margin-bottom:16px;animation:bounceIn .5s;">üèÜ</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:3px;background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">WELCOME, @${handle}</div>
        <div style="font-size:14px;color:var(--muted);margin-top:8px;">Your W1NNR identity is live.</div>
        <div style="font-size:12px;color:var(--muted2);margin-top:4px;">Player ID locked to your wallet forever.</div>
    `;
    document.body.appendChild(d);
    setTimeout(() => { d.remove(); refreshProfileUI(); }, 2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPORT DEFINITIONS ‚Äî mirrors contract sport IDs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SPORTS = {
    1:   { name: 'Soccer',           icon: '‚öΩ' },
    2:   { name: 'Basketball',       icon: 'üèÄ' },
    3:   { name: 'Tennis',           icon: 'üéæ' },
    4:   { name: 'Golf',             icon: '‚õ≥' },
    5:   { name: 'Football',         icon: 'üèà' },
    6:   { name: 'Baseball',         icon: '‚öæ' },
    7:   { name: 'Boxing / MMA',     icon: 'ü•ä' },
    8:   { name: 'Pickleball',       icon: 'üè∏' },
    9:   { name: 'Volleyball',       icon: 'üèê' },
    10:  { name: 'Hockey',           icon: 'üèí' },
    11:  { name: 'Beach Volleyball', icon: 'üèñÔ∏è' },
    12:  { name: 'Ping Pong',        icon: 'üèì' },
    999: { name: 'Custom',           icon: 'üéØ' },
};
function sportLabel(id) {
    const s = SPORTS[Number(id)];
    return s ? `${s.icon} ${s.name}` : `Sport #${id}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ABIs ‚Äî V4
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PLAYER_REGISTRY_ABI = [
    'function register() external',
    'function getPlayerId(address wallet) external view returns (uint256)',
    'function isRegistered(address wallet) external view returns (bool)',
    'function totalPlayers() external view returns (uint256)',
];

const FACTORY_ABI = [
    // Private match creation
    "function createMatch(address player2, uint256 entryFee, uint256 scheduledTime, uint256 sportId) external returns (address)",
    "function createInstantMatch(address player2, uint256 entryFee, uint256 sportId) external returns (address)",
    // Open match creation
    "function createOpenMatch(uint256 entryFee, uint256 scheduledTime, uint256 sportId) external returns (address)",
    "function createOpenInstantMatch(uint256 entryFee, uint256 sportId) external returns (address)",
    // Views
    "function getOpenMatches(uint256 sportId, uint256 maxResults) external view returns (address[])",
    "function getUserMatches(address user) external view returns (address[])",
    "function getTotalMatches() external view returns (uint256)",
    "function getRecentMatches(uint256 count) external view returns (address[])",
    "function isMatch(address) external view returns (bool)",
    "function sportNames(uint256) external view returns (string)",
    "function validSports(uint256) external view returns (bool)",
    // Events
    "event MatchCreated(address indexed escrow, address indexed player1, address indexed player2, uint256 entryFee, uint256 scheduledTime, bool isOpen, bool isInstant, uint256 sportId)",
    "event MatchJoinedOpen(address indexed escrow, address indexed player2)",
    "event MatchSettled(address indexed escrow, address indexed player1, address indexed player2, address winner, uint256 amount, uint256 sportId)",
    "event MatchMutuallyCancelled(address indexed escrow, address indexed player1, address indexed player2)"
];

const ESCROW_ABI = [
    // State views
    "function player1() external view returns (address)",
    "function player2() external view returns (address)",
    "function player2Initial() external view returns (address)",
    "function entryFee() external view returns (uint256)",
    "function scheduledTime() external view returns (uint256)",
    "function status() external view returns (uint8)",
    "function netPot() external view returns (uint256)",
    "function sportId() external view returns (uint256)",
    "function isOpenMatch() external view returns (bool)",
    "function isInstantMatch() external view returns (bool)",
    "function p1Deposited() external view returns (bool)",
    "function p2Deposited() external view returns (bool)",
    "function p1CheckedIn() external view returns (bool)",
    "function p2CheckedIn() external view returns (bool)",
    "function p1ReportedWinner() external view returns (address)",
    "function p2ReportedWinner() external view returns (address)",
    "function winner() external view returns (address)",
    "function disputeStartTime() external view returns (uint256)",
    // Mutual cancel state
    "function p1WantsMutualCancel() external view returns (bool)",
    "function p2WantsMutualCancel() external view returns (bool)",
    "function getMutualCancelStatus() external view returns (bool p1Wants, bool p2Wants)",
    // Compound views
    "function getTimings() external view returns (uint256 matchTime, uint256 checkinDeadline, uint256 reportDeadline, uint256 disputeDeadline, bool instantMatch)",
    "function getPlayers() external view returns (address, address)",
    "function getStatus() external view returns (uint8 currentStatus, bool p1Dep, bool p2Dep, bool p1Check, bool p2Check, address p1Report, address p2Report, address winnerAddr, uint256 pot)",
    // Actions
    "function joinMatch() external",
    "function joinAndDeposit() external",
    "function deposit() external",
    "function checkIn() external",
    "function reportOutcome(address winner) external",
    "function requestMutualCancel() external",
    "function cancel() external",
    "function expireOpen() external",
    "function expire() external",
    "function resolveAfterTimeout() external",
    "function processNoShow() external",
    // Events
    "event Settled(address indexed winner, address indexed loser, uint256 prize)",
    "event MatchJoined(address indexed player2)",
    "event Deposited(address indexed player)",
    "event Funded(uint256 netPot, uint256 platformFee)",
    "event CheckedIn(address indexed player)",
    "event OutcomeReported(address indexed reporter, address indexed reportedWinner)",
    "event Disputed(uint256 disputeStartTime)",
    "event NoShowProcessed(address indexed showed, address indexed noShow)",
    "event DisputeRefunded(uint256 amountEach)",
    "event Cancelled(uint256 refundEach)",
    "event MutualCancelRequested(address indexed requester)",
    "event BurnedToTreasury(uint256 amount)",
    "event Expired()"
];

const ERC20_ABI = [
    "function balanceOf(address) external view returns (uint256)",
    "function approve(address spender, uint256 amount) external returns (bool)",
    "function allowance(address owner, address spender) external view returns (uint256)",
    "function transfer(address to, uint256 amount) external returns (bool)"
];

const ADMIN_WALLET = '0xE0F100886808942875b10D0049E8e3aa64423B21'; // OA ‚Äî faucet admin
const STATUS_MAP   = {0:'Open',1:'Funded',2:'InProgress',3:'Reported',4:'Disputed',5:'Settled',6:'Cancelled',7:'Expired',8:'NoShow'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let provider, signer, userAddress;
let factoryContract, w1nContract;
let username = null;
let userBio   = null;
let matchTypeMode   = 'instant';   // 'instant' | 'scheduled'
let selectedSportId = 1;           // default: Soccer
let activeSportFilter = 0;         // 0 = all sports in open matches tab


function isClientExpiredOpenMatch(statusNum, isInstant, scheduledTsSec) {
    if (Number(statusNum) !== 0) return false;
    if (Boolean(isInstant)) return false;
    const ts = Number(scheduledTsSec);
    if (!Number.isFinite(ts) || ts <= 0) return false;
    return ts <= Math.floor(Date.now() / 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPORT PICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectSport(id, el) {
    selectedSportId = id;
    document.querySelectorAll('.sport-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    const s = SPORTS[id];
    document.getElementById('selected-sport-display').textContent = s ? `${s.icon} ${s.name} selected` : `Sport #${id} selected`;
}

function setSportFilter(sportId, el) {
    activeSportFilter = sportId;
    document.querySelectorAll('.sport-filter-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    loadMatches();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATCH TYPE TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMatchType(type) {
    matchTypeMode = type;
    const iBtn = document.getElementById('type-instant');
    const sBtn = document.getElementById('type-scheduled');
    if (type === 'instant') {
        iBtn.className = 'type-btn active-instant';
        sBtn.className = 'type-btn';
        document.getElementById('instant-info').classList.remove('hidden');
        document.getElementById('scheduled-info').classList.add('hidden');
        document.getElementById('scheduled-time-section').classList.add('hidden');
        document.getElementById('create-btn').className = 'btn btn-instant';
        document.getElementById('create-btn').textContent = '‚ö° Create Instant Match';
    } else {
        iBtn.className = 'type-btn';
        sBtn.className = 'type-btn active-scheduled';
        document.getElementById('instant-info').classList.add('hidden');
        document.getElementById('scheduled-info').classList.remove('hidden');
        document.getElementById('scheduled-time-section').classList.remove('hidden');
        document.getElementById('create-btn').className = 'btn btn-primary';
        document.getElementById('create-btn').textContent = 'üìÖ Create Scheduled Match';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AVATAR SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GRADIENTS = [
    '135deg,#00d4ff,#00ff88','135deg,#ffd700,#ff7b2c','135deg,#ff3b5c,#ff7b2c',
    '135deg,#7b2fff,#ff3b5c','135deg,#ff7b2c,#ffd700','135deg,#00ff88,#00d4ff',
    '135deg,#00d4ff,#7b2fff','135deg,#ff3b5c,#ffd700',
];
const AVATAR_PHOTOS = [
    'https://w1nnr-app.github.io/W1NNR/male1.jpeg',
    'https://w1nnr-app.github.io/W1NNR/female1.jpeg',
    'https://w1nnr-app.github.io/W1NNR/male2.jpeg',
    'https://w1nnr-app.github.io/W1NNR/female2.jpeg',
    'https://w1nnr-app.github.io/W1NNR/male3.jpeg',
    'https://w1nnr-app.github.io/W1NNR/female3.jpeg',
    'https://w1nnr-app.github.io/W1NNR/male4.jpeg',
    'https://w1nnr-app.github.io/W1NNR/male1.jpeg',
];
function addrGradient(address) {
    if (!address || address === ethers.ZeroAddress) return GRADIENTS[0];
    return GRADIENTS[parseInt(address.slice(-4), 16) % GRADIENTS.length];
}
function addrInitials(address) {
    if (!address || address === ethers.ZeroAddress) return '?';
    const u = getUsername(address);
    if (u) return u.slice(0,2).toUpperCase();
    return address.slice(2,4).toUpperCase();
}
function avatarHTML(address, sizeClass='', ringClass='accent-ring') {
    const grad    = addrGradient(address);
    const initials= addrInitials(address);
    const idx     = parseInt(address?.slice(-4)||'0',16) % AVATAR_PHOTOS.length;
    const photo   = AVATAR_PHOTOS[idx];
    return `<div class="avatar ${sizeClass} ${ringClass}" style="background:linear-gradient(${grad});overflow:hidden;padding:0;">
      <img src="${photo}" alt="${initials}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"
           onerror="this.style.display='none';this.parentElement.style.background='linear-gradient(${grad})';this.parentElement.innerHTML='<span style=\'font-family:Bebas Neue,sans-serif;\'>${initials}</span>';">
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERNAME / PROFILE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getUsername(address) {
    if (!address) return null;
    return localStorage.getItem('w1nnr_user_' + address.toLowerCase()) || null;
}
function setUsername(address, name) {
    localStorage.setItem('w1nnr_user_' + address.toLowerCase(), name);
}
function loadUsername() {
    if (!userAddress) return;
    let u = getUsername(userAddress);
    if (u && u.startsWith('@')) {
        u = u.slice(1);
        setUsername(userAddress, u);   // re-save without @
    }
    username = u;
    userBio  = localStorage.getItem('w1nnr_bio_' + userAddress.toLowerCase()) || null;
}
function promptUsername() {
    if (username) return;
    const input = prompt('Choose your W1NNR username (3-16 chars):');
    if (input && input.trim().length >= 3 && input.trim().length <= 16) {
        username = input.trim();
        setUsername(userAddress, username);
    } else if (input) {
        alert('Username must be 3-16 characters');
        promptUsername();
    }
}
function getDisplayName(address) {
    if (!address || address === ethers.ZeroAddress) return 'Open';
    if (address.toLowerCase() === userAddress?.toLowerCase()) return '@' + (username || 'You');
    const cached = getUsername(address);
    if (cached) return '@' + cached;
    return address.slice(0,6) + '‚Ä¶' + address.slice(-4);
}
function changeUsername() {
    username = null;
    localStorage.removeItem('w1nnr_user_' + userAddress.toLowerCase());
    promptUsername();
    refreshProfileUI();
}
function editBio() {
    const input = prompt('Enter a short bio (max 100 chars):', userBio || '');
    if (input !== null) {
        userBio = input.trim().slice(0, 100);
        localStorage.setItem('w1nnr_bio_' + userAddress.toLowerCase(), userBio);
        refreshProfileUI();
    }
}

function refreshProfileUI() {
    if (!userAddress) return;
    const grad  = addrGradient(userAddress);
    const idx   = parseInt(userAddress?.slice(-4)||'0',16) % AVATAR_PHOTOS.length;
    const photo = AVATAR_PHOTOS[idx];
    const inits = addrInitials(userAddress);
    const imgTag= `<img src="${photo}" alt="${inits}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.style.display='none';this.parentElement.innerHTML='<span style=\'font-family:Bebas Neue,sans-serif;font-size:16px;color:#000;\'>${inits}</span>';">`;
    const ha = document.getElementById('header-avatar');
    if (ha) { ha.style.cssText+=`;background:linear-gradient(${grad});overflow:hidden;padding:0;`; ha.innerHTML=imgTag; }
    const wa = document.getElementById('wallet-address');
    if (wa) wa.textContent = username ? '@'+username : userAddress.slice(0,6)+'‚Ä¶'+userAddress.slice(-4);
    const ba = document.getElementById('profile-avatar-big');
    if (ba) { ba.style.cssText+=`;background:linear-gradient(${grad});overflow:hidden;padding:0;`; ba.innerHTML=`<img src="${photo}" alt="${inits}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.style.display='none';this.parentElement.innerHTML='<span style=\'font-family:Bebas Neue,sans-serif;font-size:30px;color:#000;\'>${inits}</span>';">`; }
    const ne = document.getElementById('profile-name-display');
    const he = document.getElementById('profile-handle-display');
    const be = document.getElementById('profile-bio-display');
    if (ne) ne.textContent = username ? username.toUpperCase() : userAddress.slice(0,10)+'‚Ä¶';
    if (he) he.textContent = username ? '@'+username : userAddress.slice(0,6)+'‚Ä¶'+userAddress.slice(-4);
    if (be) be.textContent = userBio || 'Settling scores on-chain.';
    const ae = document.getElementById('profile-address');
    if (ae) ae.textContent = userAddress.slice(0,10)+'‚Ä¶'+userAddress.slice(-8);
}

async function refreshProfileStats() {
    try {
        const s = await getPlayerStats(userAddress);
        const total = s.wins + s.losses;
        document.getElementById('profile-total-matches').textContent = total;
        document.getElementById('profile-wins').textContent          = s.wins;
        document.getElementById('profile-winrate').textContent       = calcWinRate(s)+'%';
        document.getElementById('profile-earnings').textContent      = s.earnings.toFixed(0);
        document.getElementById('profile-record').textContent        = `${s.wins}-${s.losses}`;
        document.getElementById('profile-earnings-2').textContent    = s.earnings.toFixed(2)+' W1N';
        const badge = document.getElementById('profile-rank-badge');
        const wr = parseFloat(calcWinRate(s));
        if (badge) {
            if      (wr>=80&&total>=5){ badge.className='rank-badge rank-elite';  badge.textContent='‚≠ê ELITE';  }
            else if (wr>=65&&total>=3){ badge.className='rank-badge rank-gold';   badge.textContent='ü•á GOLD';   }
            else if (wr>=50&&total>=2){ badge.className='rank-badge rank-silver'; badge.textContent='ü•à SILVER'; }
            else if (total>0)         { badge.className='rank-badge rank-bronze'; badge.textContent='ü•â BRONZE'; }
            else                      { badge.className='rank-badge rank-silver'; badge.textContent='UNRANKED';  }
        }
    } catch(e) { console.error('refreshProfileStats:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS / LEADERBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let globalStatsCache = null;
let statsLastLoaded  = 0;
const STATS_CACHE_TTL = 60000;

async function getAllMatchAddresses() {
    try {
        const events = await getStaticFactory().queryFilter(getStaticFactory().filters.MatchCreated(), CONFIG.FACTORY_DEPLOY_BLOCK, "latest");
        return events.map(e => e.args.escrow);
    } catch(e) { console.error("getAllMatchAddresses:", e); return []; }
}

async function buildGlobalStats() {
    const stats = {};
    if (!staticProvider) return stats;
    try {
        const matchAddresses = await getAllMatchAddresses();
        if (!matchAddresses.length) return stats;
        const settledTopic = ethers.id("Settled(address,address,uint256)");
        const CHUNK = 50;
        const allLogs = [];
        for (let i = 0; i < matchAddresses.length; i += CHUNK) {
            const logs = await getStaticProvider().getLogs({
                fromBlock: CONFIG.FACTORY_DEPLOY_BLOCK, toBlock: "latest",
                address: matchAddresses.slice(i, i+CHUNK), topics: [settledTopic]
            });
            allLogs.push(...logs);
        }
        const iface = new ethers.Interface(ESCROW_ABI);
        for (const log of allLogs) {
            try {
                const p = iface.parseLog(log);
                const winner = p.args.winner.toLowerCase();
                const loser  = p.args.loser.toLowerCase();
                const prize  = parseFloat(ethers.formatUnits(p.args.prize, CONFIG.TOKEN_DECIMALS));
                if (!stats[winner]) stats[winner] = {wins:0,losses:0,earnings:0};
                stats[winner].wins++; stats[winner].earnings += prize;
                if (!stats[loser])  stats[loser]  = {wins:0,losses:0,earnings:0};
                stats[loser].losses++;
            } catch(e) { /* skip */ }
        }
        return stats;
    } catch(e) { console.error("buildGlobalStats:", e); return {}; }
}

async function getGlobalStats(force=false) {
    const now = Date.now();
    if (!force && globalStatsCache && (now - statsLastLoaded < STATS_CACHE_TTL)) return globalStatsCache;
    globalStatsCache = await buildGlobalStats();
    statsLastLoaded  = now;
    return globalStatsCache;
}
async function getPlayerStats(address) {
    const stats = await getGlobalStats();
    return stats[address.toLowerCase()] || {wins:0,losses:0,earnings:0};
}
function calcWinRate(s) {
    const t = s.wins + s.losses;
    return t===0 ? '0' : ((s.wins/t)*100).toFixed(1);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD PROFILE ENRICHMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Cache of address ‚Üí handle fetched from API
const profileHandleCache = {};

async function enrichPlayerHandles(players) {
    // Only fetch addresses we don't already have
    const toFetch = players.filter(p => !profileHandleCache[p.address.toLowerCase()]);

    await Promise.allSettled(toFetch.map(async p => {
        try {
            const profile = await fetchProfile(p.address);
            if (profile && profile.handle) {
                const addr = p.address.toLowerCase();
                profileHandleCache[addr] = profile.handle;
                // Also cache sports for display
                profileHandleCache[addr + '_sports'] = profile.sports || [];
                // Sync with local username cache
                setUsername(p.address, profile.handle);
            }
        } catch {}
    }));

    // Apply cached data to player objects
    players.forEach(p => {
        const addr = p.address.toLowerCase();
        if (profileHandleCache[addr]) {
            p.handle = profileHandleCache[addr];
            p.sports = profileHandleCache[addr + '_sports'] || [];
        }
    });
}

async function buildLeaderboard() {
    const list = document.getElementById('leaderboard-list');
    list.innerHTML = '<div class="loading">Building leaderboard from chain...</div>';
    try {
        const stats = await getGlobalStats();
        let players = Object.entries(stats).map(([addr, rec]) => ({
            address: addr, ...rec, winRate: calcWinRate(rec)
        })).sort((a,b) => b.wins - a.wins || b.earnings - a.earnings);

        if (!players.length) {
            list.innerHTML = '<p style="color:var(--muted);text-align:center;padding:24px;">No matches settled yet. Be the first!</p>';
            return;
        }

        // Enrich top 20 with API profiles
        await enrichPlayerHandles(players.slice(0, 20));

        list.innerHTML = '';

        // Connected user rank banner (if outside top 10)
        if (userAddress) {
            const myRank = players.findIndex(p => p.address.toLowerCase() === userAddress.toLowerCase());
            if (myRank >= 10 && myRank !== -1) {
                const me = players[myRank];
                const banner = document.createElement('div');
                banner.style.cssText = 'background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.15);border-radius:12px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:12px;';
                banner.innerHTML = `
                    <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:1px;text-transform:uppercase;">Your Rank</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--accent);">#${myRank+1}</div>
                    <div style="flex:1;font-size:12px;color:var(--muted);">${me.wins}W ¬∑ ${me.losses}L ¬∑ ${me.winRate}% WR</div>
                    <div style="font-size:12px;color:var(--green);font-weight:700;">${me.earnings.toFixed(1)} W1N</div>`;
                list.appendChild(banner);
            }
        }

        // Top 10 rows
        players.slice(0,10).forEach((p, i) => {
            const isMe    = userAddress && p.address.toLowerCase() === userAddress.toLowerCase();
            const medal   = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`#${i+1}`;
            const mColor  = i===0?'var(--gold)':i===1?'#C0C0C0':i===2?'#CD7F32':'var(--muted)';
            const ring    = i===0?'gold-ring':i<3?'accent-ring':'';
            const handle  = p.handle ? '@'+p.handle : getDisplayName(p.address);
            const sports  = (p.sports||[]).map(id => SPORTS[id]?.icon||'').join(' ');
            const border  = isMe ? 'border:1px solid rgba(0,212,255,0.3);' : 'border:1px solid var(--border);';

            const row = document.createElement('div');
            row.style.cssText = `background:var(--surface);${border}border-radius:14px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:.2s;`;
            row.onmouseenter = () => row.style.borderColor = 'rgba(0,212,255,0.3)';
            row.onmouseleave = () => { if (!isMe) row.style.borderColor = 'var(--border)'; };
            row.innerHTML = `
                <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;min-width:32px;text-align:center;color:${mColor};">${medal}</div>
                ${avatarHTML(p.address, 'avatar-sm', ring)}
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                        ${handle}${isMe?' <span style="font-size:10px;color:var(--accent);font-weight:800;letter-spacing:1px;">YOU</span>':''}
                    </div>
                    <div style="font-size:11px;color:var(--muted);margin-top:2px;">
                        <span style="color:var(--green);font-weight:700;">${p.wins}W</span>
                        <span style="opacity:.5;margin:0 3px;">¬∑</span>
                        <span style="color:var(--red);">${p.losses}L</span>
                        <span style="opacity:.5;margin:0 3px;">¬∑</span>
                        <span>${p.winRate}% WR</span>
                        ${sports ? '<span style="opacity:.5;margin:0 3px;">¬∑</span><span>'+sports+'</span>' : ''}
                    </div>
                </div>
                <div style="text-align:right;flex-shrink:0;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--green);">${p.earnings.toFixed(1)}</div>
                    <div style="font-size:9px;color:var(--muted);letter-spacing:.5px;">W1N</div>
                </div>`;
            list.appendChild(row);
        });
        const hint = document.createElement('p');
        hint.style.cssText='color:var(--muted);font-size:11px;text-align:center;margin-top:14px;';
        hint.textContent='Updates every 60 seconds';
        list.appendChild(hint);
    } catch(e) {
        list.innerHTML = '<div class="error">Failed to load leaderboard.</div>';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONBOARDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dismissFirstTimeBanner() {
    document.getElementById('first-time-banner').classList.add('hidden');
    localStorage.setItem('w1nnr_onboarding_dismissed','true');
}
function checkFirstTimeUser() {
    if (localStorage.getItem('w1nnr_onboarding_dismissed'))
        document.getElementById('first-time-banner').classList.add('hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WALLET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function connectWallet() {
    try {
        if (!window.ethereum) { alert('Please install MetaMask!'); return; }
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const network = await provider.getNetwork();
        if (network.chainId !== BigInt(CONFIG.CHAIN_ID)) {
            try {
                await window.ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:'0x'+CONFIG.CHAIN_ID.toString(16)}]});
                provider = new ethers.BrowserProvider(window.ethereum);
            } catch {
                alert('Please switch to PulseChain (Chain ID 369) in MetaMask');
                return;
            }
        }
        signer      = await provider.getSigner();
        userAddress = await signer.getAddress();
        factoryContract = new ethers.Contract(CONFIG.FACTORY_ADDRESS, FACTORY_ABI, signer);
        w1nContract     = new ethers.Contract(CONFIG.W1N_ADDRESS,     ERC20_ABI,   signer);
        if (CONFIG.TOURNAMENT_FACTORY) {
            tournamentFactoryContract = new ethers.Contract(CONFIG.TOURNAMENT_FACTORY, TOURNAMENT_FACTORY_ABI, signer);
        }
        // tournamentFactoryContract initialized here (declared in tournament section below)

        document.getElementById('not-connected').classList.add('hidden');
        document.getElementById('connected').classList.remove('hidden');

        await loadBalance();
        loadUsername();
        refreshProfileUI();
        refreshProfileStats();

        // Load profile from API ‚Äî shows onboarding if new user
        const returning = await loadUserProfile();
        if (!returning) {
            showOnboarding();
        } else {
            checkFirstTimeUser();
        }

        const def = new Date(); def.setHours(def.getHours()+2);
        document.getElementById('create-time').value = def.toISOString().slice(0,16);
        // Set default tournament deadline 3 days from now
        const tDef = new Date(); tDef.setDate(tDef.getDate()+3);
        const tDeadlineEl = document.getElementById('t-create-deadline');
        if (tDeadlineEl) tDeadlineEl.value = tDef.toISOString().slice(0,16);

        await loadMatches();
        checkPendingChallenges();

        if (userAddress.toLowerCase() === ADMIN_WALLET.toLowerCase()) {
            document.getElementById('admin-panel').classList.remove('hidden');
        }

        window.ethereum.on('accountsChanged', () => location.reload());
        window.ethereum.on('chainChanged',    () => location.reload());
    } catch(e) {
        console.error(e);
        alert('Failed to connect: ' + e.message);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHALLENGE ALERT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkPendingChallenges() {
    try {
        const addrs = await factoryContract.getUserMatches(userAddress);
        if (!addrs.length) return;
        const challenges = [];
        await Promise.all([...addrs].reverse().map(async (addr) => {
            try {
                const e = new ethers.Contract(addr, ESCROW_ABI, getStaticProvider());
                const [p1, p2, fee, st, p2Dep, isInstant] = await Promise.all([
                    e.player1(), e.player2(), e.entryFee(), e.status(), e.p2Deposited(), e.isInstantMatch()
                ]);
                const isP2 = p2.toLowerCase() === userAddress.toLowerCase();
                if (isP2 && Number(st) === 0 && !p2Dep) challenges.push({ addr, p1, fee, isInstant });
            } catch(e) { /* skip */ }
        }));
        if (!challenges.length) return;
        const alertEl = document.getElementById('challenge-alert');
        alertEl.classList.remove('hidden');
        const items = challenges.slice(0, 3).map(c => {
            const fmtFee = parseFloat(ethers.formatUnits(c.fee, CONFIG.TOKEN_DECIMALS)).toFixed(2);
            const prize  = (parseFloat(fmtFee) * 2 * 0.92).toFixed(2);
            return `
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                <div style="flex:1;min-width:0;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:1px;color:var(--text);">${getDisplayName(c.p1)} challenged you</div>
                    <div style="font-size:12px;color:rgba(240,242,248,0.5);margin-top:2px;">${c.isInstant?'‚ö° INSTANT':'üìÖ SCHEDULED'} ¬∑ <strong style="color:var(--green);">${fmtFee} W1N</strong> entry ¬∑ <strong style="color:var(--accent);">${prize} W1N</strong> prize</div>
                </div>
                <button onclick="dismissChallengeAlert();viewMatch('${c.addr}')"
                    style="flex-shrink:0;padding:10px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--red),var(--orange));color:#fff;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:1px;cursor:pointer;">
                    VIEW ‚Üí
                </button>
            </div>`;
        }).join('');
        alertEl.innerHTML = `
        <div class="challenge-alert-inner" style="background:linear-gradient(135deg,rgba(255,59,92,0.15),rgba(255,123,44,0.1));border:1.5px solid rgba(255,59,92,0.5);border-radius:18px;padding:18px 20px;margin:0 0 16px;position:relative;">
            <button onclick="dismissChallengeAlert()" style="position:absolute;top:12px;right:14px;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:20px;line-height:1;padding:0;">√ó</button>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                <span style="font-size:28px;animation:livePulse 1s ease-in-out infinite;">üî•</span>
                <div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--red);">YOU'VE BEEN CHALLENGED</div>
                    <div style="font-size:11px;color:rgba(240,242,248,0.5);margin-top:1px;letter-spacing:.5px;">DEPOSIT TO ACCEPT ‚Äî DON'T LEAVE THEM WAITING</div>
                </div>
            </div>
            ${items}
        </div>`;
    } catch(e) { console.error('checkPendingChallenges:', e); }
}
function dismissChallengeAlert() {
    const el = document.getElementById('challenge-alert');
    el.classList.add('hidden');
    el.innerHTML = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadBalance() {
    const balEl = document.getElementById('w1n-balance');
    const currentText = balEl?.textContent || '0';
    const prev = parseFloat(currentText.replace(/[^0-9.]/g, '')) || null;
    return await loadBalanceAnimated(prev);
}

async function loadMatches() {
    const list = document.getElementById('matches-list');
    list.innerHTML = '<div class="loading">Loading...</div>';
    try {
        // Use staticFactory (no wallet needed) for browsing
        let addrs;
        if (activeSportFilter === 0) {
            // "All sports" ‚Äî V4 getOpenMatches may not accept 0, so use getRecentMatches
            // then we'll filter by status=Open when rendering
            try {
                addrs = await getStaticFactory().getOpenMatches(0, 20);
            } catch {
                // Fallback: getRecentMatches and filter to Open status only
                const recent = await getStaticFactory().getRecentMatches(30);
                const statuses = await Promise.all(
                    recent.map(a => new ethers.Contract(a, ESCROW_ABI, getStaticProvider()).status())
                );
                addrs = recent.filter((_, i) => Number(statuses[i]) === 0);
                if (addrs.length > 20) addrs = addrs.slice(0, 20);
            }
        } else {
            addrs = await getStaticFactory().getOpenMatches(activeSportFilter, 20);
        }
        if (!addrs.length) {
            list.innerHTML = `
                <div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:14px;">üéØ</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:10px;">No Open Matches Yet</div>
                    <p style="color:var(--muted);margin-bottom:20px;font-size:13px;">Be the first to create a match!</p>
                    <button class="btn btn-instant" style="max-width:220px;margin:0 auto;" onclick="showTab('create',document.querySelectorAll('.tab')[1])">‚ö° Create Instant Match</button>
                </div>`;
            return;
        }
        list.innerHTML = '';
        const nowSec = Math.floor(Date.now() / 1000);
        let renderedCount = 0;

        for (const addr of addrs) {
            const e = new ethers.Contract(addr, ESCROW_ABI, getStaticProvider());
            const [p1, fee, t, isInstant, sportIdRaw, statusRaw] = await Promise.all([
                e.player1(), e.entryFee(), e.scheduledTime(), e.isInstantMatch(), e.sportId(), e.status()
            ]);

            const status = Number(statusRaw);
            const matchTs = Number(t);
            const isExpiredOpen = isClientExpiredOpenMatch(status, isInstant, matchTs);
            if (status !== 0 || isExpiredOpen) continue;

            const fmtFee  = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(2);
            const time    = new Date(matchTs * 1000);
            const nowMs   = Date.now();
            const isLive  = isInstant && (nowMs >= matchTs * 1000);
            const sport   = sportLabel(sportIdRaw);
            const item    = document.createElement('div');
            item.className = 'match-item';
            item.onclick   = () => viewMatch(addr);
            item.innerHTML = `
                <div class="match-header">
                    <div class="player-chip">
                        ${avatarHTML(p1,'avatar-sm','')}
                        <span style="font-weight:700;font-size:14px;">${getDisplayName(p1)}</span>
                    </div>
                    <div class="match-fee">${fmtFee} W1N</div>
                </div>
                <div class="match-details">
                    <span style="font-size:13px;">${sport}</span>
                    ${isInstant
                        ? `<span><span class="live-dot"></span>${isLive ? 'LIVE NOW' : 'Instant ¬∑ Live on deposit'}</span>`
                        : `<span>üìÖ ${time.toLocaleDateString()} ${time.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`
                    }
                    <span class="status-badge ${isInstant?'status-instant':'status-open'}">${isInstant?'‚ö° INSTANT':'OPEN'}</span>
                </div>`;
            list.appendChild(item);
            renderedCount++;
        }

        if (renderedCount === 0) {
            list.innerHTML = `
                <div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:14px;">üßπ</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:10px;">No Open Matches Right Now</div>
                    <p style="color:var(--muted);margin-bottom:20px;font-size:13px;">Expired match listings were auto-cleared.</p>
                    <button class="btn btn-instant" style="max-width:220px;margin:0 auto;" onclick="showTab('create',document.querySelectorAll('.tab')[1])">‚ö° Create Instant Match</button>
                </div>`;
        }
    } catch(e) {
        console.error(e);
        list.innerHTML = '<div class="error">Failed to load matches. Check your connection.</div>';
    }
}

async function loadMyMatches() {
    const list = document.getElementById('my-matches-list');
    list.innerHTML = '<div class="loading">Loading...</div>';
    try {
        const addrs = await factoryContract.getUserMatches(userAddress);
        if (!addrs.length) {
            list.innerHTML = `
                <div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:14px;">üéÆ</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:10px;">No Matches Yet</div>
                    <p style="color:var(--muted);margin-bottom:20px;font-size:13px;">Create or join a match to get started.</p>
                    <div style="display:flex;gap:10px;justify-content:center;">
                        <button class="btn btn-secondary" style="width:auto;padding:10px 18px;" onclick="showTab('matches',document.querySelectorAll('.tab')[0])">Browse</button>
                        <button class="btn btn-instant"   style="width:auto;padding:10px 18px;" onclick="showTab('create', document.querySelectorAll('.tab')[1])">‚ö° Play Now</button>
                    </div>
                </div>`;
            return;
        }
        list.innerHTML = '';
        for (const addr of [...addrs].reverse()) {
            const e = new ethers.Contract(addr, ESCROW_ABI, getStaticProvider());
            const [p1,p2,fee,t,st,isInstant,sportIdRaw] = await Promise.all([
                e.player1(),e.player2(),e.entryFee(),e.scheduledTime(),e.status(),e.isInstantMatch(),e.sportId()
            ]);
            const fmtFee     = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(2);
            const matchTs    = Number(t);
            const time       = new Date(matchTs * 1000);
            const statusNum  = Number(st);
            const statusText = STATUS_MAP[statusNum]||'Unknown';
            const opponent   = p1.toLowerCase()===userAddress.toLowerCase() ? p2 : p1;
            const isOpen     = opponent === ethers.ZeroAddress;
            if (isOpen && isClientExpiredOpenMatch(statusNum, isInstant, matchTs)) continue;
            const sport      = sportLabel(sportIdRaw);
            const item = document.createElement('div');
            item.className = 'match-item';
            item.onclick   = () => viewMatch(addr);
            item.innerHTML = `
                <div class="match-header">
                    <div class="player-chip">
                        ${isOpen
                            ? '<div class="avatar avatar-sm" style="background:var(--surface);border:1px dashed var(--border);">?</div>'
                            : avatarHTML(opponent,'avatar-sm','')
                        }
                        <span style="font-weight:700;font-size:14px;">vs ${isOpen?'Open Slot':getDisplayName(opponent)}</span>
                    </div>
                    <div class="match-fee">${fmtFee} W1N</div>
                </div>
                <div class="match-details">
                    <span>${sport}</span>
                    ${isInstant ? '<span>‚ö° Instant</span>' : `<span>üìÖ ${time.toLocaleDateString()}</span>`}
                    <span class="status-badge status-${statusText.toLowerCase()}">${statusText}</span>
                </div>`;
            list.appendChild(item);
        }
    } catch(e) {
        console.error(e);
        list.innerHTML = '<div class="error">Failed to load your matches.</div>';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREATE MATCH ‚Äî V4 routing
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function createMatch() {
    const oppInput  = document.getElementById('create-opponent').value.trim();
    const feeInput  = document.getElementById('create-fee').value;
    const timeInput = document.getElementById('create-time').value;
    const errDiv    = document.getElementById('create-error');
    const okDiv     = document.getElementById('create-success');
    const btn       = document.getElementById('create-btn');

    errDiv.classList.add('hidden'); okDiv.classList.add('hidden');

    const feeNum = parseFloat(feeInput);
    if (!feeInput || feeNum < CONFIG.MIN_FEE) {
        errDiv.textContent = `Minimum entry fee is ${CONFIG.MIN_FEE} W1N`;
        return errDiv.classList.remove('hidden');
    }
    if (oppInput && !ethers.isAddress(oppInput)) {
        errDiv.textContent = 'Invalid opponent address';
        return errDiv.classList.remove('hidden');
    }
    const hasOpponent = oppInput && oppInput !== '';
    if (hasOpponent && oppInput.toLowerCase() === userAddress.toLowerCase()) {
        errDiv.textContent = 'You cannot play against yourself';
        return errDiv.classList.remove('hidden');
    }
    if (matchTypeMode === 'scheduled') {
        if (!timeInput) {
            errDiv.textContent = 'Please select a scheduled time';
            return errDiv.classList.remove('hidden');
        }
        const scheduledTime = Math.floor(new Date(timeInput).getTime()/1000);
        if (scheduledTime < Math.floor(Date.now()/1000) + 300) {
            errDiv.textContent = 'Match must be at least 5 minutes from now';
            return errDiv.classList.remove('hidden');
        }
    }

    btn.disabled = true;
    okDiv.textContent='Sending transaction...'; okDiv.classList.remove('hidden');

    try {
        const fee     = ethers.parseUnits(feeInput, CONFIG.TOKEN_DECIMALS);
        const sportId = selectedSportId;
        let tx;

        if (matchTypeMode === 'instant') {
            btn.textContent = 'Creating Instant Match...';
            if (hasOpponent) {
                // Private instant match ‚Äî specific opponent
                tx = await factoryContract.createInstantMatch(oppInput, fee, sportId);
            } else {
                // Open instant match ‚Äî anyone can join
                tx = await factoryContract.createOpenInstantMatch(fee, sportId);
            }
        } else {
            btn.textContent = 'Creating Match...';
            const scheduledTime = Math.floor(new Date(timeInput).getTime()/1000);
            if (hasOpponent) {
                // Private scheduled match
                tx = await factoryContract.createMatch(oppInput, fee, scheduledTime, sportId);
            } else {
                // Open scheduled match
                tx = await factoryContract.createOpenMatch(fee, scheduledTime, sportId);
            }
        }

        okDiv.textContent='Waiting for confirmation...';
        await tx.wait();
        okDiv.textContent = matchTypeMode === 'instant'
            ? '‚úÖ Instant match created! Go to My Matches to deposit now.'
            : '‚úÖ Match scheduled! Go to My Matches to deposit.';

        document.getElementById('create-opponent').value = '';
        document.getElementById('create-fee').value = '50';
        setTimeout(() => { loadMatches(); loadMyMatches(); showTab('my-matches', document.querySelectorAll('.tab')[2]); }, 2000);
    } catch(e) {
        errDiv.textContent = 'Failed: ' + parseContractError(e);
        errDiv.classList.remove('hidden'); okDiv.classList.add('hidden');
    } finally {
        btn.disabled = false;
        btn.textContent = matchTypeMode === 'instant' ? '‚ö° Create Instant Match' : 'üìÖ Create Scheduled Match';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATCH HYPE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateMatchHype(p1Stats, p2Stats, p2Joined) {
    if (!p2Joined) return {line:"WAITING FOR A CHALLENGER",color:"var(--muted)",icon:"‚è≥"};
    const wr1 = parseFloat(calcWinRate(p1Stats));
    const wr2 = parseFloat(calcWinRate(p2Stats));
    const t1  = p1Stats.wins + p1Stats.losses;
    const t2  = p2Stats.wins + p2Stats.losses;
    const diff= Math.abs(wr1-wr2);
    if (t1<2&&t2<2)              return {line:"ROOKIE SHOWDOWN ‚Äî RECORDS START HERE",        color:"var(--accent)", icon:"üÜï"};
    if (t1<2||t2<2)              return {line:"VETERAN VS NEWCOMER ‚Äî PROVE YOURSELF",         color:"var(--orange)",icon:"‚ö°"};
    if (diff>25&&Math.min(wr1,wr2)<40) return {line:"UNDERDOG OPPORTUNITY ‚Äî UPSET THE LADDER",color:"var(--orange)",icon:"üî•"};
    if (wr1>=70&&wr2>=70)        return {line:"HEAVYWEIGHT CLASH ‚Äî UNDEFEATED VS UNDEFEATED", color:"var(--gold)",  icon:"üëë"};
    if (wr1>=60&&wr2>=60)        return {line:"TOP TIER COLLISION ‚Äî BOTH CAME TO W1N",        color:"var(--green)", icon:"üí•"};
    if (diff>20)                 return {line:"FAVORED VS HUNGRY ‚Äî ANYTHING CAN HAPPEN",      color:"var(--accent)",icon:"üéØ"};
    return                              {line:"EVEN ODDS ‚Äî MAY THE BEST COMPETITOR W1N",      color:"var(--text)",  icon:"‚öîÔ∏è"};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MUTUAL CANCEL BLOCK ‚Äî reusable UI fragment
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mutualCancelBlock(address, isP1, p1Wants, p2Wants, isPlayer) {
    if (!isPlayer) return '';
    const iWant    = isP1 ? p1Wants : p2Wants;
    const theyWant = isP1 ? p2Wants : p1Wants;
    if (iWant && theyWant) return ''; // already firing in contract
    return `
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);">
        ${theyWant
            ? `<div style="background:rgba(255,215,0,0.07);border:1px solid rgba(255,215,0,0.3);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                   <span style="font-size:20px;">ü§ù</span>
                   <span style="font-size:13px;color:rgba(240,242,248,0.7);">Your opponent wants a <strong style="color:var(--gold);">no-contest</strong>. Agree to split stakes equally.</span>
               </div>`
            : iWant
            ? `<div style="background:rgba(0,255,136,0.06);border:1px solid rgba(0,255,136,0.2);border-radius:12px;padding:12px 16px;font-size:13px;color:rgba(240,242,248,0.6);margin-bottom:10px;">
                   ‚úÖ You requested no-contest. Waiting for opponent to agree.
               </div>`
            : ''
        }
        <button id="mutual-cancel-btn" onclick="requestMutualCancel('${address}')"
            style="width:100%;padding:11px;border:1px solid rgba(150,150,150,0.2);border-radius:12px;background:rgba(150,150,150,0.06);color:var(--muted);font-size:13px;font-weight:700;cursor:pointer;letter-spacing:.5px;text-transform:uppercase;font-family:'DM Sans',sans-serif;"
            ${iWant ? 'disabled' : ''}>
            ü§ù ${theyWant ? 'AGREE ‚Äî SPLIT NO-CONTEST' : iWant ? 'NO-CONTEST REQUESTED' : 'REQUEST NO-CONTEST'}
        </button>
        <p style="color:var(--muted);font-size:11px;text-align:center;margin-top:6px;">Both players must agree ¬∑ Stakes split equally</p>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW MATCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function viewMatch(address) {
    document.getElementById('tab-matches').classList.add('hidden');
    document.getElementById('tab-my-matches').classList.add('hidden');
    document.getElementById('match-detail').classList.remove('hidden');
    const content = document.getElementById('match-detail-content');
    content.innerHTML = '<div class="loading">Loading match details...</div>';

    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, getStaticProvider());
        const [p1, p2, fee, schTime, stNum, isOpen, isInstant, p1Dep, p2Dep,
               p1Check, p2Check, netPotRaw, p1Reported, p2Reported, sportIdRaw] = await Promise.all([
            escrow.player1(), escrow.player2(), escrow.entryFee(),
            escrow.scheduledTime(), escrow.status(), escrow.isOpenMatch(),
            escrow.isInstantMatch(), escrow.p1Deposited(), escrow.p2Deposited(),
            escrow.p1CheckedIn(), escrow.p2CheckedIn(), escrow.netPot(),
            escrow.p1ReportedWinner(), escrow.p2ReportedWinner(), escrow.sportId(),
        ]);
        // Mutual cancel flags ‚Äî optional, not all V4 escrow builds expose these
        const [p1MutualCancel, p2MutualCancel] = await Promise.all([
            escrow.p1WantsMutualCancel().catch(() => false),
            escrow.p2WantsMutualCancel().catch(() => false),
        ]);

        const fmtFee  = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(2);
        const prize   = netPotRaw > 0n
            ? parseFloat(ethers.formatUnits(netPotRaw, CONFIG.TOKEN_DECIMALS)).toFixed(2)
            : (parseFloat(fmtFee)*2*0.92).toFixed(2);
        const time       = new Date(Number(schTime)*1000);
        const status     = Number(stNum);
        const statusText = STATUS_MAP[status]||'Unknown';
        const isP1       = p1.toLowerCase()===userAddress.toLowerCase();
        const isP2       = p2.toLowerCase()===userAddress.toLowerCase();
        const isPlayer   = isP1||isP2;
        const p2Joined   = p2.toLowerCase()!==ethers.ZeroAddress.toLowerCase();
        const nowMs      = Date.now();
        const schMs      = Number(schTime)*1000;
        const p1Stats    = await getPlayerStats(p1);
        const p2Stats    = p2Joined ? await getPlayerStats(p2) : {wins:0,losses:0,earnings:0};
        const hype       = generateMatchHype(p1Stats, p2Joined ? p2Stats : null, p2Joined);
        const sport      = sportLabel(sportIdRaw);

        const instantBadge = isInstant
            ? `<div class="instant-banner" style="margin-bottom:12px;">
                <span class="live-dot"></span>
                <strong style="color:var(--orange);">‚ö° INSTANT MATCH</strong>
                ${nowMs >= schMs ? ' ‚Äî <strong style="color:var(--green);">LIVE NOW</strong>' : ` ‚Äî Starts ${time.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`}
              </div>`
            : '';

        let html = instantBadge + `
            <div style="font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:1px;color:var(--muted);margin-bottom:6px;">${sport}</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:1.5px;color:${hype.color};margin-bottom:8px;display:flex;align-items:center;gap:6px;">
                <span>${hype.icon}</span><span>${hype.line}</span>
            </div>
            <div class="matchup-card${status===5?' settle-glow':''}">
                <div class="matchup-player">
                    ${avatarHTML(p1,'avatar-sm',isP1?'accent-ring':'')}
                    <div style="margin-top:8px;">
                        <div style="font-weight:800;font-size:14px;">${getDisplayName(p1)}</div>
                        <div class="matchup-stat">${p1Stats.wins}W-${p1Stats.losses}L ¬∑ ${calcWinRate(p1Stats)}%</div>
                        ${p1Dep ? '<div style="font-size:10px;color:var(--green);margin-top:2px;">‚úÖ Deposited</div>' : '<div style="font-size:10px;color:var(--muted);margin-top:2px;">‚è≥ Awaiting deposit</div>'}
                    </div>
                </div>
                <div class="matchup-vs">VS</div>
                <div class="matchup-player right">
                    ${p2Joined
                        ? avatarHTML(p2,'avatar-sm',isP2?'accent-ring':'')
                        : '<div class="avatar avatar-sm" style="background:var(--surface);border:1px dashed var(--border);">?</div>'
                    }
                    <div style="margin-top:8px;text-align:right;">
                        <div style="font-weight:800;font-size:14px;">${p2Joined?getDisplayName(p2):'Open Slot'}</div>
                        <div class="matchup-stat">${p2Joined?`${p2Stats.wins}W-${p2Stats.losses}L ¬∑ ${calcWinRate(p2Stats)}%`:'Awaiting opponent'}</div>
                        ${p2Joined ? (p2Dep ? '<div style="font-size:10px;color:var(--green);margin-top:2px;">‚úÖ Deposited</div>' : '<div style="font-size:10px;color:var(--muted);margin-top:2px;">‚è≥ Awaiting deposit</div>') : ''}
                    </div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0;">
                <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--green);">${fmtFee} W1N</div>
                    <div style="font-size:10px;color:var(--muted);font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-top:2px;">Entry Each</div>
                </div>
                <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);">${prize} W1N</div>
                    <div style="font-size:10px;color:var(--muted);font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-top:2px;">Prize Pool</div>
                </div>
            </div>
            <div style="font-size:11px;color:var(--muted);text-align:center;margin:-4px 0 8px;letter-spacing:.3px;">
                8% platform fee taken at creation ¬∑ Winner receives full prize pool ¬∑ üîí No admin intervention
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);margin-bottom:4px;">
                <span style="color:var(--muted);font-size:13px;">${isInstant ? '‚ö° Instant' : 'üìÖ ' + time.toLocaleString()}</span>
                <span class="status-badge status-${statusText.toLowerCase()}">${statusText}</span>
            </div>`;

        // ‚îÄ‚îÄ ACTION AREA ‚îÄ‚îÄ

        if (status === 0) {
            if (isOpen && !p2Joined) {
                if (isP1) {
                    html += `
                    <div style="margin-top:16px;background:linear-gradient(135deg,rgba(255,123,44,0.12),rgba(255,215,0,0.08));border:1px solid rgba(255,123,44,0.35);border-radius:16px;padding:20px;text-align:center;">
                        <div style="font-size:36px;margin-bottom:8px;">üéØ</div>
                        <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--orange);margin-bottom:6px;">MATCH IS LIVE ‚Äî WAITING FOR CHALLENGER</div>
                        <p style="color:rgba(240,242,248,0.6);font-size:13px;line-height:1.6;margin-bottom:16px;">Your match is in the queue. Share it with your opponent.</p>
                        ${!p1Dep
                            ? `<button class="btn btn-instant" id="action-btn" onclick="depositToMatch('${address}')" style="max-width:280px;margin:0 auto;">üí∞ Lock In ‚Äî Deposit ${fmtFee} W1N</button>
                               ${noobHint('Depositing locks in your stake. Pre-deposit now so the match funds the moment your opponent joins.')}`
                            : `<div style="display:inline-flex;align-items:center;gap:8px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.25);border-radius:10px;padding:10px 18px;"><span style="color:var(--green);font-weight:800;">‚úÖ YOU'RE LOCKED IN</span><span style="color:var(--muted);font-size:12px;">Waiting for opponent to deposit</span></div>`
                        }
                    </div>`;
                } else {
                    html += `
                    <div style="margin-top:16px;background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(0,255,136,0.06));border:1px solid rgba(0,212,255,0.3);border-radius:16px;padding:20px;text-align:center;">
                        <div style="font-size:36px;margin-bottom:8px;">‚öîÔ∏è</div>
                        <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--accent);margin-bottom:6px;">CHALLENGER NEEDED</div>
                        <p style="color:rgba(240,242,248,0.6);font-size:13px;margin-bottom:16px;">Step up for <strong style="color:var(--accent);">${sport}</strong> ‚Äî put <strong style="color:var(--green);">${prize} W1N</strong> on the line. One tap to join and deposit.</p>
                        <button class="btn btn-primary" id="action-btn" onclick="joinAndDepositMatch('${address}','${fmtFee}')" style="max-width:280px;margin:0 auto;font-size:16px;">‚ö° ACCEPT ${sport} CHALLENGE ‚Äî ${fmtFee} W1N</button>
                        ${noobHint('This joins the match and deposits your stake in one tx. MetaMask will pop up twice ‚Äî once to approve the token, once to confirm the deposit.')}
                    </div>`;
                }
            } else if (p2Joined && isPlayer) {
                const myDep = isP1 ? p1Dep : p2Dep;
                if (myDep) {
                    html += `
                    <div style="margin-top:16px;background:rgba(0,255,136,0.07);border:1px solid rgba(0,255,136,0.25);border-radius:16px;padding:20px;text-align:center;">
                        <div style="font-size:32px;margin-bottom:8px;">‚è≥</div>
                        <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;color:var(--green);margin-bottom:6px;">YOU'RE LOCKED IN</div>
                        <p style="color:rgba(240,242,248,0.6);font-size:13px;">Waiting for <strong style="color:var(--text);">${getDisplayName(isP1?p2:p1)}</strong> to deposit their stake.</p>
                    </div>`;
                } else {
                    html += `
                    <div style="margin-top:16px;background:linear-gradient(135deg,rgba(255,123,44,0.12),rgba(255,215,0,0.08));border:1px solid rgba(255,123,44,0.4);border-radius:16px;padding:20px;text-align:center;">
                        <div style="font-size:36px;margin-bottom:8px;">üî•</div>
                        <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--orange);margin-bottom:6px;">OPPONENT IS IN ‚Äî YOUR MOVE</div>
                        <p style="color:rgba(240,242,248,0.6);font-size:13px;margin-bottom:16px;"><strong style="color:var(--text);">${getDisplayName(isP1?p2:p1)}</strong> is in. Deposit to lock it in.</p>
                        <button class="btn btn-instant" id="action-btn" onclick="depositToMatch('${address}')" style="max-width:280px;margin:0 auto;font-size:16px;">üí∞ LOCK IN ‚Äî DEPOSIT ${fmtFee} W1N</button>
                    </div>`;
                }
            } else if (!isOpen && isPlayer) {
                const myDep = isP1 ? p1Dep : p2Dep;
                if (myDep) {
                    html += `
                    <div style="margin-top:16px;background:rgba(0,255,136,0.07);border:1px solid rgba(0,255,136,0.25);border-radius:16px;padding:20px;text-align:center;">
                        <div style="font-size:32px;margin-bottom:8px;">‚è≥</div>
                        <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;color:var(--green);margin-bottom:6px;">YOU'RE LOCKED IN</div>
                        <p style="color:rgba(240,242,248,0.6);font-size:13px;">Waiting for <strong style="color:var(--text);">${getDisplayName(isP1?p2:p1)}</strong> to deposit.</p>
                    </div>`;
                } else {
                    html += `
                    <div style="margin-top:16px;background:linear-gradient(135deg,rgba(255,123,44,0.12),rgba(255,215,0,0.08));border:1px solid rgba(255,123,44,0.4);border-radius:16px;padding:20px;text-align:center;">
                        <div style="font-size:36px;margin-bottom:8px;">üéØ</div>
                        <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--orange);margin-bottom:6px;">PRIVATE MATCH ‚Äî DEPOSIT TO PLAY</div>
                        <p style="color:rgba(240,242,248,0.6);font-size:13px;margin-bottom:16px;">You've been challenged by <strong style="color:var(--text);">${getDisplayName(isP1?p2:p1)}</strong>.</p>
                        <button class="btn btn-instant" id="action-btn" onclick="depositToMatch('${address}')" style="max-width:280px;margin:0 auto;font-size:16px;">üí∞ ACCEPT ‚Äî DEPOSIT ${fmtFee} W1N</button>
                    </div>`;
                }
            }
        }

        else if (status === 1) {
            const checkinEnd  = schMs + 30*60*1000;
            const myCheckedIn = isP1 ? p1Check : p2Check;
            const minsToMatch = Math.round((schMs - nowMs) / 60000);
            const minsLeft    = Math.round((checkinEnd - nowMs) / 60000);
            let actionDisabled = '';
            let statusBlock = '';
            if (nowMs < schMs) {
                statusBlock = `
                <div style="margin-top:16px;background:rgba(255,165,0,0.07);border:1px solid rgba(255,165,0,0.25);border-radius:16px;padding:20px;text-align:center;">
                    <div style="font-size:32px;margin-bottom:8px;">‚è∞</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;color:#ffa500;margin-bottom:6px;">STAKES LOCKED ‚Äî MATCH STARTING SOON</div>
                    <p style="color:rgba(240,242,248,0.6);font-size:13px;">Check-in opens in <strong style="color:var(--text);">${minsToMatch} min</strong>. Get ready.</p>
                </div>`;
                actionDisabled = 'disabled';
            } else if (nowMs <= checkinEnd) {
                statusBlock = `
                <div style="margin-top:16px;background:linear-gradient(135deg,rgba(138,43,226,0.15),rgba(0,212,255,0.08));border:1px solid rgba(138,43,226,0.4);border-radius:16px;padding:20px;text-align:center;animation:settlePulse 2s ease-in-out infinite;">
                    <div style="font-size:36px;margin-bottom:8px;">üö®</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:#bf5fff;margin-bottom:6px;">CHECK-IN WINDOW OPEN</div>
                    <p style="color:rgba(240,242,248,0.7);font-size:13px;margin-bottom:4px;"><strong style="color:var(--text);">${minsLeft} min left</strong> to confirm you're ready.</p>
                </div>`;
            } else {
                statusBlock = `
                <div style="margin-top:16px;background:rgba(255,59,92,0.07);border:1px solid rgba(255,59,92,0.25);border-radius:16px;padding:20px;text-align:center;">
                    <div style="font-size:32px;margin-bottom:8px;">‚ùå</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;color:var(--red);margin-bottom:6px;">CHECK-IN WINDOW CLOSED</div>
                    <p style="color:rgba(240,242,248,0.6);font-size:13px;">The window passed. Claim your refund below.</p>
                </div>`;
                actionDisabled = 'disabled';
            }
            html += statusBlock;
            if (myCheckedIn) {
                html += `<div style="margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px;background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.2);border-radius:12px;padding:12px;">
                    <span style="font-size:20px;">‚úÖ</span>
                    <span style="font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;color:var(--green);">YOU'RE CHECKED IN ‚Äî WAITING FOR OPPONENT</span>
                </div>`;
            } else if (isPlayer) {
                html += `<button class="btn" id="action-btn" onclick="checkInToMatch('${address}')" style="margin-top:12px;background:linear-gradient(135deg,#7b2fff,#00d4ff);color:#fff;font-size:16px;" ${actionDisabled}>üéÆ CHECK IN ‚Äî I'M READY</button>`;
            }
            if (actionDisabled && nowMs > checkinEnd && isPlayer) {
                html += `<button class="btn btn-danger" onclick="expireMatch('${address}')" style="margin-top:8px;">‚Ü© Claim Refund (No-Show)</button>`;
            }
            // Mutual cancel available at Funded stage
            if (isPlayer) html += mutualCancelBlock(address, isP1, p1MutualCancel, p2MutualCancel, isPlayer);
        }

        else if (status === 2 && isPlayer) {
            const deadline = new Date(schMs + 30*60*1000 + 24*3600*1000);
            html += `
            <div style="margin-top:16px;background:linear-gradient(135deg,rgba(138,43,226,0.18),rgba(255,59,92,0.1));border:1px solid rgba(138,43,226,0.5);border-radius:16px;padding:20px;text-align:center;animation:settlePulse 1.5s ease-in-out infinite;">
                <div style="font-size:40px;margin-bottom:8px;">üî•</div>
                <div style="font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:3px;color:#bf5fff;margin-bottom:4px;">MATCH IN PROGRESS</div>
                <p style="color:rgba(240,242,248,0.6);font-size:12px;">GO PLAY. Come back and report when it's done.</p>
                <p style="color:var(--muted);font-size:11px;margin-top:4px;">‚è∞ Report by ${deadline.toLocaleString()}</p>
            </div>
            <div style="margin-top:14px;">
                <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--text);text-align:center;margin-bottom:10px;">Who is the W1NNR?</div>
                <div style="display:flex;gap:8px;">
                    <button class="btn" id="action-btn-p1" onclick="reportWin('${address}','${isP1?p1:p2}')"
                        style="flex:1;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-size:22px;letter-spacing:2px;font-family:'Bebas Neue',sans-serif;">W1N</button>
                    <button class="btn" id="action-btn-p2" onclick="reportWin('${address}','${isP1?p2:p1}')"
                        style="flex:1;background:rgba(255,59,92,0.15);color:var(--red);border:1px solid rgba(255,59,92,0.35);font-size:22px;letter-spacing:2px;font-family:'Bebas Neue',sans-serif;">LOSS</button>
                </div>
                ${noobHint('Both players report independently. Same result = instant payout. Different result = 48hr dispute window, then equal split. Neither reports in 24h = stakes burn to treasury.')}
            </div>
            ${mutualCancelBlock(address, isP1, p1MutualCancel, p2MutualCancel, isPlayer)}`;
        }

        else if (status === 3 && isPlayer) {
            const iHaveReported = (isP1 && p1Reported !== ethers.ZeroAddress) || (isP2 && p2Reported !== ethers.ZeroAddress);
            if (iHaveReported) {
                html += `
                <div style="margin-top:16px;background:rgba(255,215,0,0.07);border:1px solid rgba(255,215,0,0.3);border-radius:16px;padding:20px;text-align:center;">
                    <div style="font-size:36px;margin-bottom:8px;">‚è≥</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;color:var(--gold);margin-bottom:6px;">OUTCOME REPORTED</div>
                    <p style="color:rgba(240,242,248,0.6);font-size:13px;">Waiting for <strong style="color:var(--text);">${getDisplayName(isP1?p2:p1)}</strong> to confirm. Agreement = instant settlement.</p>
                </div>`;
            } else {
                html += `
                <div style="margin-top:16px;background:linear-gradient(135deg,rgba(138,43,226,0.15),rgba(255,59,92,0.08));border:1px solid rgba(138,43,226,0.4);border-radius:16px;padding:20px;text-align:center;">
                    <div style="font-size:36px;margin-bottom:8px;">‚ö°</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:#bf5fff;margin-bottom:6px;">YOUR TURN TO REPORT</div>
                    <p style="color:rgba(240,242,248,0.6);font-size:13px;margin-bottom:4px;"><strong style="color:var(--text);">${getDisplayName(isP1?p2:p1)}</strong> already reported. Agree and it settles instantly.</p>
                </div>
                <div style="margin-top:12px;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--text);text-align:center;margin-bottom:10px;">Who is the W1NNR?</div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn" id="action-btn-p1" onclick="reportWin('${address}','${isP1?p1:p2}')"
                            style="flex:1;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-size:22px;letter-spacing:2px;font-family:'Bebas Neue',sans-serif;">W1N</button>
                        <button class="btn" id="action-btn-p2" onclick="reportWin('${address}','${isP1?p2:p1}')"
                            style="flex:1;background:rgba(255,59,92,0.15);color:var(--red);border:1px solid rgba(255,59,92,0.35);font-size:22px;letter-spacing:2px;font-family:'Bebas Neue',sans-serif;">LOSS</button>
                    </div>
                </div>`;
            }
            html += mutualCancelBlock(address, isP1, p1MutualCancel, p2MutualCancel, isPlayer);
        }

        else if (status === 4 && isPlayer) {
            html += `
            <div style="margin-top:16px;background:rgba(255,59,92,0.08);border:1px solid rgba(255,59,92,0.35);border-radius:16px;padding:20px;text-align:center;">
                <div style="font-size:36px;margin-bottom:8px;">‚ö†Ô∏è</div>
                <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;color:var(--red);margin-bottom:6px;">MATCH DISPUTED</div>
                <p style="color:rgba(240,242,248,0.6);font-size:13px;margin-bottom:14px;">Both players reported different outcomes. Unresolved after 48 hours = equal split.</p>
                <button class="btn btn-danger" onclick="resolveTimeout('${address}')">Check if Timeout Resolved</button>
            </div>
            ${mutualCancelBlock(address, isP1, p1MutualCancel, p2MutualCancel, isPlayer)}`;
        }

        else if (status === 5) {
            const winnerAddr = await escrow.winner();
            const iWon = winnerAddr.toLowerCase() === userAddress.toLowerCase();
            html += `
            <div style="margin-top:16px;background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(0,255,136,0.08));border:2px solid rgba(255,215,0,0.4);border-radius:16px;padding:24px;text-align:center;">
                <div style="font-size:48px;margin-bottom:10px;">${iWon ? 'üèÜ' : 'üíÄ'}</div>
                <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:3px;color:${iWon?'var(--gold)':'var(--muted)'};margin-bottom:6px;">
                    ${iWon ? 'YOU W1N' : 'BETTER LUCK NEXT TIME'}
                </div>
                <p style="color:rgba(240,242,248,0.6);font-size:13px;">
                    ${iWon
                        ? `<strong style="color:var(--green);">${prize} W1N</strong> sent to your wallet.`
                        : `<strong style="color:var(--text);">${getDisplayName(winnerAddr)}</strong> took the pot. Run it back.`
                    }
                </p>
            </div>`;
        }

        else if ([6,7,8].includes(status)) {
            const termMsg = {6:'Match cancelled. Funds returned.', 7:'Match expired. Funds returned.', 8:'No-show. Funds returned.'};
            html += `
            <div style="margin-top:16px;background:rgba(150,150,150,0.06);border:1px solid rgba(150,150,150,0.15);border-radius:16px;padding:20px;text-align:center;">
                <div style="font-size:32px;margin-bottom:8px;">üö´</div>
                <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px;">${statusText.toUpperCase()}</div>
                <p style="color:rgba(240,242,248,0.4);font-size:13px;">${termMsg[status]||'Match ended.'}</p>
            </div>`;
        }

        content.innerHTML = html;
    } catch(e) {
        console.error(e);
        content.innerHTML = '<div class="error">Failed to load match. Please try again.</div>';
    }
}

function closeMatchDetail() {
    document.getElementById('match-detail').classList.add('hidden');
    const active = document.querySelector('.tab.active');
    if (active?.textContent.trim()==='My Matches') {
        document.getElementById('tab-my-matches').classList.remove('hidden');
    } else {
        document.getElementById('tab-matches').classList.remove('hidden');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATCH ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function joinMatch(address) {
    if (!signer || !userAddress) { alert('Please connect your wallet first.'); return; }
    const btn = document.getElementById('action-btn');
    if(btn){btn.disabled=true;btn.textContent='Joining...';}
    const c = document.getElementById('match-detail-content');
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        addMsg(c,'success','Joining match...');
        await(await escrow.joinMatch()).wait();
        addMsg(c,'success','‚úÖ Joined! Now deposit to lock it in.');
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Failed to join: '+parseContractError(e));
        if(btn){btn.disabled=false;btn.textContent='‚ö° Join Match';}
    }
}

async function joinAndDepositMatch(address, fmtFee) {
    if (!signer || !userAddress) {
        alert('Please connect your wallet first.');
        return;
    }
    const btn = document.getElementById('action-btn');
    if(btn){btn.disabled=true;btn.textContent='Processing...';}
    const c = document.getElementById('match-detail-content');
    try {
        const escrow   = new ethers.Contract(address, ESCROW_ABI, signer);
        const entryFee = await escrow.entryFee();
        const allowance= await w1nContract.allowance(userAddress, address);
        if (allowance < entryFee) {
            addMsg(c,'success','Step 1/2: Approving W1N...');
            await(await w1nContract.approve(address, entryFee)).wait();
            addMsg(c,'success','‚úÖ Approved!');
        }
        addMsg(c,'success','Step 2/2: Joining & depositing...');
        await(await escrow.joinAndDeposit()).wait();
        addMsg(c,'success','‚úÖ Joined & deposited! Refreshing...');
        await loadBalance();
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Failed: '+parseContractError(e));
        if(btn){btn.disabled=false;btn.textContent=`‚ö° Accept Challenge ‚Äî ${fmtFee} W1N`;}
    }
}

async function depositToMatch(address) {
    if (!signer || !userAddress) { alert('Please connect your wallet first.'); return; }
    const btn = document.getElementById('action-btn');
    if(btn){btn.disabled=true;btn.textContent='Processing...';}
    const c = document.getElementById('match-detail-content');
    try {
        const escrow   = new ethers.Contract(address, ESCROW_ABI, signer);
        const entryFee = await escrow.entryFee();
        const allowance= await w1nContract.allowance(userAddress, address);
        if (allowance < entryFee) {
            addMsg(c,'success','Step 1/2: Approving W1N...');
            await(await w1nContract.approve(address, entryFee)).wait();
            addMsg(c,'success','‚úÖ Approved!');
        } else {
            addMsg(c,'success','Already approved ‚Äî depositing...');
        }
        addMsg(c,'success','Step 2/2: Depositing...');
        await(await escrow.deposit()).wait();
        addMsg(c,'success','‚úÖ Deposited! Refreshing...');
        await loadBalance();
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Deposit failed: '+parseContractError(e));
        if(btn){btn.disabled=false;btn.textContent='Deposit';}
    }
}

async function checkInToMatch(address) {
    const btn = document.getElementById('action-btn');
    if(btn){btn.disabled=true;btn.textContent='Checking in...';}
    const c = document.getElementById('match-detail-content');
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        addMsg(c,'success','Submitting check-in...');
        await(await escrow.checkIn()).wait();
        addMsg(c,'success','‚úÖ Checked in! Good luck üèÜ');
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Check-in failed: '+parseContractError(e));
        if(btn){btn.disabled=false;btn.textContent='Check In';}
    }
}

async function reportWin(address, winner) {
    const b1 = document.getElementById('action-btn-p1');
    const b2 = document.getElementById('action-btn-p2');
    if(b1)b1.disabled=true; if(b2)b2.disabled=true;
    const c = document.getElementById('match-detail-content');
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        addMsg(c,'success','Reporting outcome...');
        await(await escrow.reportOutcome(winner)).wait();
        const st   = Number(await escrow.status());
        const iWon = winner.toLowerCase() === userAddress.toLowerCase();
        if (st===5) {
            globalStatsCache = null;
            const netPotRaw  = await escrow.netPot();
            const prize      = ethers.formatUnits(netPotRaw, CONFIG.TOKEN_DECIMALS);
            const [p1addr, p2addr] = await Promise.all([escrow.player1(), escrow.player2()]);
            const oppAddr = p1addr.toLowerCase() === userAddress.toLowerCase() ? p2addr : p1addr;
            const prevBal = parseFloat((document.getElementById('w1n-balance')?.textContent||'0').replace(/[^0-9.]/g,''));
            showOutcomePopup(iWon, prize, getDisplayName(oppAddr));
            setTimeout(async () => { await loadBalanceAnimated(prevBal); }, 800);
        } else {
            addMsg(c,'success','‚úÖ Reported! Waiting for opponent to confirm.');
        }
        setTimeout(()=>viewMatch(address),iWon&&st===5?3500:1500);
    } catch(e) {
        addMsg(c,'error','Report failed: '+parseContractError(e));
        if(b1)b1.disabled=false; if(b2)b2.disabled=false;
    }
}

async function expireMatch(address) {
    const c = document.getElementById('match-detail-content');
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        const status = Number(await escrow.status());
        addMsg(c,'success','Processing expiry...');
        const tx = status === 0 ? await escrow.expireOpen() : await escrow.expire();
        await tx.wait();
        addMsg(c,'success','‚úÖ Expired. Refunds processed.');
        await loadBalance();
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Expire failed: '+parseContractError(e));
    }
}

async function requestMutualCancel(address) {
    const c = document.getElementById('match-detail-content');
    const btn = document.getElementById('mutual-cancel-btn');
    if (btn) { btn.disabled = true; btn.textContent = 'Requesting...'; }
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        addMsg(c, 'success', 'Requesting mutual cancel...');
        await (await escrow.requestMutualCancel()).wait();
        addMsg(c, 'success', '‚úÖ Requested. Waiting for opponent to agree.');
        setTimeout(() => viewMatch(address), 1500);
    } catch(e) {
        addMsg(c, 'error', 'Failed: ' + parseContractError(e));
        if (btn) { btn.disabled = false; btn.textContent = 'ü§ù Request No-Contest'; }
    }
}

async function resolveTimeout(address) {
    const c = document.getElementById('match-detail-content');
    try {
        const escrow = new ethers.Contract(address, ESCROW_ABI, signer);
        addMsg(c,'success','Checking timeout resolution...');
        await(await escrow.resolveAfterTimeout()).wait();
        addMsg(c,'success','‚úÖ Resolved!');
        globalStatsCache = null;
        await loadBalance();
        setTimeout(()=>viewMatch(address),1500);
    } catch(e) {
        addMsg(c,'error','Resolve failed: '+parseContractError(e));
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN FAUCET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFaucetAmount(n) { document.getElementById('faucet-amount').value = n; }

async function adminMint() {
    const toAddr    = document.getElementById('faucet-address').value.trim();
    const amount    = document.getElementById('faucet-amount').value;
    const sendPls   = document.getElementById('faucet-send-pls').checked;
    const plsAmount = document.getElementById('faucet-pls-amount').value;
    const statusEl  = document.getElementById('faucet-status');
    const btn       = document.getElementById('faucet-btn');
    statusEl.className = 'success'; statusEl.classList.remove('hidden');
    if (!ethers.isAddress(toAddr)) { statusEl.className='error'; statusEl.textContent='Invalid address.'; return; }
    if (!amount || parseFloat(amount) <= 0) { statusEl.className='error'; statusEl.textContent='Enter a valid W1N amount.'; return; }
    const shortAddr = toAddr.slice(0,6)+'‚Ä¶'+toAddr.slice(-4);
    const txCount   = sendPls ? 2 : 1;
    btn.disabled    = true;
    btn.textContent = 'Arming...';
    try {
        signer      = await provider.getSigner();
        w1nContract = new ethers.Contract(CONFIG.W1N_ADDRESS, ERC20_ABI, signer);
        statusEl.textContent = `(1/${txCount}) Sending ${amount} W1N ‚Üí ${shortAddr}...`;
        const transferTx = await w1nContract.transfer(toAddr, ethers.parseUnits(amount, CONFIG.TOKEN_DECIMALS));
        statusEl.textContent = `(1/${txCount}) Waiting for W1N confirmation...`;
        await transferTx.wait();
        statusEl.textContent = `‚úÖ W1N sent!${sendPls?' Now sending PLS...':''}`;
        if (sendPls && parseFloat(plsAmount) > 0) {
            statusEl.textContent = `(2/2) Sending ${Number(plsAmount).toLocaleString()} PLS ‚Üí ${shortAddr}...`;
            const plsTx = await signer.sendTransaction({ to: toAddr, value: ethers.parseEther(plsAmount) });
            statusEl.textContent = '(2/2) Waiting for PLS confirmation...';
            await plsTx.wait();
            statusEl.textContent = `‚úÖ Player armed! ${amount} W1N + ${Number(plsAmount).toLocaleString()} PLS ‚Üí ${shortAddr}`;
        } else {
            statusEl.textContent = `‚úÖ Minted ${amount} W1N ‚Üí ${shortAddr}`;
        }
        document.getElementById('faucet-address').value = '';
        await loadBalance();
    } catch(e) {
        statusEl.className = 'error';
        statusEl.textContent = 'Failed: ' + parseContractError(e);
    } finally {
        btn.disabled    = false;
        btn.textContent = 'üí∞ Arm Player';
    }
}

async function mintToSelf() {
    document.getElementById('faucet-address').value    = userAddress;
    document.getElementById('faucet-amount').value     = '500';
    document.getElementById('faucet-pls-amount').value = '2000';
    await adminMint();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addMsg(container, type, message) {
    const d = document.createElement('div');
    d.className = type; d.textContent = message;
    container.appendChild(d);
}

function parseContractError(e) {
    if (e.code===4001||e.message?.includes('user rejected')) return 'Transaction cancelled.';
    if (e.message?.includes('insufficient funds'))           return 'Insufficient funds.';
    if (e.message?.includes('Not open'))                     return 'Match is no longer open.';
    if (e.message?.includes('Already deposited'))            return 'Already deposited.';
    if (e.message?.includes('Already joined'))               return 'Match already has an opponent.';
    if (e.message?.includes('No opponent yet'))              return 'Join the match before depositing.';    // V4
    if (e.message?.includes('Join the match first'))         return 'Join the match before depositing.';    // V4
    if (e.message?.includes('Invalid sport'))                return 'Invalid sport selected.';              // V4
    if (e.message?.includes('Private match'))                return 'This is a private match.';             // V4
    if (e.message?.includes('Too late'))                     return 'Deadline has passed.';
    if (e.message?.includes('Too early'))                    return 'Too early ‚Äî try again closer to match time.';
    if (e.message?.includes('Cannot play yourself'))         return 'You cannot play yourself.';
    if (e.message?.includes('Match expired'))                return 'Match time has passed.';
    if (e.message?.includes('Not a player'))                 return 'You are not a player in this match.';
    const msg = e.reason||e.message||'Unknown error';
    return msg.length>120 ? msg.slice(0,120)+'‚Ä¶' : msg;
}

function refreshStats() { globalStatsCache=null; buildLeaderboard(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(tab, el) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    ['matches','create','my-matches','leaderboard','profile','tournaments'].forEach(t=>{
        document.getElementById('tab-'+t).classList.add('hidden');
    });
    document.getElementById('match-detail').classList.add('hidden');
    document.getElementById('tab-'+tab).classList.remove('hidden');
    if (tab==='matches')     loadMatches();
    if (tab==='my-matches')  loadMyMatches();
    if (tab==='leaderboard') buildLeaderboard();
    if (tab==='profile')     { refreshProfileUI(); refreshProfileStats(); }
    if (tab==='tournaments') { setTournamentSub('browse'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QR SCANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let qrStream = null;
let qrAnimFrame = null;
let qrTargetField = 'faucet-address';

async function openQrScanner(targetField = 'faucet-address') {
    qrTargetField = targetField;
    const modal  = document.getElementById('qr-modal');
    const video  = document.getElementById('qr-video');
    const status = document.getElementById('qr-status');
    const title  = document.getElementById('qr-modal-title');
    const sub    = document.getElementById('qr-modal-sub');
    if (targetField === 'create-opponent') {
        if (title) title.textContent = 'SCAN OPPONENT QR';
        if (sub)   sub.textContent   = 'Point at your opponent\'s MetaMask wallet QR code';
    } else {
        if (title) title.textContent = 'SCAN WALLET QR';
        if (sub)   sub.textContent   = 'Point camera at a MetaMask or wallet QR code';
    }
    modal.classList.remove('hidden');
    status.textContent = 'Starting camera...';
    status.style.color = 'var(--muted)';
    try {
        qrStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} } });
        video.srcObject = qrStream;
        await video.play();
        status.textContent = 'Scanning... point at a wallet QR code';
        scanFrame(video, status);
    } catch(e) {
        status.style.color = 'var(--red)';
        status.textContent = 'Camera access denied. Enter address manually.';
    }
}

function scanFrame(video, status) {
    if (!qrStream) return;
    if ('BarcodeDetector' in window) {
        const detector = new BarcodeDetector({ formats: ['qr_code'] });
        const detect = async () => {
            if (!qrStream) return;
            try {
                const barcodes = await detector.detect(video);
                if (barcodes.length > 0) { handleQrResult(barcodes[0].rawValue, status); return; }
            } catch(e) {}
            qrAnimFrame = requestAnimationFrame(detect);
        };
        detect();
    } else {
        loadJsQr(() => {
            const canvas = document.createElement('canvas');
            const ctx    = canvas.getContext('2d');
            const tick   = () => {
                if (!qrStream) return;
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code    = window.jsQR(imgData.data, imgData.width, imgData.height);
                    if (code) { handleQrResult(code.data, status); return; }
                }
                qrAnimFrame = requestAnimationFrame(tick);
            };
            tick();
        });
    }
}

function loadJsQr(cb) {
    if (window.jsQR) { cb(); return; }
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
    s.onload = cb;
    document.head.appendChild(s);
}

function handleQrResult(raw, status) {
    const match = raw.match(/(0x[a-fA-F0-9]{40})/);
    if (match) {
        const addr = match[1];
        const targetEl = document.getElementById(qrTargetField);
        if (targetEl) targetEl.value = addr;
        const shortAddr = addr.slice(0,6)+'‚Ä¶'+addr.slice(-4);
        status.style.color = 'var(--green)';
        status.textContent = qrTargetField === 'create-opponent'
            ? `‚úÖ Opponent set: ${shortAddr} ‚Äî choose your fee and go!`
            : `‚úÖ Got it: ${shortAddr}`;
        setTimeout(() => closeQrScanner(), 900);
    } else {
        status.style.color = 'var(--orange)';
        status.textContent = 'QR found but no wallet address detected. Try again.';
        const video = document.getElementById('qr-video');
        setTimeout(() => { status.style.color='var(--muted)'; status.textContent='Scanning...'; scanFrame(video, status); }, 1500);
    }
}

function closeQrScanner() {
    if (qrAnimFrame) { cancelAnimationFrame(qrAnimFrame); qrAnimFrame = null; }
    if (qrStream)    { qrStream.getTracks().forEach(t => t.stop()); qrStream = null; }
    const video = document.getElementById('qr-video');
    if (video) video.srcObject = null;
    document.getElementById('qr-modal').classList.add('hidden');
    document.getElementById('qr-status').style.color = 'var(--muted)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIN/LOSS POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showOutcomePopup(won, prizeAmount, oppName) {
    const popup = document.getElementById('outcome-popup');
    const inner = document.getElementById('outcome-popup-inner');
    const prizeNum = parseFloat(prizeAmount);
    inner.innerHTML = won ? `
        <div style="font-size:72px;margin-bottom:8px;filter:drop-shadow(0 0 24px rgba(255,215,0,0.6));">üèÜ</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:4px;background:linear-gradient(135deg,var(--gold),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px;">YOU W1N</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--green);margin-bottom:6px;" id="popup-prize">+0.00 W1N</div>
        <div style="color:rgba(240,242,248,0.5);font-size:13px;margin-bottom:28px;">headed to your wallet right now</div>
        <button onclick="closeOutcomePopup()" style="padding:14px 40px;border:none;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;cursor:pointer;">LET'S GO üî•</button>
    ` : `
        <div style="font-size:72px;margin-bottom:8px;">üíÄ</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:4px;color:var(--muted);margin-bottom:6px;">BETTER LUCK</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:4px;color:var(--muted);margin-bottom:16px;">NEXT TIME</div>
        <div style="color:rgba(240,242,248,0.4);font-size:13px;margin-bottom:8px;">${oppName} took the pot</div>
        <div style="color:rgba(240,242,248,0.3);font-size:12px;margin-bottom:28px;">-${prizeNum.toFixed(2)} W1N ¬∑ run it back</div>
        <button onclick="closeOutcomePopup()" style="padding:14px 40px;border:none;border-radius:14px;background:rgba(255,59,92,0.15);border:1px solid rgba(255,59,92,0.35);color:var(--red);font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;cursor:pointer;">REMATCH</button>
    `;
    popup.classList.add('show');
    if (won) { spawnParticles(); animateCount('popup-prize', 0, prizeNum, 1200, v => `+${v.toFixed(2)} W1N`); }
}

function closeOutcomePopup() {
    const popup = document.getElementById('outcome-popup');
    popup.classList.remove('show');
    setTimeout(() => { document.getElementById('outcome-popup-inner').innerHTML = ''; }, 400);
}

function spawnParticles() {
    const popup  = document.getElementById('outcome-popup');
    const emojis = ['üèÜ','üí∞','‚ö°','üî•','‚ú®','üéØ','üíé','ü•á'];
    for (let i = 0; i < 18; i++) {
        setTimeout(() => {
            const p = document.createElement('div');
            p.className = 'popup-particle';
            p.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            const angle = (Math.random() * 360) * Math.PI / 180;
            const dist  = 120 + Math.random() * 180;
            p.style.cssText = `left:${40+Math.random()*20}%;top:${30+Math.random()*20}%;--tx:${Math.cos(angle)*dist}px;--ty:${Math.sin(angle)*dist}px;animation-duration:${0.8+Math.random()*0.8}s;animation-delay:${Math.random()*0.3}s;`;
            popup.appendChild(p);
            setTimeout(() => p.remove(), 2000);
        }, i * 40);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANIMATED BALANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function animateCount(elId, from, to, duration, formatter) {
    const el = document.getElementById(elId);
    if (!el) return;
    const start = performance.now();
    const diff  = to - from;
    const tick  = (now) => {
        const elapsed  = now - start;
        const progress = Math.min(elapsed / duration, 1);
        const eased    = 1 - Math.pow(1 - progress, 3);
        el.textContent = formatter(from + diff * eased);
        if (progress < 1) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
}

async function loadBalanceAnimated(previousAmount) {
    try {
        const bal    = await w1nContract.balanceOf(userAddress);
        const amount = parseFloat(ethers.formatUnits(bal, CONFIG.TOKEN_DECIMALS));
        const balEl  = document.getElementById('w1n-balance');
        const stEl   = document.getElementById('w1n-balance-status');
        if (!balEl) return;
        const from    = previousAmount ?? amount;
        const changed = Math.abs(amount - from) > 0.001;
        if (changed) {
            animateCount('w1n-balance', from, amount, 1400, v => v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+' W1N');
        } else {
            balEl.textContent = amount.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+' W1N';
        }
        if (amount >= 1000) {
            balEl.style.color = 'var(--green)';
            if (stEl) { stEl.textContent='‚óè Ready to compete'; stEl.style.color='var(--green)'; }
        } else if (amount >= 500) {
            balEl.style.color = 'var(--gold)';
            if (stEl) { stEl.textContent='‚óè Low ‚Äî get more tokens'; stEl.style.color='var(--gold)'; }
        } else {
            balEl.style.color = 'var(--red)';
            if (stEl) { stEl.textContent='‚óè Needs tokens'; stEl.style.color='var(--red)'; }
        }
        return amount;
    } catch(e) { console.error('loadBalanceAnimated:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOOB HINTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function noobHint(msg) {
    return `<div class="noob-hint"><span class="noob-hint-icon">üí°</span><span>${msg}</span></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
setInterval(()=>{
    if (userAddress && !document.getElementById('connected').classList.contains('hidden')) {
        loadBalance();
    }

    const matchesTab = document.getElementById('tab-matches');
    if (matchesTab && !matchesTab.classList.contains('hidden')) {
        loadMatches();
    }
}, 30000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AGE GATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAgeGate() {
    if (localStorage.getItem('w1nnr_age_confirmed') === '1') {
        connectWallet();
        return;
    }
    document.getElementById('age-gate-modal').classList.remove('hidden');
}
function closeAgeGate() {
    document.getElementById('age-gate-modal').classList.add('hidden');
}
function confirmAge() {
    const ageCheck = document.getElementById('age-checkbox');
    const tosCheck = document.getElementById('tos-checkbox');
    const errEl    = document.getElementById('age-gate-error');
    if (!ageCheck?.checked || !tosCheck?.checked) {
        if (errEl) {
            errEl.textContent = 'Please confirm both checkboxes to continue.';
            errEl.classList.remove('hidden');
        }
        return;
    }
    if (errEl) errEl.classList.add('hidden');
    localStorage.setItem('w1nnr_age_confirmed', '1');
    closeAgeGate();
    connectWallet();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOURNAMENT SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TOURNAMENT_FACTORY_ABI = [
    "function createTournament(uint256 sportId, string calldata name, uint256 entryFee, uint256 maxPlayers, uint256 registrationDeadline, uint256 noShowWindow, uint256 disputeWindow) external returns (address)",
    "function getTournamentCount() external view returns (uint256)",
    "function getTournaments(uint256 offset, uint256 limit) external view returns (address[])",
    "function getTournamentsBySport(uint256 sportId) external view returns (address[])",
    "function getTournamentsByCreator(address creator) external view returns (address[])",
    "function getRecentTournaments(uint256 count) external view returns (address[])",
    "function isTournament(address) external view returns (bool)",
];

const TOURNAMENT_ABI = [
    // State variables
    "function admin() external view returns (address)",
    "function tournamentName() external view returns (string)",
    "function sportId() external view returns (uint256)",
    "function entryFee() external view returns (uint256)",
    "function maxPlayers() external view returns (uint256)",
    "function registrationDeadline() external view returns (uint256)",
    "function state() external view returns (uint8)",
    "function bracketLocked() external view returns (bool)",
    "function currentRound() external view returns (uint256)",
    "function roundCount() external view returns (uint256)",
    "function isEntrant(address) external view returns (bool)",
    // Actions
    "function register(uint256 rating) external",
    "function claimPrize() external",
    "function claimRefund() external",
    "function selfLockBracket() external",
    "function reportWinner(uint256 round, uint256 matchIndex, address winner) external",
    // Composite views ‚Äî return structs (ethers decodes by field name)
    "function getTournamentInfo() external view returns (tuple(string name, uint256 sport, uint256 fee, uint256 maxP, uint256 currentP, uint256 deadline, uint8 tState) v)",
    "function getPlayerStatus(address player) external view returns (tuple(bool registered, uint256 rating, uint256 seedPos, uint256 prize, bool claimed) v)",
    "function getPrizeBreakdown() external view returns (tuple(uint256 totalPool, uint256 platformFee, uint256 netPool, uint256 firstPrize, uint256 secondPrize, uint256 thirdFourthPrize) v)",
    "function getEntrants() external view returns (address[])",
    "function getRoundMatches(uint256 round) external view returns (tuple(address[] playerAs, address[] playerBs, address[] winners, uint8[] states) v)",
    "function getMatch(uint256 round, uint256 matchIndex) external view returns (tuple(address playerA, address playerB, address reportedByA, address reportedByB, address winner, uint8 matchState, uint256 disputeTime) v)",
    // Events
    "event PlayerRegistered(address indexed player, uint256 rating, uint256 count)",
    "event BracketLocked(address[] seeds, uint256 rounds, address lockedBy)",
    "event RoundStarted(uint256 indexed round, uint256 startTime)",
    "event WinnerReported(uint256 indexed round, uint256 indexed matchIndex, address indexed reporter, address reportedWinner)",
    "event MatchComplete(uint256 indexed round, uint256 indexed matchIndex, address indexed winner, string method)",
    "event PrizesAllocated(address indexed first, uint256 firstAmt, address indexed second, uint256 secondAmt)",
    "event PrizeClaimed(address indexed player, uint256 amount)",
    "event RefundClaimed(address indexed player, uint256 amount)",
    "event TournamentCancelled(address indexed by, string reason)",
];

// Read-only provider ‚Äî lazy init, called before any read operation
let staticProvider = null;
let staticFactory  = null;
let staticTournamentFactory = null;
function getStaticProvider() {
    if (!staticProvider) staticProvider = new ethers.JsonRpcProvider(CONFIG.RPC_URL);
    return staticProvider;
}
function getStaticFactory() {
    if (!staticFactory) staticFactory = new ethers.Contract(CONFIG.FACTORY_ADDRESS, FACTORY_ABI, getStaticProvider());
    return staticFactory;
}
function getStaticTournamentFactory() {
    if (!staticTournamentFactory) staticTournamentFactory = new ethers.Contract(CONFIG.TOURNAMENT_FACTORY, TOURNAMENT_FACTORY_ABI, getStaticProvider());
    return staticTournamentFactory;
}

const TOURNAMENT_STATE = {0:'Registration',1:'Active',2:'Completed',3:'Cancelled'};

let tournamentFactoryContract = null;
let activeTournamentSportFilter = 0;
let selectedTournamentSportId = 1;
let selectedBracketSize = 4;
let currentTournamentSub = 'browse';

function initTournamentFactory() {
    if (!signer || !CONFIG.TOURNAMENT_FACTORY) return;
    tournamentFactoryContract = new ethers.Contract(CONFIG.TOURNAMENT_FACTORY, TOURNAMENT_FACTORY_ABI, signer);
}

function setTournamentSub(sub) {
    currentTournamentSub = sub;
    ['browse','create','mine'].forEach(s => {
        const btn   = document.getElementById('tsub-' + s);
        const panel = document.getElementById('tsub-' + s + '-panel');
        const active = s === sub;
        if (btn) {
            btn.style.background  = active ? 'rgba(0,212,255,0.1)'        : 'var(--surface)';
            btn.style.borderColor = active ? 'rgba(0,212,255,0.35)'        : 'var(--border)';
            btn.style.color       = active ? 'var(--accent)'               : 'var(--muted)';
        }
        if (panel) panel.classList.toggle('hidden', !active);
    });
    document.getElementById('tournament-detail').classList.add('hidden');
    if (sub === 'browse') loadTournaments();
    if (sub === 'mine')   loadMyTournaments();
}

function setTournamentSportFilter(sportId, el) {
    activeTournamentSportFilter = sportId;
    document.querySelectorAll('#t-sport-filter-row .sport-filter-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    loadTournaments();
}

function selectTournamentSport(id, el) {
    selectedTournamentSportId = id;
    document.querySelectorAll('#t-create-sport-grid .sport-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
}

function selectBracketSize(size) {
    selectedBracketSize = size;
    [4,8,16].forEach(s => {
        const el = document.getElementById('t-size-' + s);
        if (!el) return;
        const active = s === size;
        el.style.border     = active ? '2px solid var(--accent)' : '1px solid var(--border)';
        el.style.background = active ? 'rgba(0,212,255,0.08)'    : 'var(--surface)';
        el.querySelectorAll('div')[0].style.color = active ? 'var(--accent)' : 'var(--muted)';
    });
}

async function loadTournaments() {
    // Use staticTournamentFactory so browsing works without wallet connected
    const list = document.getElementById('tournaments-list');
    list.innerHTML = '<div class="loading">Loading tournaments...</div>';
    try {
        let addrs;
        if (activeTournamentSportFilter === 0) {
            addrs = await getStaticTournamentFactory().getRecentTournaments(20);
        } else {
            const raw = await getStaticTournamentFactory().getTournamentsBySport(activeTournamentSportFilter);
            addrs = [...raw].reverse().slice(0, 20);
        }
        if (!addrs.length) {
            list.innerHTML = `
                <div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:14px;">üèÜ</div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:10px;">No Tournaments Yet</div>
                    <p style="color:var(--muted);margin-bottom:20px;font-size:13px;">Be the first to create one!</p>
                    <button class="btn btn-primary" style="max-width:200px;margin:0 auto;" onclick="setTournamentSub('create')">‚ûï Create Tournament</button>
                </div>`;
            return;
        }
        list.innerHTML = '';
        for (const addr of addrs) {
            try {
                const t    = new ethers.Contract(addr, TOURNAMENT_ABI, getStaticProvider());
                const info = await t.getTournamentInfo();
                const { name: tName, sport, fee, maxP, currentP, deadline, tState } = info;
                const fmtFee    = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(0);
                const deadlineMs= Number(deadline) * 1000;
                const isOpen    = Number(tState) === 0 && Date.now() < deadlineMs;
                const stateStr  = TOURNAMENT_STATE[Number(tState)] || 'Unknown';
                const spotsLeft = Number(maxP) - Number(currentP);
                const pct       = Math.round((Number(currentP) / Number(maxP)) * 100);
                const prizePool = (parseFloat(fmtFee) * Number(maxP) * 0.92).toFixed(0);
                const item = document.createElement('div');
                item.className = 'match-item';
                item.onclick   = () => viewTournament(addr);
                item.innerHTML = `
                    <div class="match-header">
                        <div style="font-weight:800;font-size:15px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${tName}</div>
                        <div class="match-fee">${fmtFee} W1N</div>
                    </div>
                    <div class="match-details" style="margin-bottom:8px;">
                        <span>${sportLabel(sport)}</span>
                        <span>üèÜ ${Number(maxP)}-player bracket</span>
                        <span class="status-badge status-${isOpen?'open':stateStr.toLowerCase()}">${stateStr}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="flex:1;height:4px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;">
                            <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:2px;"></div>
                        </div>
                        <span style="font-size:11px;color:var(--muted);flex-shrink:0;">${Number(currentP)}/${Number(maxP)}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:6px;">
                        <span style="font-size:11px;color:var(--muted);">Prize pool: <strong style="color:var(--green);">${prizePool} W1N</strong></span>
                        ${isOpen && spotsLeft > 0
                            ? `<span style="font-size:11px;color:var(--accent);font-weight:700;">${spotsLeft} spot${spotsLeft>1?'s':''} left</span>`
                            : `<span style="font-size:11px;color:var(--muted);">${new Date(deadlineMs).toLocaleDateString()}</span>`
                        }
                    </div>`;
                list.appendChild(item);
            } catch(e) { /* skip bad */ }
        }
    } catch(e) {
        console.error(e);
        list.innerHTML = '<div class="error">Failed to load tournaments.</div>';
    }
}

async function loadMyTournaments() {
    if (!userAddress) {
        document.getElementById('my-tournaments-list').innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted);">Connect your wallet to see your tournaments.</div>';
        return;
    }
    if (!tournamentFactoryContract) initTournamentFactory();
    if (!tournamentFactoryContract) {
        document.getElementById('my-tournaments-list').innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted);">Connect your wallet to see your tournaments.</div>';
        return;
    }
    const list = document.getElementById('my-tournaments-list');
    list.innerHTML = '<div class="loading">Loading...</div>';
    try {
        const addrs = await tournamentFactoryContract.getTournamentsByCreator(userAddress);
        if (!addrs.length) {
            list.innerHTML = `<div style="text-align:center;padding:30px;color:var(--muted);">You haven't created any tournaments yet.</div>`;
            return;
        }
        list.innerHTML = '';
        for (const addr of [...addrs].reverse()) {
            try {
                const t    = new ethers.Contract(addr, TOURNAMENT_ABI, getStaticProvider());
                const info = await t.getTournamentInfo();
                const { name: tName, sport, fee, maxP, currentP, tState } = info;
                const fmtFee   = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(0);
                const stateStr = TOURNAMENT_STATE[Number(tState)] || 'Unknown';
                const item = document.createElement('div');
                item.className = 'match-item';
                item.onclick   = () => viewTournament(addr);
                item.innerHTML = `
                    <div class="match-header">
                        <div style="font-weight:800;font-size:15px;">${tName}</div>
                        <div class="match-fee">${fmtFee} W1N</div>
                    </div>
                    <div class="match-details">
                        <span>${sportLabel(sport)}</span>
                        <span>${Number(currentP)}/${Number(maxP)} registered</span>
                        <span class="status-badge status-${stateStr.toLowerCase()}">${stateStr}</span>
                    </div>`;
                list.appendChild(item);
            } catch(e) {}
        }
    } catch(e) {
        list.innerHTML = '<div class="error">Failed to load.</div>';
    }
}

async function viewTournament(address) {
    ['tsub-browse-panel','tsub-create-panel','tsub-mine-panel'].forEach(id => {
        document.getElementById(id)?.classList.add('hidden');
    });
    document.getElementById('tournament-detail').classList.remove('hidden');
    const contentEl = document.getElementById('tournament-detail-content');
    contentEl.innerHTML = '<div class="loading">Loading...</div>';
    try {
        const t = new ethers.Contract(address, TOURNAMENT_ABI, getStaticProvider());
        const [info, isReg, adminAddr] = await Promise.all([
            t.getTournamentInfo(),
            userAddress ? t.isEntrant(userAddress) : Promise.resolve(false),
            t.admin(),
        ]);
        const { name: tName, sport, fee, maxP, currentP, deadline, tState } = info;
        const fmtFee    = parseFloat(ethers.formatUnits(fee, CONFIG.TOKEN_DECIMALS)).toFixed(2);
        const deadlineMs= Number(deadline) * 1000;
        const stateNum  = Number(tState);
        const stateStr  = TOURNAMENT_STATE[stateNum] || 'Unknown';
        const isOpen    = stateNum === 0 && Date.now() < deadlineMs;
        const spotsLeft = Number(maxP) - Number(currentP);
        const prizePool = (parseFloat(fmtFee) * Number(maxP) * 0.92).toFixed(2);
        const isAdmin   = adminAddr.toLowerCase() === userAddress.toLowerCase();
        const pct       = Math.round((Number(currentP) / Number(maxP)) * 100);

        let html = `
            <div style="font-family:'Bebas Neue',sans-serif;font-size:11px;letter-spacing:1px;color:var(--muted);margin-bottom:4px;">${sportLabel(sport)}</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1.5px;margin-bottom:16px;">${tName}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
                <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--green);">${fmtFee} W1N</div>
                    <div style="font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-top:2px;">Entry Fee</div>
                </div>
                <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);">${prizePool} W1N</div>
                    <div style="font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-top:2px;">Prize Pool</div>
                </div>
                <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--gold);">${Number(maxP)}</div>
                    <div style="font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-top:2px;">Bracket</div>
                </div>
                <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--orange);">${Number(currentP)}</div>
                    <div style="font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-top:2px;">Registered</div>
                </div>
            </div>
            <div style="margin-bottom:16px;">
                <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:6px;">
                    <span>Registration</span><span>${Number(currentP)}/${Number(maxP)} ¬∑ ${spotsLeft} left</span>
                </div>
                <div style="height:6px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden;">
                    <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:3px;"></div>
                </div>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
                <span style="color:var(--muted);font-size:13px;">üìÖ Deadline</span>
                <span style="font-size:13px;font-weight:700;">${new Date(deadlineMs).toLocaleString()}</span>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);margin-bottom:8px;">
                <span style="color:var(--muted);font-size:13px;">Status</span>
                <span class="status-badge status-${isOpen?'open':stateStr.toLowerCase()}">${stateStr}</span>
            </div>`;

        if (isReg) {
            html += `<div style="background:rgba(0,255,136,0.07);border:1px solid rgba(0,255,136,0.25);border-radius:14px;padding:18px;text-align:center;margin-top:8px;">
                <div style="font-size:28px;margin-bottom:6px;">‚úÖ</div>
                <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;color:var(--green);">YOU'RE REGISTERED</div>
            </div>`;
        } else if (isOpen && spotsLeft > 0) {
            html += `<div style="margin-top:8px;">
                <button class="btn btn-primary" id="t-register-btn" onclick="registerForTournament('${address}','${fmtFee}')" style="font-size:16px;">
                    ‚ö° Register ‚Äî ${fmtFee} W1N Entry
                </button>
                ${noobHint('Registration is free ‚Äî you commit your spot. Entry fee collected when bracket locks.')}
            </div>`;
        } else if (spotsLeft === 0) {
            html += `<div style="background:rgba(255,59,92,0.07);border:1px solid rgba(255,59,92,0.2);border-radius:14px;padding:18px;text-align:center;margin-top:8px;">
                <div style="font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;color:var(--red);">BRACKET FULL</div>
            </div>`;
        } else {
            html += `<div style="background:rgba(150,150,150,0.05);border:1px solid rgba(150,150,150,0.15);border-radius:14px;padding:18px;text-align:center;margin-top:8px;">
                <div style="font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;color:var(--muted);">${stateNum===0?'REGISTRATION CLOSED':stateStr.toUpperCase()}</div>
            </div>`;
        }

        if (isAdmin) {
            html += `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                <div style="font-size:11px;color:var(--gold);font-weight:800;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">üëë Organizer</div>
                <div style="font-size:11px;color:var(--muted);font-family:monospace;">${address}</div>
            </div>`;
        }

        contentEl.innerHTML = html;
        const msgDiv = document.createElement('div');
        msgDiv.id = 't-detail-msg';
        contentEl.appendChild(msgDiv);
    } catch(e) {
        console.error(e);
        contentEl.innerHTML = '<div class="error">Failed to load tournament details.</div>';
    }
}

function closeTournamentDetail() {
    document.getElementById('tournament-detail').classList.add('hidden');
    setTournamentSub(currentTournamentSub);
}

async function registerForTournament(address, fmtFee) {
    if (!signer || !userAddress) { alert('Please connect your wallet first.'); return; }
    const btn   = document.getElementById('t-register-btn');
    const msgEl = document.getElementById('t-detail-msg');
    if (btn) { btn.disabled = true; btn.textContent = 'Registering...'; }
    try {
        const t = new ethers.Contract(address, TOURNAMENT_ABI, signer);
        // Read entry fee directly from contract to be precise
        const tRead    = new ethers.Contract(address, TOURNAMENT_ABI, getStaticProvider());
        const entryFee = await tRead.entryFee();
        if (entryFee > 0n) {
            const allowance = await w1nContract.allowance(userAddress, address);
            if (allowance < entryFee) {
                if (msgEl) { msgEl.className='success'; msgEl.textContent='Step 1/2: Approving W1N...'; }
                await (await w1nContract.approve(address, entryFee)).wait();
                if (msgEl) msgEl.textContent = '‚úÖ Approved!';
            }
        }
        if (msgEl) { msgEl.className='success'; msgEl.textContent='Sending registration...'; }
        const tx = await t.register(0); // rating=0 for unrated
        if (msgEl) msgEl.textContent = 'Waiting for confirmation...';
        await tx.wait();
        if (msgEl) { msgEl.textContent = `‚úÖ Registered! You're in.`; }
        setTimeout(() => viewTournament(address), 1500);
    } catch(e) {
        if (msgEl) { msgEl.className='error'; msgEl.textContent = 'Failed: ' + parseContractError(e); }
        if (btn) { btn.disabled=false; btn.textContent=`‚ö° Register ‚Äî ${fmtFee} W1N Entry`; }
    }
}

async function createTournament() {
    if (!tournamentFactoryContract) initTournamentFactory();
    const name     = document.getElementById('t-create-name').value.trim();
    const fee      = document.getElementById('t-create-fee').value;
    const deadline = document.getElementById('t-create-deadline').value;
    const noShow   = document.getElementById('t-create-noshow').value;
    const dispute  = document.getElementById('t-create-dispute').value;
    const errDiv   = document.getElementById('t-create-error');
    const okDiv    = document.getElementById('t-create-success');
    const btn      = document.getElementById('t-create-btn');

    errDiv.classList.add('hidden'); okDiv.classList.add('hidden');
    if (!name)       { errDiv.textContent='Tournament name required';                     return errDiv.classList.remove('hidden'); }
    if (!fee || parseFloat(fee) < 10) { errDiv.textContent='Minimum entry fee is 10 W1N'; return errDiv.classList.remove('hidden'); }
    if (!deadline)   { errDiv.textContent='Registration deadline required';               return errDiv.classList.remove('hidden'); }
    const deadlineTs = Math.floor(new Date(deadline).getTime() / 1000);
    if (deadlineTs < Math.floor(Date.now()/1000) + 300) {
        errDiv.textContent = 'Deadline must be at least 5 minutes from now';
        return errDiv.classList.remove('hidden');
    }

    btn.disabled = true;
    okDiv.textContent = 'Creating tournament...'; okDiv.classList.remove('hidden');
    try {
        const feeWei = ethers.parseUnits(fee, CONFIG.TOKEN_DECIMALS);
        const tx = await tournamentFactoryContract.createTournament(
            selectedTournamentSportId, name, feeWei,
            selectedBracketSize, deadlineTs,
            parseInt(noShow), parseInt(dispute)
        );
        okDiv.textContent = 'Waiting for confirmation...';
        await tx.wait();
        okDiv.textContent = '‚úÖ Tournament created!';
        document.getElementById('t-create-name').value = '';
        setTimeout(() => setTournamentSub('browse'), 2000);
    } catch(e) {
        errDiv.textContent = 'Failed: ' + parseContractError(e);
        errDiv.classList.remove('hidden'); okDiv.classList.add('hidden');
    } finally {
        btn.disabled = false;
    }
}

</script>

<!-- QR SCANNER MODAL -->
<div id="qr-modal" class="qr-modal hidden">
    <div class="qr-modal-inner">
        <div style="text-align:center;margin-bottom:16px;">
            <div id="qr-modal-title" style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1.5px;color:var(--accent);">SCAN WALLET QR</div>
            <div id="qr-modal-sub" style="color:var(--muted);font-size:12px;margin-top:4px;">Point camera at a MetaMask or wallet QR code</div>
        </div>
        <div class="qr-viewfinder">
            <video id="qr-video" playsinline autoplay muted></video>
            <div class="qr-corner tl"></div>
            <div class="qr-corner tr"></div>
            <div class="qr-corner bl"></div>
            <div class="qr-corner br"></div>
            <div class="qr-scan-line"></div>
        </div>
        <div id="qr-status" style="text-align:center;padding:12px;font-size:13px;color:var(--muted);min-height:40px;margin-top:8px;"></div>
        <button class="btn btn-danger" onclick="closeQrScanner()" style="margin-top:8px;">‚úï Cancel</button>
    </div>
</div>

<!-- WIN/LOSS OUTCOME POPUP -->
<div id="outcome-popup">
    <div id="outcome-popup-inner"></div>
</div>

<!-- ONBOARDING MODAL -->
<div id="onboarding-modal" class="hidden" style="position:fixed;inset:0;z-index:3500;background:rgba(4,6,16,0.98);display:flex;align-items:flex-start;justify-content:center;padding:40px 20px 20px;overflow-y:auto;">
  <div style="width:100%;max-width:420px;background:#0c0f1c;border:1px solid rgba(0,212,255,0.15);border-radius:24px;overflow:hidden;">
    <div style="height:3px;background:linear-gradient(90deg,var(--accent),var(--green));"></div>
    <div style="padding:28px 24px 24px;">

      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:11px;letter-spacing:2px;color:var(--muted2);text-transform:uppercase;">Create Your Identity</div>
        <div id="onboard-counter" style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:1px;">1 / 4</div>
      </div>

      <div style="display:flex;gap:6px;margin-bottom:24px;">
        <div class="onboard-dot active" style="height:3px;flex:1;border-radius:2px;background:var(--accent);transition:.3s;"></div>
        <div class="onboard-dot"        style="height:3px;flex:1;border-radius:2px;background:rgba(255,255,255,0.1);transition:.3s;"></div>
        <div class="onboard-dot"        style="height:3px;flex:1;border-radius:2px;background:rgba(255,255,255,0.1);transition:.3s;"></div>
        <div class="onboard-dot"        style="height:3px;flex:1;border-radius:2px;background:rgba(255,255,255,0.1);transition:.3s;"></div>
      </div>

      <div id="onboard-msg" class="hidden" style="background:rgba(255,123,44,0.08);border:1px solid rgba(255,123,44,0.2);border-radius:8px;padding:8px 12px;font-size:12px;color:#ff7b2c;margin-bottom:12px;"></div>

      <!-- STEP 1: HANDLE -->
      <div id="onboard-step-1" class="onboard-step">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;margin-bottom:4px;">Claim Your Handle</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.5;">Your permanent W1NNR name. Bound to your wallet forever.</div>
        <div style="position:relative;margin-bottom:8px;">
          <span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:16px;color:var(--accent);font-weight:800;">@</span>
          <input id="onboard-handle" type="text" maxlength="20"
            style="width:100%;background:var(--surface);border:1px solid rgba(0,212,255,0.2);border-radius:12px;color:var(--text);font-size:16px;font-weight:700;padding:12px 14px 12px 32px;outline:none;letter-spacing:.5px;"
            placeholder="yourhandle"
            oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_]/g,'')"
            onkeydown="if(event.key==='Enter')onboardCheckHandle()">
        </div>
        <div id="onboard-handle-err" class="hidden" style="font-size:12px;color:var(--red);margin-bottom:12px;padding:6px 10px;background:rgba(255,59,92,0.08);border-radius:8px;"></div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:16px;">3‚Äì20 chars ¬∑ letters, numbers, underscores</div>
        <button id="onboard-handle-btn" onclick="onboardCheckHandle()"
          style="width:100%;padding:13px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;">
          Continue ‚Üí
        </button>
      </div>

      <!-- STEP 2: SPORTS -->
      <div id="onboard-step-2" class="onboard-step hidden">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;margin-bottom:4px;">What Do You Play?</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">Pick up to 3 sports.</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
          <div onclick="toggleOnboardSport(1,this)" data-sport="1"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">‚öΩ</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Soccer</div>
            </div>
<div onclick="toggleOnboardSport(2,this)" data-sport="2"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">üèÄ</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Basketball</div>
            </div>
<div onclick="toggleOnboardSport(3,this)" data-sport="3"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">üéæ</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Tennis</div>
            </div>
<div onclick="toggleOnboardSport(4,this)" data-sport="4"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">‚õ≥</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Golf</div>
            </div>
<div onclick="toggleOnboardSport(5,this)" data-sport="5"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">üèà</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Football</div>
            </div>
<div onclick="toggleOnboardSport(6,this)" data-sport="6"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">‚öæ</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Baseball</div>
            </div>
<div onclick="toggleOnboardSport(7,this)" data-sport="7"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">ü•ä</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Boxing / MMA</div>
            </div>
<div onclick="toggleOnboardSport(8,this)" data-sport="8"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">üèì</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Pickleball</div>
            </div>
<div onclick="toggleOnboardSport(9,this)" data-sport="9"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">üèê</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Volleyball</div>
            </div>
<div onclick="toggleOnboardSport(10,this)" data-sport="10"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">üèí</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Hockey</div>
            </div>
<div onclick="toggleOnboardSport(11,this)" data-sport="11"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">üèñÔ∏è</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Beach VB</div>
            </div>
<div onclick="toggleOnboardSport(12,this)" data-sport="12"
              style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;"
              onmouseover="this.style.borderColor='rgba(0,212,255,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-size:22px;margin-bottom:4px;">üèì</div>
              <div style="font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--muted2);">Ping Pong</div>
            </div>
        </div>
        <button onclick="onboardSportsNext()" style="width:100%;padding:13px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;">Continue ‚Üí</button>
        <button onclick="goToOnboardStep(1)" style="width:100%;margin-top:10px;padding:10px;background:none;border:1px solid var(--border);border-radius:12px;color:var(--muted);cursor:pointer;font-size:13px;">‚Üê Back</button>
      </div>

      <!-- STEP 3: SKILL + BIO -->
      <div id="onboard-step-3" class="onboard-step hidden">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;margin-bottom:4px;">Your Level</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">How competitive are you?</div>
        <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
                      <label style="display:flex;align-items:center;gap:14px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:13px 16px;cursor:pointer;transition:.2s;">
              <input type="radio" name="skill" value="casual" checked style="accent-color:var(--accent);width:16px;height:16px;">
              <span style="font-size:22px;">üéÆ</span>
              <span>
                <div style="font-weight:700;font-size:14px;">Casual</div>
                <div style="font-size:11px;color:var(--muted);">Playing for fun</div>
              </span>
            </label>
            <label style="display:flex;align-items:center;gap:14px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:13px 16px;cursor:pointer;transition:.2s;">
              <input type="radio" name="skill" value="competitive"  style="accent-color:var(--accent);width:16px;height:16px;">
              <span style="font-size:22px;">üèÜ</span>
              <span>
                <div style="font-weight:700;font-size:14px;">Competitive</div>
                <div style="font-size:11px;color:var(--muted);">Playing to win</div>
              </span>
            </label>
            <label style="display:flex;align-items:center;gap:14px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:13px 16px;cursor:pointer;transition:.2s;">
              <input type="radio" name="skill" value="elite"  style="accent-color:var(--accent);width:16px;height:16px;">
              <span style="font-size:22px;">‚ö°</span>
              <span>
                <div style="font-weight:700;font-size:14px;">Elite</div>
                <div style="font-size:11px;color:var(--muted);">Tournament level</div>
              </span>
            </label>

        </div>
        <textarea id="onboard-bio" maxlength="160" rows="3"
          style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:13px;padding:12px 14px;outline:none;resize:none;margin-bottom:6px;font-family:'DM Sans',sans-serif;"
          placeholder="Your callout line... (optional, max 160 chars)" oninput="document.getElementById('bio-char-count').textContent=this.value.length+' / 160'"></textarea>
        <div style="font-size:11px;color:var(--muted);margin-bottom:16px;text-align:right;" id="bio-char-count">0 / 160</div>
        <button onclick="onboardProfileNext()" style="width:100%;padding:13px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer;">Continue ‚Üí</button>
        <button onclick="goToOnboardStep(2)" style="width:100%;margin-top:10px;padding:10px;background:none;border:1px solid var(--border);border-radius:12px;color:var(--muted);cursor:pointer;font-size:13px;">‚Üê Back</button>
      </div>

      <!-- STEP 4: SIGN + LOCK -->
      <div id="onboard-step-4" class="onboard-step hidden">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;margin-bottom:4px;">Lock It In</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.6;">One free MetaMask signature saves your profile. No gas. No transaction. No email.</div>
        <div style="background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.12);border-radius:14px;padding:16px;margin-bottom:20px;" id="preview-card">
          <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
            <span style="font-size:11px;color:var(--muted2);font-weight:700;letter-spacing:1px;text-transform:uppercase;">Handle</span>
            <span id="preview-handle" style="font-size:14px;font-weight:800;color:var(--accent);"></span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
            <span style="font-size:11px;color:var(--muted2);font-weight:700;letter-spacing:1px;text-transform:uppercase;">Sports</span>
            <span id="preview-sports" style="font-size:14px;"></span>
          </div>
          <div style="display:flex;justify-content:space-between;">
            <span style="font-size:11px;color:var(--muted2);font-weight:700;letter-spacing:1px;text-transform:uppercase;">Level</span>
            <span id="preview-skill" style="font-size:14px;font-weight:700;color:var(--green);"></span>
          </div>
        </div>
        <div style="background:rgba(0,255,136,0.04);border:1px solid rgba(0,255,136,0.12);border-radius:10px;padding:10px 14px;font-size:11px;color:var(--muted);margin-bottom:20px;line-height:1.6;">
          üîí Profile tied to your wallet via W1NNR Player Registry. No email. No password. Yours forever.
        </div>
        <div id="onboard-finish-err" class="hidden" style="font-size:12px;color:var(--red);margin-bottom:12px;padding:8px 12px;background:rgba(255,59,92,0.08);border-radius:8px;"></div>
        <button id="onboard-finish-btn" onclick="onboardFinish()"
          style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;cursor:pointer;">
          ‚ö° Create My Profile
        </button>
        <button onclick="goToOnboardStep(3)" style="width:100%;margin-top:10px;padding:10px;background:none;border:1px solid var(--border);border-radius:12px;color:var(--muted);cursor:pointer;font-size:13px;">‚Üê Back</button>
      </div>

    </div>
  </div>
</div>


<!-- AGE GATE MODAL -->
<div id="age-gate-modal" class="hidden" style="position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,0.96);display:flex;align-items:flex-start;justify-content:center;padding:40px 24px 24px;overflow-y:auto;">
    <div style="width:100%;max-width:380px;background:#0f1422;border:1px solid rgba(0,212,255,0.2);border-radius:24px;overflow:hidden;">
        <!-- Header bar -->
        <div style="height:4px;background:linear-gradient(90deg,var(--accent),var(--green));"></div>
        <div style="padding:28px 24px 24px;">
            <!-- Logo / Icon -->
            <div style="text-align:center;margin-bottom:20px;">
                <div style="font-size:48px;margin-bottom:8px;">üèÜ</div>
                <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:3px;background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">W1NNR</div>
                <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-top:4px;">Real Stakes ¬∑ Real Competition</div>
            </div>

            <!-- Age warning -->
            <div style="background:rgba(255,59,92,0.07);border:1px solid rgba(255,59,92,0.2);border-radius:14px;padding:14px 16px;margin-bottom:20px;text-align:center;">
                <div style="font-size:22px;margin-bottom:6px;">‚ö†Ô∏è</div>
                <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;color:var(--red);margin-bottom:4px;">ADULTS ONLY ¬∑ 18+</div>
                <div style="font-size:12px;color:rgba(240,242,248,0.6);line-height:1.5;">W1NNR involves real money wagering on competitive matches. You must be 18 years or older to participate.</div>
            </div>

            <!-- Checkboxes -->
            <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
                <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.12);border-radius:12px;padding:12px 14px;">
                    <input type="checkbox" id="age-checkbox" style="width:18px;height:18px;accent-color:var(--accent);cursor:pointer;flex-shrink:0;margin-top:1px;">
                    <span style="font-size:13px;color:rgba(240,242,248,0.8);line-height:1.5;">I confirm that I am <strong style="color:var(--text);">18 years of age or older</strong> and legally permitted to participate in skill-based wagering in my jurisdiction.</span>
                </label>
                <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.12);border-radius:12px;padding:12px 14px;">
                    <input type="checkbox" id="tos-checkbox" style="width:18px;height:18px;accent-color:var(--accent);cursor:pointer;flex-shrink:0;margin-top:1px;">
                    <span style="font-size:13px;color:rgba(240,242,248,0.8);line-height:1.5;">I agree to the <strong style="color:var(--accent);cursor:pointer;">Terms of Service</strong> and understand that misrepresenting my age voids all claims and violates the W1NNR platform rules.</span>
                </label>
            </div>

            <!-- Error msg -->
            <div id="age-gate-error" class="error hidden" style="margin-bottom:12px;font-size:13px;"></div>

            <!-- CTA -->
            <button onclick="confirmAge()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--green));color:#000;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;cursor:pointer;transition:.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                ‚úÖ I'M 18+ ‚Äî LET ME COMPETE
            </button>

            <!-- Disclaimer -->
            <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);text-align:center;">
                <p style="font-size:10px;color:var(--muted);line-height:1.6;">By continuing you acknowledge W1NNR is a skill-based competition platform. Void where prohibited. Play responsibly.</p>
                <p style="font-size:10px;color:rgba(107,115,148,0.6);margin-top:4px;">üîí No personal data collected ¬∑ Wallet-only identity</p>
            </div>
        </div>
    </div>
</div>

</body>
</html>
